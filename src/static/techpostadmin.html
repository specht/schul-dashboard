#{require_user_who_can_manage_tablets!}
<div class='container-fluid' style='padding-top: 30px; background-color: #fff;'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style="margin-bottom: 30px;">Technikamt (Admin)</h2>
            <button class='bu-safe btn pull-right' style="color: #fff;"><i class='fa fa-laptop'></i>&nbsp;&nbsp;Super User</button>
            <hr>
            <p>
                Du bist #{(admin_logged_in?) ? 'Admin im Dashboard' : 'Teil des TechnikTeams'} und kannst deshalb hier Probleme mit Geräten aufnehmen und auch <b>schließen</b>. Auch kannst du dich als Tablet anmelden.  
            </p>
            <hr>
            <div class='row'>
                <div class='col-md-7'>
                    <div class="form-group">
                        <label>Problem</label>
                        <input type="text" class="form-control" placeholder="z.B. Das Gerät gibt kein Bild aus, wenn ..." id='tp_problem_description' />
                    </div>
                </div>
                <div class='col-md-3'>
                    <div class="form-group">
                        <label>Gerät</label>
                        <input type="text" class="form-control" placeholder="z.B. Computer 2 / C2 ..." id='tp_problem_device' />
                    </div>
                </div>
                <div class='col-md-2'>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" class="form-control" id='tp_date' value='#{Date.today.to_s}' />
                    </div>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <div class="pull-right">
                        <button id='tp_report_problem_quiet' class='btn btn-outline-secondary' disabled><i class='fa fa-bell-slash '></i>&nbsp;&nbsp;Stumm Absenden (Für Testzwecke)</button>
                        <button id='tp_report_problem' class='btn btn-success' disabled><i class='fa fa-send'></i>&nbsp;&nbsp;Absenden</button>
                    </div>
                </div>
            </div>
            <div class='row'>                
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th style="width: 140px;">Behoben</th>
                    <th style="width: 140px;">Nicht Behoben</th>
                    <th style="width: 140px;">Kommentar</th>
                    <th style="width: 140px;">Technikamt</th>
                    <th style="width: 140px;">TechnikTeam</th>
                    <th style="width: 140px;">Löschen</th>
                    </tr></thead>
                    <tbody id='problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button class='bu-fixed-problems btn btn-primary'><i class='fa fa-eye'></i>&nbsp;&nbsp;Ausgeblendete Probleme</button>
                    <button class='bu-tablets btn btn-warning'><i class='fa fa-tablet'></i>&nbsp;&nbsp;Tablets</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeFixed" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Ausgeblendete Probleme</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th style="width: 140px;">Kommentar</th>
                    <th style="width: 140px;">Technikamt</th>
                    <th style="width: 140px;">TechnikTeam</th>
                    <th style="width: 140px;">Löschen</th>
                    </tr></thead>
                    <tbody id='fixed_problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeTablets" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Tablets</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    #{print_tablet_login()}
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeSuperUser" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Super User</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    #{print_techpost_superuser()}
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<script>

    function compose_fixed_problems() {
        $('#composeFixed').modal('show');
        refresh_fixed_tech_problems();
    }

    function compose_tablets() {
        $('#composeTablets').modal('show');
    }

    function compose_SuperUser() {
        $('#composeSuperUser').modal('show');
    }

    function compose_clear_all() {
        showTemplateModal('Alle Probleme löschen', 
            'Bist Du sicher? Dabei werden alle Probleme gelöscht.<br>Tu dies nur nach Absprache mit dem TechnikTeam und allen Usern die Zugriff auf diese Funktion haben.<br>Das TechnikTeam wird per E-Mail darüber informiert.',
            "<i class='fa fa-trash'></i>&nbsp;&nbsp;Ich bin mir sicher (Alles löschen)", 'btn-danger',
            'Abbrechen', 'btn-secondary', function() {
                api_call('/api/clear_all_tech_problems_admin', {}, function(data) {
                    if (data.success)
                        refresh_tech_problems();
                        refresh_fixed_tech_problems();
                });
            }
        );
    }

    function update_submit_button() {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        $('#tp_report_problem').prop('disabled', !(problem.length > 0 && device.length > 0));
        $('#tp_report_problem_quiet').prop('disabled', !(problem.length > 0 && device.length > 0));
    }

    function refresh_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                $('#problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == false && entry.problem.not_fixed == false && entry.problem.hidden_admin == false) { 
                        let row = $('<tr>');
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        if (entry.klasse) {
                            row.append($('<td title="Schüler">').text(entry.klasse));
                        } else {
                            row.append($('<td title="Lehrer">').html('<i class="fa fa-users"></i>'));
                        }
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));

                        let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Behoben");
                        tp_fixed.data('token', entry.problem.token);
                        tp_fixed.click(function(e) {

                            api_call('/api/fix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                            });

                        });

                        let tp_not_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-warning').html("<i class='fa fa-times'></i>&nbsp;&nbsp;Nicht Behoben");
                        tp_not_fixed.data('token', entry.problem.token);
                        tp_not_fixed.click(function(e) {

                            api_call('/api/not_fix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                            });

                        });
                        row.append($('<td>').append(tp_fixed));
                        row.append($('<td>').append(tp_not_fixed));
                        
                        let tp_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-plus'></i>&nbsp;&nbsp;Kommentar");
                        tp_comment.data('token', entry.problem.token);
                        tp_comment.click(function(e) {
                            let token = entry.problem.token
                            showTemplateModal('Kommentar hinzufügen', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_update_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-pencil'></i>");
                        tp_update_comment.data('token', entry.problem.token);
                        tp_update_comment.click(function(e) {
                            let token = entry.problem.token
                            let old_comment = entry.problem.comment
                            showTemplateModal('Kommentar aktualisieren', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });
                        

                        if (entry.problem.comment == false) {
                            row.append($('<td>').append(tp_comment));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment + ' ').append(tp_update_comment));
                        }


                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            refresh_fixed_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_hide_admin = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-info').html("<i class='fa fa-eye'></i>");
                        tp_hide_admin.data('token', entry.problem.token);
                        tp_hide_admin.click(function(e) {
                            if (entry.problem.comment != "") {
                                let token = $(this).data('token');
                                api_call('/api/hide_tech_problem_admin', {token: token}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                });
                            } else {
                                showTemplateModal('Ausblenden nicht möglich',
                                'Bitte reagiere erst auf diese Meldung, indem du einen Kommentar schreibst und/oder das Problem als „behoben“ oder „nicht behoben“ markierst.',
                                '','',
                                'Schließen', 'btn-secondary'
                                )
                            }
                                                        

                        });
                        let fixer = entry.fnc_login ? $('<button title="' + entry.fdisplay_name + ' kümmert sich um das Problem.">').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.fnc_login + "/256}' class='icon avatar-md'/>") : $('<button title="Ich kümmere mich darum">').addClass('btn btn-xs btn-warning').html("<i class='fa fa-user-plus'></i>");
                        if (entry.fnc_login) {    
                            fixer.data('token', entry.problem.token);
                            fixer.click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/i_will_not_fix_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                        } else {
                            fixer.data('token', entry.problem.token)
                            fixer.click(function(e) {
                                let token = $(this).data('token');
                                api_call('/api/i_will_fix_tech_problem', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_tech_problems();
                                });
                            });
                        
                        }
                        let tp_mail_count = entry.problem.mail_count

                        let tp_mail = $('<button>')
                            .addClass('btn btn-xs btn-success')
                            .html("<i class='fa fa-envelope'></i>&nbsp;&nbsp;(" + tp_mail_count + ")")
                            .data('token', entry.problem.token)
                            .click(function(e) {
                                let token = $(this).data('token');
                                api_call('/api/mail_tech_problem', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_tech_problems();
                                });
                            });

                        if (entry.problem.hidden == false) {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-info')
                                .html("<i class='fa fa-eye'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                        } else {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-secondary')
                                .html("<i class='fa fa-eye-slash'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                        }
                        row.append($('<td>').append(tp_hide_admin).append('&nbsp;').append(fixer));
                        row.append($('<td>').append(tp_delete));
                        $('#problems_here').append(row);
                    }
                }
            }
        });
    }

    function refresh_fixed_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                refresh_tech_problems();
                $('#fixed_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == true  || entry.problem.not_fixed == true || entry.problem.hidden_admin == true) { 
                        let row = $('<tr>');
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        row.append($('<td>').text(entry.klasse));
                        if (entry.problem.not_fixed == true) {
                            row.append($('<td>').addClass('text-danger').text(entry.problem.problem));
                        } else if (entry.problem.fixed == true) {
                            row.append($('<td>').addClass('text-success').text(entry.problem.problem));
                        } else {
                            row.append($('<td>').text(entry.problem.problem));
                        }
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));

                        // let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-warning').html("<i class='fa fa-times'></i>&nbsp;&nbsp;In Bearbeitung");
                        // tp_fixed.data('token', entry.problem.token);
                        // tp_fixed.click(function(e) {

                        //     api_call('/api/unfix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                        //         if (data.success)
                        //             refresh_fixed_tech_problems();
                        //             refresh_tech_problems();
                        //     });

                        // });
                        // row.append($('<td>').append(tp_fixed));

                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-plus'></i>&nbsp;&nbsp;Kommentar");
                        tp_comment.data('token', entry.problem.token);
                        tp_comment.click(function(e) {
                            let token = entry.problem.token
                            showTemplateModal('Kommentar hinzufügen', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_update_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-pencil'></i>");
                        tp_update_comment.data('token', entry.problem.token);
                        tp_update_comment.click(function(e) {
                            let token = entry.problem.token
                            let old_comment = entry.problem.comment
                            showTemplateModal('Kommentar aktualisieren', 
                                '<div class="alert alert-warning">Falls das Problem nicht als „behoben“ oder „nicht behoben“ markiert ist, kannst du den Kommentar erst, nachdem du das Problem für das TechnikTeam wieder eingeblendet hast löschen.</div><textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    if (comment != "" || entry.problem.fixed || entry.problem.not_fixed) {
                                        api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                            if (data.success)
                                                refresh_fixed_tech_problems();
                                        });
                                    } else {
                                        // refresh_fixed_tech_problems();
                                        // showTemplateModal('Blende das Problem zuerst wieder ein',
                                        // 'Da das Problem nach dem Löschen des Kommentars unbeantwortet wäre musst du es erst wieder einblenden, um den Kommentar zu löschen.',
                                        // '','',
                                        // 'Schließen', 'btn-secondary'
                                        // )
                                        console.log("Test")
                                    }
                                }
                            );
                        });

                        if (entry.problem.comment == false) {
                            row.append($('<td>').append(tp_comment));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment + ' ').append(tp_update_comment));
                        }

                        let tp_hide_admin = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-secondary').html("<i class='fa fa-eye-slash'></i>");
                        tp_hide_admin.data('token', entry.problem.token);
                        tp_hide_admin.click(function(e) {
                            let token = $(this).data('token');
                            api_call('/api/unhide_tech_problem_admin', {token: token}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                    refresh_fixed_tech_problems();
                            });
                        });

                        let tp_mail_count = entry.problem.mail_count

                        let tp_mail = $('<button>')
                            .addClass('btn btn-xs btn-success')
                            .html("<i class='fa fa-envelope'></i>&nbsp;(" + tp_mail_count + ")")
                            .data('token', entry.problem.token)
                            .click(function(e) {
                                let token = $(this).data('token');
                                api_call('/api/mail_tech_problem', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_fixed_tech_problems();
                                });
                            });

                        if (entry.problem.hidden == false) {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-info')
                                .html("<i class='fa fa-eye'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        } else {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-secondary')
                                .html("<i class='fa fa-eye-slash'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        }
                        row.append($('<td>').append(tp_delete));
                        $('#fixed_problems_here').append(row);
                    }
                }
            }
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    update_submit_button();
    $('#tp_problem_description').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_descriptione').change(function(e) { update_submit_button(); });
    $('#tp_date').change(function(e) { update_submit_button(); });
    $('#tp_problem_device').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_device').change(function(e) { update_submit_button(); });
    $('#tp_report_problem').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            $('#tp_problem_device').val("");
            update_submit_button();
            refresh_tech_problems();
        });
    });
    $('#tp_report_problem_quiet').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem_quiet', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            $('#tp_problem_device').val("");
            update_submit_button();
            refresh_tech_problems();
        });
    });
    refresh_tech_problems();
    $('.bu-fixed-problems').click(function(e) {
        compose_fixed_problems();
    });

    $('.bu-tablets').click(function(e) {
        compose_tablets();
    });

    $('.bu-safe').click(function(e) {
        compose_SuperUser();
    });

    $('.bu-clear-all').click(function(e) {
        compose_clear_all();
    });

    $('.btn-purge-session').click(function (e) {
        let scrambled_sid = $(e.target).data('scrambled-sid');
        let email = $(e.target).data('email');
        api_call('/api/purge_session_for_user', { email: email, scrambled_sid: scrambled_sid }, function (data) {
            if (data.success) {
                $(e.target).closest('tr').remove();
            }
        });
    });
    $('.bu_login_teacher_tablet').click(function (e) {
        api_call('/api/login_as_teacher_tablet', {}, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.bu_login_kurs_tablet').click(function (e) {
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        let shorthands = [];
        for (let button of selected_buttons) {
            shorthands.push($(button).data('shorthand'));
        }
        api_call('/api/login_as_kurs_tablet', { shorthands: shorthands }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.btn-teacher-for-kurs-tablet-login').click(function (e) {
        let button = $(e.target);
        button.toggleClass('selected');
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        $('.bu_login_kurs_tablet').attr('disabled', selected_buttons.length === 0);
    });
    $('.btn-tablet-login').click(function (e) {
        api_call('/api/login_as_tablet', { id: `${$(e.target).data('id')}` }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    })
</script>

<script>
    var recipients = {};
    var recipients_cache = {};
    var autocomplete_results = {};
    var klasse_for_sus = #{ klasse_for_sus().to_json};
    var old_end_date = null;
    var old_mode = null;
    var observer = null;
    var sent_messages = #{ sent_messages.to_json };
    var antikenfahrt_recipients = #{@@antikenfahrt_recipients.to_json };
    var message_cache = {};
    var force_close = false;
    var current_salzh_entries = #{ get_current_salzh_sus.to_json };
    var voluntary_testing_entries = #{ get_voluntary_testing_sus.to_json };
    var klassen_tr = #{ KLASSEN_TR.to_json };

    function update_buttons() {
        if (can_send())
            $('#bu_send_message').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
        else
            $('#bu_send_message').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
    }

    function can_send() {
        let email = $('#ti_email').data('email');
        return email != null ;
    }
    
    function send_message() {
        let email = $('#ti_email').data('email');
        api_call('/api/add_techpost', { email: email}, function (data) {
        });
    }

    function gen_recipient_span(key, with_rm) {
        if (!(key in recipients))
            recipients[key] = { label: key };
        let label = recipients[key].label;
        if (recipients[key].entries)
            label += ' (' + recipients[key].entries.length + ')';
        if (key in klasse_for_sus)
            label += ` (${klasse_for_sus[key]})`;
        let recipient = $('<span>').addClass('recipient').html(label);
        if (recipients[key].teacher)
            recipient.addClass('teacher');
        recipient.data('key', key);
        return recipient;
    }

    function add_recipient(key) {
        $('#ti_email').val(gen_recipient_span(key, true).text());
        $('#ti_email').data('email', key);
        $('.recipients_list').empty().append(gen_recipient_span(key, true));
        $('.recipient-input-dropdown').hide();
        $('#ti_recipients').val('');
        $('#ti_recipients').focus();
        update_buttons();
    }

    function observer_callback(entries, observer) {
        for (let entry of entries) {
            if (entry.intersectionRatio === 0)
                continue;
            observer.unobserve(entry.target);
            let entry_data = $(entry.target).data();
            if (entry_data.mid) {
                (function (entry_data) {
                    let request = new XMLHttpRequest();
                    let uri = '/gen/m/' + entry_data.mid.substr(0, 2) + '/' + entry_data.mid.substr(2, entry_data.mid.length - 2) + '.html.gz';
                    request.open('GET', uri, true);
                    request.responseType = 'arraybuffer';

                    request.onload = function (e) {
                        if (e.target.status === 200) {
                            let data = pako.ungzip(request.response);
                            let bb = new Blob([new Uint8Array(data)]);
                            let f = new FileReader();
                            f.onload = function (e) {
                                let contents = e.target.result;
                                message_cache[entry_data.mid] = contents;
                                if (entry_data.strip)
                                    $(entry_data.msg_div).html($(contents).text());
                                else
                                    $(entry_data.msg_div).html(contents);
                            };
                            f.readAsText(bb);
                        }
                    };
                    request.send();
                })(entry_data);
            }
        }
    }

    function compact_address_list(emails) {
        let result = [];
        for (let key of recipients_cache.groups) {
            let all_in = true;
            for (let email of recipients[key].entries) {
                if (emails.indexOf(email) < 0) {
                    all_in = false;
                    break;
                }
            }
            if (all_in) {
                result.push(key);
                let new_emails = [];
                for (let email of emails)
                    if (recipients[key].entries.indexOf(email) < 0)
                        new_emails.push(email);
                emails = new_emails;
            }
        }
        for (let email of emails)
            result.push(email);
        return result;
    }

    document.addEventListener('DOMContentLoaded', function () {
        observer = new IntersectionObserver(observer_callback, {
            rootMargin: '100px',
            threshold: 1.0
        });
        $('#ti_recipients').keyup(function(e) { update_buttons(); });
        $('#ti_recipients').change(function(e) { update_buttons(); });

        $('#bu_send_message').click(function (e) {
            send_message();
        });

        $('#ti_recipients').keydown(function (e) {
            if ((e.keyCode === 9 || e.keyCode === 13) && ($(e.target).val().length > 0)) {
                if (Object.keys(autocomplete_results).length === 1) {
                    let key = recipients_cache.keys[Object.keys(autocomplete_results)[0]];
                    add_recipient(key);
                }
                e.preventDefault();
                e.stopPropagation();
                return;
            }
        });
        $('#ti_recipients').keyup(function (e) {
            if ($('#ti_recipients')[0].selectionStart == $(e.target).val().length) {
                let value = $(e.target).val();
                let backspace_pressed = (e.keyCode === 8);
                let space_at_end = value[value.length - 1] == ' ';
                let search_terms = value.trim().toLowerCase().split(/\s+/);
                let results = {};
                for (let i = 0; i < search_terms.length; i++) {
                    let term = search_terms[i];
                    let term_results = {};
                    for (let key of Object.keys(recipients_cache.index[term] || {})) {
                        term_results[key] = recipients_cache.index[term][key];
                    }
                    if (i == 0)
                        results = term_results;
                    else {
                        for (let k of Object.keys(results)) {
                            if (k in term_results) {
                                if (term_results[k] > results[k])
                                    results[k] = term_results[k];
                            } else {
                                delete results[k];
                            }
                        }
                    }
                }
                autocomplete_results = results;
                result_keys = Object.keys(results).map(function (x) { return parseInt(x); });
                if (result_keys.length === 0)
                    $('.recipient-input-dropdown').hide();
                else {
                    if (result_keys.length === 1) {
                        if (!backspace_pressed) {
                            let key = recipients_cache.keys[result_keys[0]];
                            let label = recipients[key].label;
                            $('#ti_recipients').val(label);
                            $('#ti_recipients')[0].setSelectionRange(results[result_keys[0]] + (space_at_end ? 1 : 0), label.length);
                        }
                    }
                    result_keys.sort(function (a, b) {
                        let va = recipients[recipients_cache.keys[a]];
                        let vb = recipients[recipients_cache.keys[b]];
                        if (va.teacher === vb.teacher) {
                            if (va.label < vb.label)
                                return -1;
                            return 1;
                        } else {
                            if (va.teacher)
                                return -1;
                            return 1;
                        }
                    });
                    $('.recipient-input-dropdown').empty();
                    for (let key of result_keys) {
                        let k = recipients_cache.keys[key];
                        let r = gen_recipient_span(k);
                        r.click(function (e) {
                            add_recipient($(e.target).data('key'));
                        });
                        $('.recipient-input-dropdown').append(r);
                    }
                    $('.recipient-input-dropdown').show();
                }
            }
        });
        if ('#{teacher_or_sv_logged_in?}' === 'true') {
            load_recipients('#{@session_user[:id]}', function () {
                // console.log(recipients);
            }, null, true);
        }
        });
</script>
