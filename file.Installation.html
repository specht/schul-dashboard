<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: Installation
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Installation";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: Installation</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="installation">Installation</h1>

<p>Systemvoraussetzungen: </p>

<ul>
<li>ruby</li>
<li>docker</li>
<li>docker-compose</li>
</ul>

<p>Bevor das Dashboard gestartet werden kann, muss es konfiguriert werden.</p>

<ul>
<li><code>env.template.rb</code> als <code>env.rb</code> speichern und Werte anpassen</li>
<li><code>src/ruby/credentials.template.rb</code> als <code>src/ruby/credentials.rb</code> speichern und Werte anpassen</li>
</ul>

<p>Es reicht für einen ersten Test, die Dateien so zu lassen, wie sie sind, also</p>

<pre class="code ruby"><code class="ruby">$ cp env.template.rb env.rb
$ cp src/ruby/credentials.template.rb src/ruby/credentials.rb 
</code></pre>

<p>Das Skript <code>config.rb</code> ist ein Wrapper um <code>docker-compose</code>, der <code>docker-compose.yaml</code> erzeugt und dann <code>docker-compose</code> mit den angegebenen Argumenten aufruft.</p>

<h2 id="bauen-der-docker-images">Bauen der Docker-Images</h2>

<pre class="code ruby"><code class="ruby">$ ./config.rb build
</code></pre>

<h2 id="start-des-systems">Start des Systems</h2>

<pre class="code ruby"><code class="ruby">$ ./config.rb up
</code></pre>

<p>Das kann man zwar auch gleich mit der Option <code>-d</code> starten, aber so werden in der Entwicklungs-/Test-Phase die notwendigen Codes für die Anmeldung an der Konsole angezeigt und müssen nicht umständlich aus dem Log gesucht werden.</p>

<p>Nun können folgende Seiten aufgerufen werden:</p>

<ul>
<li>Dashboard: <a href="http://localhost:8025">http://localhost:8025</a></li>
<li>Neo4j: <a href="http://localhost:8021">http://localhost:8021</a></li>
<li>Nextcloud-Sandbox: <a href="http://localhost:8024">http://localhost:8024</a></li>
</ul>

<p>Da es in den mitgelieferten Beispieldaten schon einen Lehrer gibt, kann man sich nun im Dashboard (<a href="http://localhost:8025">http://localhost:8025</a>) anmelden als <code>clarke@beispielschule.de</code>. Da standardmäßig kein E-Mail-Server konfiguriert ist, muss man den Zahlencode aus den Logs holen:</p>

<pre class="code ruby"><code class="ruby">ruby_1            | !!!!! clarke@beispielschule.de =&gt; 224529 !!!!!
ruby_1            | Cannot send e-mail in DEVELOPMENT mode, continuing anyway:
ruby_1            | getaddrinfo: Name does not resolve
</code></pre>

<h2 id="schreiben-der-stundenpl-ne">Schreiben der Stundenpläne</h2>

<p>Der Stundenplan ist momentan noch leer und muss einfach mit folgendem Befehl befüllt werden:</p>

<pre class="code ruby"><code class="ruby">$ cd src/scripts
$ ./update-timetables.rb
</code></pre>

<p>In den Logs kann man beobachten, wie die Stundenpläne geschrieben werden:</p>

<pre class="code ruby"><code class="ruby">timetable_1       | Fetched 0 updated lesson events, 0 updated text comments, 0 updated audio comments, 0 updated messages and 0 updated events.
timetable_1       | Updating weeks: 
timetable_1       | ...........................................................
timetable_1       | &lt;&lt;&lt; Finished updating all in 0.47 seconds, wrote 531 files.
timetable_1       | -----------------------------------------------------------
</code></pre>

<p>Dabei wird für jeden Nutzer und jede Woche eine Datei geschrieben, die der Browser später lädt, um die aktuellen Daten anzuzeigen.</p>

<p>Die Stundenpläne der betroffenen Teilnehmer werden im späteren Verlauf jedesmal, wenn Informationen zu einer Unterrichtsstunde verändert werden, neu geschrieben.</p>

<h2 id="starten-der-nextcloud-sandbox">Starten der Nextcloud-Sandbox</h2>

<p>Standardmäßig wird eine kleine Nextcloud-Sandbox mitgeliefert, die nicht für den Produktiveinsatz gedacht ist. Sie lässt sich aber gut dafür verwenden, um die Verknüpfung zwischen Dashboard und Nextcloud auszuprobieren. Dazu muss zunächst die Installation der Nextcloud-Sandbox abgeschlossen werden:</p>

<pre class="code ruby"><code class="ruby">$ ./install-nextcloud-sandbox.rb 
Installing user_external app in Sandbox Nextcloud...
user_external 1.0.0 installed
user_external enabled
Activating HTTP Basic Authentication Fallback for Sandbox Nextcloud...
</code></pre>

<p>Es wurde nun HTTP-Basic-Authentication aktiviert. Dies wird später vorübergehend benötigt, wenn das Dashboard die individuellen Nextcloud-Ordner an die einzelnen Nutzer:innen freigibt.</p>

<p>Die Anbindung an Nextcloud erfolgt in drei Schritten:</p>

<h3 id="erstellen-der-nextcloud-nutzer">Erstellen der Nextcloud-Nutzer</h3>

<pre class="code ruby"><code class="ruby">$ cd src/scripts
$ ./create-nc-users.rb
</code></pre>

<p><strong>Bitte die &quot;Notice&quot; in der Ausgabe beachten</strong>: Das Log zeigt erstmal 
nur, welche Änderungen das Skript ausführen möchte. Um diese Änderungen 
tatsächlich durchzuführen, muss es wie folgt gestartet werden:</p>

<pre class="code ruby"><code class="ruby">$  ./create-nc-users.rb --srsly
</code></pre>

<p>Das Skript kann jederzeit erneut gestartet werden, wenn Nutzer dazukommen.</p>

<h3 id="erstellen-der-nextcloud-ordner">Erstellen der Nextcloud-Ordner</h3>

<pre class="code ruby"><code class="ruby">$ ./create-nc-folders.rb
</code></pre>

<p><strong>Hinweis</strong>: Wer an dieser Stelle einen Fehler <code>the input device is not a TTY</code> bekommt,
kann ihn mit <code>export COMPOSE_INTERACTIVE_NO_CLI=1</code> beheben.</p>

<p><strong>Bitte auch hier den Hinweis in der Ausgabe beachten</strong>: Auch diese 
Befehle wurden nicht direkt ausgeführt, können aber in der Testumgebung 
an den Docker-Container übergeben werden:</p>

<pre class="code ruby"><code class="ruby">$ ./create-nc-folders.rb | docker exec -i schuldashboarddev_nextcloud_1 bash -
</code></pre>

<p>Im Ergebnis sieht man, dass unterhalb eines Ordners <code>Unterricht</code> verschiedene Ordner für für die Klassen/Kurse, Fächer und Schüler angelegt wurden.</p>

<pre class="code ruby"><code class="ruby">mkdir: created directory &#39;/var/www/html/data/dashboard/files/Unterricht/Nawi~6a/SuS/Max Mustermann/Einsammelordner&#39;
mkdir: created directory &#39;/var/www/html/data/dashboard/files/Unterricht/Nawi~6a/SuS/Max Mustermann/Einsammelordner/Eingesammelt&#39;
mkdir: created directory &#39;/var/www/html/data/dashboard/files/Unterricht/Nawi~6a/SuS/Max Mustermann/R&#39;$&#39;\303\274&#39;&#39;ckgabeordner&#39;
Starting scan for user 1 out of 1 (dashboard)
+---------+-------+--------------+
| Folders | Files | Elapsed time |
+---------+-------+--------------+
| 53      | 17    | 00:00:02     |
+---------+-------+--------------+
</code></pre>

<p>Das Skript kann jederzeit erneut gestartet werden, wenn Fächer dazukommen.</p>

<h3 id="teilen-der-nextcloud-ordner">Teilen der Nextcloud-Ordner</h3>

<pre class="code ruby"><code class="ruby">$ ./share-nc-folders.rb
</code></pre>

<p>Das Skript kann jederzeit erneut gestartet werden, wenn sich die Zuordnung von Fächern zu Lehrern oder Schülern verändert.</p>

<p>Für dieses Skript wird die App »user_external« in Nextcloud benötigt, da sich das Skript als der jeweilige Nutzer anmelden muss, um einen geteilten Ordner ins richtige Verzeichnis zu verschieben. Damit das in der Nextcloud-Sandbox funktioniert, haben wir weiter oben das Skript <code>install-nextcloud-sandbox.rb</code> ausgeführt. <strong>Achtung:</strong> Solange diese App aktiviert ist und die Nextcloud so konfiguriert ist, dass diese App auch verwendet wird, gibt es ein Blanko-Passwort, mit jeder in jeden Account kommt: <code>NEXTCLOUD_ALL_ACCESS_PASSWORD_BE_CAREFUL</code>.</p>
</div></div>

      <div id="footer">
  Generated on Thu Feb 11 00:45:57 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.5.1).
</div>

    </div>
  </body>
</html>