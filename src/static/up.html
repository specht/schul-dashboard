#{require_user_with_role!(:unterstufenparty)}
<style>
    .video-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 86 / 54;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }

    video, canvas {
        max-width: 100%;
        border-radius: 8px;
    }

    #video,
    #cardPreview {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* border: 2px solid #555; */
        border-radius: 8px;
    }

    #video { display: block; }
    #cardPreview { display: none; }

    #status { margin-top: 0.5rem; font-weight: bold; }

    .video-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
    }

    .target-frame {
        aspect-ratio: 86 / 54;
        width: 85%;
        max-height: 85%;
        border: 2px dashed rgba(255,255,255,0.9);
        border-radius: 10px;
        box-shadow:
            0 0 0 1px rgba(0,0,0,0.4),
            0 0 12px rgba(0,0,0,0.6);
    }

    .target-frame.ready { display: none; }

</style>

<div class="container" style="padding-top: 15px;">
    <div class="row">
        <div class="col-md-12">
            <div class="input-group mb-3">
                <input id='ti_sus' type="text" list="people" class="form-control form-control-lg" placeholder="Suchen oder QR-Code scannen">
                <div class="input-group-append">
                    <button class="btn btn-lg btn-success" type="button" id="scanQrBtn"><i class='fa fa-qrcode'></i></button>
                </div>
            </div>
            <datalist id="people">
            </datalist>

            <div class="video-wrapper mb-3">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="cardPreview" width="1024" height="640"></canvas>
                <div class="video-overlay"><div class="target-frame ready"></div></div>
            </div>

            <div class="d-flex" style="margin-top: 1em;">
                <button id="scanCardBtn" class="btn btn-lg btn-success flex-fill mr-1"><i class='fa fa-id-card-o'></i>&nbsp;&nbsp;Rückseite scannen</button>
                <button id="scanResetBtn" class="btn btn-lg btn-secondary flex-fill ml-1"><i class='fa fa-times'></i>&nbsp;&nbsp;Reset</button>
            </div>

            <div id="status">Initializing…</div>

            <div class="d-flex" style="margin-top: 1em;">
                <button id='bu_checkin' disabled class="btn btn-lg btn-success flex-fill mr-1"><i class='fa fa-sign-in'></i>&nbsp;&nbsp;Check-in</button>
                <button id='bu_checkout' disabled class="btn btn-lg btn-danger flex-fill ml-1"><i class='fa fa-sign-out'></i>&nbsp;&nbsp;Check-out</button>
            </div>
            <hr>
            <div id="checked_in_sus_here"></div>
        </div>
    </div>
</div>

<script src="/include/opencv/opencv.js"></script>
<script>
    var is_safari = false;
</script>
<script type="module">
    import { CardScanner } from "./include/card-scanner.js?#{Time.now.to_i}";
    import { QrScanner } from "./include/qr-scanner.js?#{Time.now.to_i}";
    let sound = new SoundPlayer();

    const videoEl = document.getElementById("video");
    const cardPreview = document.getElementById("cardPreview");
    const statusEl = document.getElementById("status");
    const targetFrame = document.querySelector(".target-frame");

    const up_sus_list = #{up_sus_list.to_json};
    let up_sus_map = {};
    let up_sus_email_for_code = {};

    let got_email = null;
    let got_card_sha1 = null;
    let got_card_text = null;

    const sorted_sus = [...up_sus_list].sort((a, b) =>
        a.display_name.localeCompare(b.display_name, undefined, { sensitivity: 'base' })
    );
    for (let sus of sorted_sus) {
        up_sus_map[sus.email] = sus;
        up_sus_email_for_code[sus.code] = sus.email;
        let option = $('<option>').attr('value', `${sus.display_name} (${sus.klasse})`).attr('data-email', sus.email);
        $('#people').append(option);
    }

    let mode = null;
    let cardScanner = null;
    let qrScanner = null;

    function showLive() {
        videoEl.style.display = "block";
        cardPreview.style.display = "none";
        targetFrame.style.display = "flex";
    }

    function showCapture() {
        videoEl.style.display = "none";
        cardPreview.style.display = "block";
        targetFrame.style.display = "none";
    }

    function stopAll() {
        if (cardScanner) cardScanner.stop();
        if (qrScanner) qrScanner.stop();
    }

    async function uploadCardCanvas(canvas) {
        // Update status
        statusEl.textContent = "Uploading…";

        // Wrap toBlob in a Promise so we can await it
        const blob = await new Promise((resolve, reject) => {
            canvas.toBlob(
                (b) => b ? resolve(b) : reject(new Error("Canvas toBlob failed")),
                "image/jpeg",
                0.9 // quality 0–1
            );
        });

        const formData = new FormData();
        formData.append("card", blob, "card.jpg");

        console.log(blob);

        // Adjust URL to your backend route
        const response = await fetch("/api/up_upload_image", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            throw new Error("Upload failed: " + response.status);
        }

        const result = await response.json().catch(() => null);

        statusEl.textContent = "Upload finished.";
        return result;
    }


    // --- Card scanner setup ---
    cardScanner = new CardScanner({
        videoEl,
        previewCanvas: cardPreview,
        statusEl,
        sharpnessThreshold: 150,
        scanIntervalMs: 400,
        onGoodCapture: async () => {
            sound.play('snapshot');
            showCapture();
            mode = null;
            let result = await uploadCardCanvas(cardPreview);
            got_card_sha1 = result.sha1;
            got_card_text = null;
            update_status();
        }
    });
    cardScanner.attachTapToFocus();

    // --- QR scanner setup ---
    qrScanner = new QrScanner({
        videoEl,
        previewCanvas: cardPreview,
        statusEl,
        scanIntervalMs: 200,
        onResult: ({ text }) => {
            sound.play('scan');
            statusEl.textContent = "QR: " + text;
            let info = up_sus_map[up_sus_email_for_code[text]];
            $('#ti_sus').val(`${info.display_name} (${info.klasse})`);
            got_email = info.email;
            fetchInfoForEmail();
            update_status();
            // showCapture();
            mode = null;
        }
    });
    qrScanner.attachTapToFocus();

    // --- UI buttons ---
    document.getElementById("scanCardBtn").addEventListener("click", async () => {
        got_card_sha1 = null;
        got_card_text = null;
        update_status();
        stopAll();
        mode = "card";
        showLive();
        await cardScanner.start();
    });

    document.getElementById("scanQrBtn").addEventListener("click", async () => {
        stopAll();
        mode = "qr";
        showLive();
        $('#ti_sus').val('');
        got_email = null;
        got_card_sha1 = null;
        got_card_text = null;
        update_status();
        await qrScanner.start();
    });

    function stopCamera() {
        stopAll();
        mode = null;
        showLive();
        statusEl.textContent = "Stopped.";
    }

    // Reset view only
    document.getElementById("scanResetBtn").addEventListener("click", () => {
        stopCamera();
        $('#ti_sus').val('');
        got_email = null;
        got_card_sha1 = null;
        got_card_text = null;
        update_status();
    });

    const options = document.querySelectorAll('#people option');

    $('#ti_sus')[0].addEventListener('click', () => {
        stopCamera();
        $('#ti_sus').val('');
        got_email = null;
        got_card_sha1 = null;
        got_card_text = null;
        update_status();
    });
    $('#ti_sus')[0].addEventListener('input', () => {
        const opt = Array.from(options).find(o => o.value === $('#ti_sus').val());
        if (opt) {
            got_email = opt.dataset.email;
            got_card_sha1 = null;
            got_card_text = null;
            fetchInfoForEmail();
            update_status();
            $('#ti_sus').blur();

        } else {
            got_email = null;
            got_card_sha1 = null;
            got_card_text = null;
            update_status();
        }
    });

    function fetchInfoForEmail() {
        if (got_email === null)
            return;

        api_call('/api/up_get_info_for_email', { email: got_email }, function(data) {
            if (data.success) {
                if (data.last_card_sha1 !== null) {
                    got_card_sha1 = data.last_card_sha1;
                    showCard(data.last_card_sha1);
                }
            }
        });
    }

    function showCard(sha1) {
        if (sha1 === null)
            return;

        fetch(`/api/up_card_image/${encodeURIComponent(sha1)}`)
            .then(res => { if (!res.ok) throw new Error('Image fetch failed'); return res.blob(); })
            .then(blob => createImageBitmap(blob))
            .then(bitmap => {
                cardPreview.width = bitmap.width;
                cardPreview.height = bitmap.height;
                const ctx = cardPreview.getContext('2d');
                ctx.clearRect(0, 0, cardPreview.width, cardPreview.height);
                ctx.drawImage(bitmap, 0, 0, cardPreview.width, cardPreview.height);
                showCapture();
                statusEl.textContent = "Card image loaded.";
            })
            .catch(err => {
                console.error(err);
                statusEl.textContent = "Failed to load card image.";
            });
    }

    function update_status() {
        if (got_email === null) {
            $('#bu_checkin').attr('disabled', true);
            $('#bu_checkout').attr('disabled', true);
            return;
        }
        api_call('/api/up_get_info_for_email', { email: got_email }, function(data) {
            if (data.success) {
                console.log(data);
                console.log(got_card_sha1, got_card_text);
                let checkin_enabled = (got_card_sha1 !== null || got_card_text !== null);
                let checkout_enabled = (data.last_status === 'checked_in');
                $('#bu_checkin').attr('disabled', !checkin_enabled);
                $('#bu_checkout').attr('disabled', !checkout_enabled);
            } else {
                $('#bu_checkin').attr('disabled', true);
                $('#bu_checkout').attr('disabled', true);
            }
        });
    }

    // Initial state
    showLive();
    statusEl.textContent = "Ready.";

    // Check-in button
    $('#bu_checkin').on('click', function() {
        if (got_email !== null && (got_card_sha1 !== null || got_card_text !== null)) {
            api_call('/api/up_checkin', { email: got_email, card_sha1: got_card_sha1 ?? '', card_text: got_card_text ?? ''}, function(data) {
                if (data.success) {
                    stopCamera();
                    statusEl.textContent = "Check-in successful.";
                    sound.play('success');
                    got_email = null;
                    got_card_sha1 = null;
                    got_card_text = null;
                    $('#ti_sus').val('');
                    update_status();
                    update_checked_in_sus();
                } else {
                    statusEl.textContent = "Check-in failed.";
                    sound.play('error');
                }
            });
        }
    });

    // Check-out button
    $('#bu_checkout').on('click', function() {
        if (got_email !== null) {
            api_call('/api/up_checkout', { email: got_email }, function(data) {
                if (data.success) {
                    stopCamera();
                    statusEl.textContent = "Check-out successful.";
                    sound.play('success');
                    got_email = null;
                    got_card_sha1 = null;
                    got_card_text = null;
                    $('#ti_sus').val('');
                    update_status();
                    update_checked_in_sus();
                } else {
                    statusEl.textContent = "Check-out failed.";
                    sound.play('error');
                }
            });
        }
    });

    function update_checked_in_sus() {
        api_call('/api/up_get_checked_in_sus', {}, function(data) {
            if (data.success) {
                $('#checked_in_sus_here').empty();
                $('#checked_in_sus_here').append($(`<h4>${data.checked_in_sus.length} SuS eingecheckt:</h4>`));
                for (let email of data.checked_in_sus) {
                    let sus = up_sus_map[email];
                    let button = $('<button>')
                        .addClass('btn btn-outline-secondary').text(`${sus.display_name} (${sus.klasse})`);
                    button.on('click', function() {
                        got_email = sus.email;
                        got_card_sha1 = null;
                        got_card_text = null;
                        fetchInfoForEmail();
                        update_status();
                        $('#ti_sus').val(`${sus.display_name} (${sus.klasse})`);
                    });
                    button.appendTo($('#checked_in_sus_here'));
                    $('#checked_in_sus_here').append(' ');

                }
            }
        });
    }

    update_checked_in_sus();
</script>
