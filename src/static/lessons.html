#{this_is_a_page_for_logged_in_teachers}
<style>
body {
    background-image: none;
    background-color: #fff;
}
</style>
<script>
var lesson_key = '#{show_lesson_key}';
var lesson_key_id = '#{lesson_key_id}';
var lesson_data = #{lesson_data.to_json};
var schueler_for_lesson = #{schueler_for_lesson(show_lesson_key).to_json};
var schueler_info_for_email = {};
var schueler_for_lesson_index = {};
var max_recording_time = 5;
var mediaRecorder = null;
var chunks = [];
var pb_button = null;
var audio = null;
var audio_blob = null;
var recording = false;
var playing = false;
var rec_start_time = null;
var rec_duration = 0;
var update_rec_time_label_timeout = null;
var breakout_room_config = null;
var breakout_room_widgets = {};
var single_selected_offset = null;
var stored_breakout_room_config_json = null;
var booked_tablet_sets_config = [];
var stored_booked_tablet_sets_config = JSON.stringify([]);
var tablet_set_info = #{@@tablet_sets.to_json};

</script>

<div class="modal" id="breakoutRoomsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Jitsi-Gruppenräume</h5>
            </div>
            <div class="modal-body">
                <div class='row'>
                    <div class='col-md-3'>
                        <div class="form-group">
                            <label>Gruppenräume bereitstellen</label>
                            <div class='button-with-label'>
                                <button id='ti_event_jitsi_breakout_rooms' data-state='no' class='btn_lesson_data btn btn-outline-secondary'><i class='fa fa-times'></i>Gruppenräume</button>
                            </div>
                        </div>
                    </div>
                    <div class='col-md-3'>
                        <div class="form-group">
                            <label>Anzahl der Gruppenräume</label>
                            <div class="input-group mb-3">
                                <input style='text-align: center;' class='form-control' id='ti_breakout_room_count' min='1' type='number' value='4'></input>
                                <div class="input-group-append">
                                    <button class="btn bu-fewer-breakout-rooms btn-outline-secondary"><i class='fa fa-minus'></i></button>
                                </div>
                                <div class="input-group-append">
                                    <button class="btn bu-more-breakout-rooms btn-outline-secondary"><i class='fa fa-plus'></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='col-md-3'>
                        <div class="form-group">
                            <label>Gruppen einteilen</label>
                            <div class="btn-group" style='width: 100%;'>
                                <button type="button" class="bu-breakout-room-arrange-dropdown btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Einteilen
                                </button>
                                <div class="dropdown-menu">
                                    <a class='dropdown-item bu-breakout-room-arrange-reuse-last btn btn-primary'><i class='fa fa-history'></i>&nbsp;&nbsp;&nbsp;&nbsp;Einteilung vom letzten mal übernehmen</a>
                                    <a class='dropdown-item bu-breakout-room-arrange-random btn btn-primary'><i class='fa fa-random'></i>&nbsp;&nbsp;&nbsp;&nbsp;zufällig mischen</a>
                                    <a class='dropdown-item bu-breakout-room-arrange-sort-first-name btn btn-primary'><i class='fa fa-sort-alpha-asc'></i>&nbsp;&nbsp;&nbsp;&nbsp;nach Vornamen sortieren</a>
                                    <a class='dropdown-item bu-breakout-room-arrange-sort-last-name btn btn-primary'><i class='fa fa-sort-alpha-asc'></i>&nbsp;&nbsp;&nbsp;&nbsp;nach Nachnamen sortieren</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='col-md-3'>
                        <div class="form-group">
                            <label>Freie Raumwahl</label>
                            <div class='button-with-label'>
                                <button id='ti_breakout_rooms_roaming' data-state='no' class='btn_lesson_data btn btn-outline-secondary' title='SuS dürfen beliebig zwischen den Räumen wechseln'><i class='fa fa-times'></i>Freie Raumwahl</button>
                            </div>
                        </div>
                    </div>
                    <div class='col-md-12'>
                        <hr />
                        <p>
                        Ziehen Sie Schülerinnen und Schüler hin und her, um sie in Gruppen einzuteilen.
                        </p>
                    </div>
                </div>
                <div class='row breakout-rooms-container'>
                </div>
            </div>
            <div class="modal-footer">
                <button id='bu_close_breakout_room' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="tabletSetModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Geräte buchen</h5>
            </div>
            <div class="modal-body" style='overflow-x: auto;'>
                <table class='table narrow'>
                    <thead>
                        <tr>
                            <th>Tabletsatz</th>
                            <th>Art</th>
                            <th>Standort</th>
                            <th>Buchung</th>
                        </tr>
                    </thead>
                    <tbody id='available_tablet_sets_here'>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id='bu_close_tablet_set_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="feedbackModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body" style='overflow-x: auto;'>
            <table class='table table-striped narrow schueler_table_table'>
                <thead>
                <tr>
                <th class='th-feedback-nr' style='width: 50px; text-align: right;'>Nr.</th>
                <th class='th-feedback-name'>Name</th>
                <th>Kommentar</th>
                <th class='th-feedback-audiokommentar'>Audiokommentar</th>
                </tr>
                </thead>
                <tbody class='schueler_table'>
                    <tr id='recording_row' style='display: none;'>
                        <td colspan='4'>
                            <div class='container-fluid' style='margin: -30px 0px; padding: 30px 0px;'>
                                <div class='row'>
                                    <div class='col-12'>
                                        <div class='explanation' style='white-space: normal;'>
                                            Hier können Sie einen Kommentar zur Stunde bzw. zur Hausaufgabe hinterlassen. Ein freigegebener Kommentar wird <span class='first_name_here'></span> erst nach fünf Minuten angezeigt, falls Sie sich umentscheiden sollten und einen Kommentar zurückziehen möchten.
                                        </div>
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col-lg-6 col-md-12'>
                                        <div class="form-group">
                                            <label><b>Kommentar für <span class='first_name_here'></span></b></label>
                                            <textarea class="form-control" id='ti_feedback_comment' style='height: 100px; font-family: Roboto;'></textarea>
                                            <div style='position: relative;'>
                                                <div class="btn-group">
                                                    <div id='publish_text_comment_btn_container'>
                                                        <button id='bu_publish_text_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled>Kommentar freigeben</button>
                                                        <button id='bu_discard_text_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled>Verwerfen</button>
                                                    </div>
                                                </div>
                                                <button id='bu_delete_text_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled><i class='fa fa-trash'></i>&#8203;</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class='col-lg-6 col-md-12'>
                                        <div class="form-group">
                                            <label><b>Audiokommentar für <span class='first_name_here'></span></b></label>
                                            <div style='min-height: 100px;'>
                                                <div class="btn-group">
                                                    <button id='bu_record_audio_comment' class='btn btn-danger'><i class='fa fa-microphone'></i>&nbsp;&nbsp;Aufnehmen</button>
                                                    <button id='bu_stop_audio_comment' class='btn btn-outline-secondary' disabled><i class='fa fa-stop'></i></button>
                                                    <button id='bu_play_audio_comment' class='btn btn-outline-secondary' disabled><i class='fa fa-play'></i></button>
                                                </div>
                                                <div id='audio_time' class="progress" style='margin-top: 10px;'>
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%"></div>
                                                </div>
                                                <div class='explanation alert-danger audio_error_warning' style='margin-top: 10px; white-space: normal; display: none;'>
                                                    Die Aufnahme konnte nicht gestartet werden.
                                                </div>
                                                <div class='explanation' style='margin-top: 10px; white-space: normal; font-family: Roboto;'>
                                                    Aufnahmedauer: <span id='duration'>0:00</span> (von max. 5 Minuten)
                                                </div>
                                            </div>
                                            <div style='position: relative;'>
                                                <div class="btn-group">
                                                    <div id='publish_audio_comment_btn_container'>
                                                        <button id='bu_publish_audio_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled>Kommentar freigeben</button>
                                                        <button id='bu_discard_audio_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled>Verwerfen</button>
                                                    </div>
                                                </div>
                                                <button id='bu_delete_audio_comment' class='btn btn-outline-secondary' style='margin-top: 10px;' disabled><i class='fa fa-trash'></i>&#8203;</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
      </div>
      <div class="modal-footer">
        <button id='bu_close_feedback_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="emailListModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">E-Mail-Adressen</h5>
            </div>
            <div class="modal-body" style='overflow-x: auto;'>
                <p><b>Hinweis:</b> Bitte verwenden Sie die Adressen nach Möglichkeit im BCC.</p>
                <textarea style='font-family: monospace; font-size: 90%;' rows='20' class='form-control' readonly></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="amtModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">SuS für Amt auswählen</h5>
            </div>
            <div class="modal-body" style='overflow-x: auto;'>
                <p>Bitte wählen Sie aus, an wen Sie das Amt delegieren möchten:</p>
                <table class='table table-sm table-striped'>
                    <!-- <thead>
                        <tr>
                            <th></th>
                            <th>Name</th>
                            <th></th>
                        </tr>
                    </thead> -->
                    <tbody id='amt_sus_here'></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class='container-fluid solid white' style='padding-top: 30px;'>
    <div class='api_messages overlay'></div>
    <div class='row' style='position: relative;'>
        <div class='col-md-3'>
            <div class='lesson_pane'>
                <p class='status_label'>&nbsp;</p>
                <div class="form-group bu-save-discard-container">
                    <button class='bu-discard-changes btn btn-outline-secondary' style='margin-bottom: 3px;' disabled><i class='fa fa-trash'></i>&nbsp;&nbsp;Verwerfen</button>
                    <button class='bu-save-changes btn btn-outline-secondary' style='margin-bottom: 3px;' disabled ><i class='fa fa-check'></i>&nbsp;&nbsp;Speichern</button>
                    <div class="btn-group bu-umplanen-container" style='position: relative; top: -2px;'>
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle bu-umplanen" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>Umplanen</button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="bu-insert-lesson-above dropdown-item no-max-width" href='#'>Eine Stunde oberhalb einfügen</a>
                            <a class="bu-insert-2-lesson-above dropdown-item no-max-width" href='#'>Doppelstunde oberhalb einfügen</a>
                            <div class='dropdown-divider'></div>
                            <a class="bu-delete-lesson dropdown-item no-max-width" href='#'><span class='delete-lessons-label'>Diese Stunde</span> aus dem Verlauf entfernen</a>
<!--                                <button type="button" class="btn btn-outline-secondary dropdown-toggle bu-umplanen" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>Umplanen</button>
                                <div class="dropdown-menu">
                                    <a class="bu-insert-lesson-above dropdown-item no-max-width" href='#'>Eine Stunde oberhalb einfügen</a>
                                    <a class="bu-delete-lesson dropdown-item no-max-width" href='#'>Diese Stunde aus dem Verlauf entfernen</a>
                                </div>-->
                        </div>
                    </div>
                    <div style='clear: both'></div>
                </div>
                <hr />
                <div class='pane_items'>
                    <div class="form-group">
                        <label><b>Thema</b>* <span class='text-muted'>(für SuS nicht sichtbar)</span></label>
                        <div id='dd_thema' class="float-right dropdown" style='display: none;'>
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                verschiedene Werte
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                            </div>
                        </div>
                        <input type="text" class="form-control input-private" id='ti_thema' disabled />
                    </div>
<!--                     <hr /> -->
                    <div class="form-group">
                        <label><b>Stundenthema</b> <span class='text-muted'>(für SuS sichtbar)</span></label>
                        <div id='dd_stundenthema_text' class="float-right dropdown" style='display: none;'>
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                verschiedene Werte
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                            </div>
                        </div>
                        <div class='explanation' style='margin-top: 5px; white-space: normal;'>
                            Hier können Sie Schülerinnen und Schülern, die nicht an der Stunde teilnehmen können, mitteilen, was in der Stunde behandelt wird oder Arbeitsanweisungen geben. Dieses Feld ist für alle Schülerinnen und Schüler sichtbar (allerdings immer nur für eine Woche im voraus).
                        </div>
                        <textarea id='ti_stundenthema_text' style='height: 100px; margin-bottom: 15px;' class="form-control" disabled></textarea>
                        <div class='button-with-label'>
                            <button id='ti_lesson_fixed' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;fester Termin</button>
                            <span>Sie bekommen eine E-Mail, falls sich die Stunde verschiebt.</span>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label><b>Durchführung</b> <span class='text-muted'>(für SuS sichtbar)</span></label>
                        <div class='button-with-label'>
                            <button id='ti_lesson_jitsi' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Jitsi Meet</button>
                            <span>Für diese Stunde wird ein Jitsi Meet-Stream bereitgestellt.</span>
                        </div>
                        <div class='button-with-label'>
                            <button id='ti_lesson_jitsi_breakout_rooms_popup' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Gruppenräume</button>
                            <span>Für diese Stunde werden Jitsi-Gruppenräume bereitgestellt.</span>
                        </div>
                        <!-- <div class='button-with-label'>
                            <button id='ti_lesson_need_tablet' data-state='off' class='btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Tablet</button>
                            <span>Ich benötige ein Tablet, um für die komplette saLzH-Klasse aus der Schule zu streamen.</span>
                        </div>
                        <div class='explanation tablet-booking-status' style='margin-top: 5px; white-space: normal;'>
                        </div> -->
                        <div class='button-with-label'>
                            <button id='ti_lesson_need_tablet_set' data-state='off' class='btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Geräte</button>
                            <span>Ich benötige einen Tabletsatz oder andere Geräte für meine Unterrichtsstunde.</span>
                        </div>
                        <div class='explanation tablet-set-booking-status' style='margin-top: 5px; white-space: normal;'>
                        </div>
                        <hr style='margin: 5px 0 10px 0;' />
                        <div class='button-with-label'>
                            <button id='ti_lesson_nc' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Nextcloud</button>
                            <span>Es befinden sich Aufgaben im Nextcloud-Ordner. Der Link zum Ordner wird automatisch bereitgestellt.</span>
                        </div>
                        <div class='button-with-label'>
                            <button id='ti_lesson_lr' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Lernraum</button>
                            <span>Es befinden sich Aufgaben im Lernraum.</span>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label><b>Hausaufgaben</b> (zu heute) <span class='text-muted'>(für SuS sichtbar)</span></label>
                        <div id='dd_hausaufgaben_text' class="float-right dropdown" style='display: none;'>
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                verschiedene Werte
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                            </div>
                        </div>
                        <textarea id='ti_hausaufgaben_text' style='height: 100px; margin-bottom: 15px;' class="form-control" disabled></textarea>
                        <label><b>Eintrag des Hausaufgabenamts</b> (zu heute)</label>
                        <div id='dd_ha_amt_text' class="float-right dropdown" style='display: none;'>
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                verschiedene Werte
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                            </div>
                        </div>
                        <textarea id='ti_ha_amt_text' style='height: 60px; margin-bottom: 15px;' class="form-control" disabled></textarea>
                        <div class='button-with-label'>
                            <input type='number' id='ti_homework_est_time' class='form-control' style='height: 32px; text-align: center;'/>
                            <span>Geplanter Zeitaufwand (in Minuten)</span>
                        </div>
                        <div class='button-with-label'>
                            <button id='ti_homework_nc' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Nextcloud</button>
                            <span>Es befinden sich Hausaufgaben im Nextcloud-Ordner.</span>
                        </div>
                        <div class='button-with-label'>
                            <button id='ti_homework_lr' data-state='off' class='btn_lesson_data btn btn-sm btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;Lernraum</button>
                            <span>Es befinden sich Hausaufgaben im Lernraum.</span>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label><b>Rückmeldung von Schülerinnen und Schülern</b></label>
                        <div class='explanation sus_feedback_label' style='white-space: normal; margin-bottom: 15px;'>
                        </div>
                        <!--
                        <div class='button-with-label'>
                            <button id='bu_sus_feedback' class='btn btn-sm btn-outline-secondary' disabled><i class='fa fa-bar-chart'></i>&nbsp;&nbsp;Ansehen</button>
                            <span>SuS haben die Möglichkeit, Feedback zu Ihrer Hausaufgabe zu geben.</span>
                        </div>
                        <div class='na-on-multi-select explanation alert-warning' style='display: none; padding: 4px 0px; margin: 4px 0; border-top: 1px solid #c4a000; border-bottom: 1px solid #c4a000;'>
                            Diese Funktion steht nicht zur Verfügung, wenn mehrere Stunden ausgewählt sind.
                        </div>
                        -->
                    </div>
                    <hr />
                    <div class="form-group">
                        <label><b>Rückmeldung an Schülerinnen und Schüler</b></label>
                        <div class='button-with-label'>
                            <button id='bu_feedback' class='btn btn-sm btn-outline-secondary' disabled><i class='fa fa-microphone'></i>&nbsp;&nbsp;Feedback</button>
                            <span>Hier können Sie Feedback zur Stunde bzw. zu den Hausaufgaben geben.</span>
                        </div>
                        <div class='na-on-multi-select explanation alert-warning' style='display: none; padding: 4px 0px; margin: 4px 0; border-top: 1px solid #c4a000; border-bottom: 1px solid #c4a000;'>
                            Diese Funktion steht nicht zur Verfügung, wenn mehrere Stunden ausgewählt sind.
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <label><b>Notizen</b>* <span class='text-muted'>(für SuS nicht sichtbar)</span></label>
                        <div id='dd_notizen' class="float-right dropdown" style='display: none;'>
                            <button class="btn btn-warning btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                verschiedene Werte
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                            </div>
                        </div>
                        <textarea id='ti_notizen' style='height: 70px;' class="form-control input-private" disabled></textarea>
                    </div>
                    <hr />
                    <div class="explanation text-muted small">
                    * Diese Einträge sind für Schülerinnen und Schüler nicht sichtbar, können jedoch von vertretenden Kolleginnen und Kollegen eingesehen werden. 
                    </div>
                    <hr />
                </div>
                <label><b>Hausaufgaben- und Materialamt</b></label>
                <br />
                <div class='explanation' style='margin-top: 5px; white-space: normal;'>
                    Hier können Sie SuS für das Hausaufgaben- und/oder Materialamt delegieren.
                    <strong>Hausaufgabenamt:</strong> Diese SuS können Hausaufgaben im Stundenplan eintragen, aber nicht Hausaufgaben bearbeiten oder löschen, die Sie selbst eingetragen haben. Sie haben jedoch die Möglichkeit, die von Schüler:innen vorgenommenen Eintragungen zu bearbeiten oder löschen.
                    <strong>Materialamt:</strong> Diese SuS können Materialien in einen speziellen Nextcloud-Ausgabeordner hochladen. Ihr ursprünglicher Ausgabeordner bleibt unberührt, und Sie haben volle Schreibrechte im Materialamt-Ausgabeordner. Bitte beachten Sie, dass die Änderungen immer erst am folgenden Tag gültig werden.
                </div>
                <div class="pull-right" style='margin-bottom: 0.5em;'>
                    <button type="button" class="btn btn-sm btn-success bu-add-amt" data-amt="hausaufgaben"><i class='fa fa-plus'></i>&nbsp;&nbsp;Hausaufgabenamt</button>
                    <button type="button" class="btn btn-sm btn-success bu-add-amt" data-amt="material"><i class='fa fa-plus'></i>&nbsp;&nbsp;Materialamt</button>
                </div>
                <div style='clear: both;'></div>
                <div id='present_amt_table'>
                    <table class='table table-sm table'>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th style='width: 3em;'>HA</th>
                                <th style='width: 3em;'>MA</th>
                            </tr>
                        </thead>
                        <tbody id='present_amt_rows'>
                        </tbody>
                    </table>
                </div>
                <hr />
                <label><b>Schülerlisten</b> <span class='text-muted'>(für diesen Kurs)</span></label>
                <br />
                <a href='/api/directory_xlsx/#{show_lesson_key}' class='btn btn-sm btn-primary' style='margin: 0 8px 8px 0;'><i class='fa fa-file-excel-o'></i>&nbsp;&nbsp;Excel-Tabelle herunterladen</a>
                <a href='/api/directory_timetex_pdf/by_last_name/#{show_lesson_key}' class='btn btn-sm btn-primary' style='margin: 0 8px 8px 0;'><i class='fa fa-file-pdf-o'></i>&nbsp;&nbsp;Timetex-PDF herunterladen</a>
                <a href='/api/directory_timetex_pdf/by_first_name/#{show_lesson_key}' class='btn btn-sm btn-primary' style='margin: 0 8px 8px 0;'><i class='fa fa-file-pdf-o'></i>&nbsp;&nbsp;Timetex-PDF herunterladen (nach Vornamen sortiert)</a>
                <a id='bu_email_list' href='' style='margin: 0 8px 8px 0;' class='btn btn-sm btn-primary'><i class='fa fa-envelope-o'></i>&nbsp;&nbsp;Liste aller E-Mail-Adressen</a>
                <hr />
                <label><b>Kursbuch</b></label>
                <br />
                <a href='/api/kursbuch_pdf/#{show_lesson_key}' class='btn btn-sm btn-primary' style='margin: 0 8px 8px 0;'><i class='fa fa-file-pdf-o'></i>&nbsp;&nbsp;Kursbuch-PDF herunterladen</a>
            </div>
        </div>
        <div class='col-md-9 lc_table' style='overflow-x: auto;'>
            <table class='table wrapit table-condensed narrow lesson_table_table'>
                <thead>
                <tr>
                <th class='th-nr'>Nr.</th>
                <th class='th-datum'>Datum</th>
                <th class='th-tag'>Tag</th>
                <th class='th-stunde'>St.</th>
                <th class='th-fach'>Fach</th>
                <th>Thema <span style='font-weight: normal;'>(intern)</span></th>
                <th>Stundenthema</th>
                <th class='th-lesson'>Durchführung</th>
                <th>Hausaufgaben (zu heute)</th>
                <th class='th-feedback'>Feedback</th>
                <th>Notizen <span style='font-weight: normal;'>(intern)</th>
                </tr>
                </thead>
                <tbody class='lesson_table'>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
var row_for_lesson_offset = {};
var cursor = null;
var force_pending_changes = false;
var pending_changes = false;
var data_keys = ['thema', 'notizen', 'hausaufgaben_text', 'ha_amt_text', 'stundenthema_text', 'homework_est_time'];
var data_keys_bools = ['lesson_jitsi', 'lesson_nc', 'lesson_lr', 'homework_nc', 'homework_lr', 'lesson_fixed'];
var can_select = false;

function sanitize_breakout_room_config(config) {
    config = JSON.parse(JSON.stringify(config));
    if (typeof(config.rooms) === 'undefined' || config.rooms === null)
        config.rooms = ['Gruppe 1'];
    if (config.rooms.length < 1)
        config.rooms.push('Gruppe 1');
    if (config.rooms.length > schueler_for_lesson.length)
        config.rooms = config.rooms.slice(0, schueler_for_lesson.length);
    if (typeof(config.participants) === 'undefined' || config.participants === null) {
        config.participants = [];
        for (let i = 0; i < schueler_for_lesson.length; i++)
            config.participants.push(0);
    }
    for (let i = 0; i < schueler_for_lesson.length; i++)
    {
        if (config.participants[i] < 0)
            config.participants[i] = 0;
        if (config.participants[i] >= config.rooms.length)
            config.participants[i] = config.rooms.length - 1;
    }
    while (config.participants.length < schueler_for_lesson.length)
        config.participants.push(0);
    config.participants = config.participants.slice(0, schueler_for_lesson.length);
    return config;
}

function update_breakout_room_widgets() {
    let button = $('#ti_lesson_jitsi_breakout_rooms_popup');
    if (breakout_room_config === null) {
        button.data('state', 'no');
        $('#ti_breakout_room_count').prop('disabled', true);
        $('#ti_breakout_rooms_roaming').prop('disabled', true);
        $('.bu-fewer-breakout-rooms').prop('disabled', true);
        $('.bu-more-breakout-rooms').prop('disabled', true);
        $('.bu-breakout-room-arrange-dropdown').prop('disabled', true);
        
        $('#ti_event_jitsi_breakout_rooms').removeClass('btn-info').addClass('btn-outline-secondary');
        $('#ti_event_jitsi_breakout_rooms').find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
        $('#ti_event_jitsi_breakout_rooms').data('state', 'no');
        $('#ti_breakout_rooms_roaming').removeClass('btn-info').addClass('btn-outline-secondary');
        $('#ti_breakout_rooms_roaming').find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
        $('#ti_breakout_rooms_roaming').data('state', 'no');
    } else {
        button.data('state', 'yes');
        $('#ti_breakout_room_count').prop('disabled', false).val(breakout_room_config.rooms.length);
        $('.bu-fewer-breakout-rooms').prop('disabled', breakout_room_config.rooms.length <= 1);
        $('.bu-more-breakout-rooms').prop('disabled', breakout_room_config.rooms.length >= schueler_for_lesson.length);
        $('#ti_breakout_rooms_roaming').prop('disabled', false);
        if (breakout_room_config.roaming || false) {
            let b = $('#ti_breakout_rooms_roaming');
            b.addClass('btn-info').removeClass('btn-outline-secondary');
            b.find('.fa').addClass('fa-check').removeClass('fa-times');
            b.data('state', 'yes');
        } else {
            let b = $('#ti_breakout_rooms_roaming');
            b.removeClass('btn-info').addClass('btn-outline-secondary');
            b.find('.fa').removeClass('fa-check').addClass('fa-times');
            b.data('state', 'no');
        }
        $('.bu-breakout-room-arrange-dropdown').prop('disabled', false);
    }
    
    button.removeClass('half');
    if (button.data('state') === 'no') {
        button.removeClass('btn-info').addClass('btn-outline-secondary');
        button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
        $('#ti_event_jitsi_breakout_rooms').removeClass('btn-info').addClass('btn-outline-secondary').data('state', 'no');
        $('#ti_event_jitsi_breakout_rooms').find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
        $('#ti_breakout_rooms_roaming').removeClass('btn-info').addClass('btn-outline-secondary').data('state', 'no');
        $('#ti_breakout_rooms_roaming').find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
    }
    else {
        button.removeClass('btn-outline-secondary').addClass('btn-info');
        button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
        if ($('#ti_lesson_jitsi').data('state') !== 'yes')
            $('#ti_lesson_jitsi').click();
        $('#ti_event_jitsi_breakout_rooms').removeClass('btn-outline-secondary').addClass('btn-info').data('state', 'yes');
        $('#ti_event_jitsi_breakout_rooms').find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
    }
    
    $('.breakout-rooms-container').empty();
    if (breakout_room_config !== null) {
        let count = breakout_room_config.rooms.length;
        breakout_room_widgets.breakout_groups = [];
        for (let i = 0; i < count; i++) {
            let div = $('<div>').addClass('col-md-2');
            let ti_group_name = $('<input>').addClass('form-control').attr('placeholder', 'Gruppenname').val(breakout_room_config.rooms[i]);
            ti_group_name.data('room_index', i);
            div.append(ti_group_name);
            ti_group_name.change(function(e) {
                let room_index = $(e.target).data('room_index');
                breakout_room_config.rooms[room_index] = $(e.target).val().trim();
                update_breakout_room_widgets();
            });
            $('.breakout-rooms-container').append(div);
            div = $('<div>').addClass('breakout-col').addClass('col-md-10');
            let breakout_group = $('<div>').addClass('breakout-group');
            breakout_group.data('room_index', i);
            div.append(breakout_group);
            breakout_room_widgets.breakout_groups.push(breakout_group);
            $('.breakout-rooms-container').append(div);
            if (i < count - 1) {
                $('.breakout-rooms-container').append($('<div>').addClass('col-md-12').append($('<hr />')));
            }
            breakout_group.droppable({
                accept: '.user-widget',
                drop: function(event, ui) {
                    let element = $(ui.draggable[0]);
                    let email = element.data('email');
                    let room_index = $(this).data('room_index');
                    breakout_room_config.participants[schueler_for_lesson_index[email]] = room_index;
                    element.removeClass('dragging');
                    element.css('left', '0');
                    element.css('top', '0');
                    $(this).append(element);
                    $('.breakout-group').removeClass('accepting').removeClass('dragging');
                    update_changes();
                },
                over: function(event, ui) {
                    $('.breakout-group').removeClass('accepting');
                    $(this).addClass('accepting').scrollLeft(0);
                    let element = $(ui.draggable[0]);
                    element.data('has_drop_target', true);
                },
                out: function(event, ui) {
                    $('.breakout-group').removeClass('accepting');
                    let element = $(ui.draggable[0]);
                    element.data('has_drop_target', false);
                    $(this).scrollLeft(0);
                }
            });
        }
        for (let user of schueler_for_lesson) {
            let user_widget = $('<div>').addClass('user-widget');
            user_widget.html(`${user.display_name} <div class='group2-button group2-button-sm group2-${user.group2}'>${user.group2}</div>`);
            let icon = $('<div>').addClass('icon');
            icon.append('<div>').addClass('avatar-md').css('background-image', `url(#{NEXTCLOUD_URL}/index.php/avatar/${user.nc_login}/128), url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mO88h8AAq0B1REmZuEAAAAASUVORK5CYII=)`);
            breakout_room_widgets.breakout_groups[breakout_room_config.participants[schueler_for_lesson_index[user.email]]].append(user_widget);
            user_widget.append(icon);
            user_widget.data('email', user.email);
            user_widget.draggable({
                start: function(event, ui) {
                    let widget = $(ui.helper[0]);
                    drop_source = widget.closest('.breakout-group');
                    let clone = widget.clone().insertAfter(widget).css('opacity', 0.5);
                    let launchpad = $('<div>').addClass('phantom-launch-pad');
                    widget.closest('.breakout-rooms-container').append(launchpad);
                    x = widget.position().left;
                    y = widget.position().top;
                    x += widget.closest('.breakout-col').position().left + widget.closest('.breakout-group').position().left;
                    y += widget.closest('.breakout-col').position().top + widget.closest('.breakout-group').position().top;
                    y += 4;
                    launchpad.css('left', x);
                    launchpad.css('top', y);
//                     launchpad.css('left', 0).css('top', 0);
                    widget.data('clone', clone);
                    widget.data('launchpad', launchpad);
                    widget.data('drop_source', drop_source);
                    widget.detach().appendTo(launchpad);
                    widget.addClass('dragging');
                    widget.data('has_drop_target', false);
                },
                stop: function(event, ui) {
                    let widget = $(ui.helper[0]);
                    widget.data('drop_source').scrollLeft(0);
                    if (!widget.data('has_drop_target')) {
                        widget.data('drop_source').append(widget);
                        widget.removeClass('dragging');
                        widget.css('left', '0');
                        widget.css('top', '0');
                        $('.breakout-group').removeClass('accepting').removeClass('dragging');
                    }
                    widget.data('clone').remove();
                    widget.data('launchpad').remove();
                }
            });
        }
    }
    update_changes();
}

function update_changes() {
    pending_changes = force_pending_changes;
    for (key of data_keys) {
        if ($('#dd_' + key).is(':visible')) {
            let e = $('#dd_' + key + ' .dropdown-item')[0];
            if (!($(e).hasClass('checked')))
                pending_changes = true;
        }
        else {
            if ($('#ti_' + key).val() !== $('#ti_' + key).data('original-value'))
                pending_changes = true;
        }
        // early exit B-)
        if (pending_changes)
            break;
    }
    for (key of data_keys_bools) {
        if ($('#ti_' + key).data('state') !== $('#ti_' + key).data('original_state'))
            pending_changes = true;
        // early exit B-)
        if (pending_changes)
            break;
    }
    if (!pending_changes) {
        if (JSON.stringify(breakout_room_config) !== stored_breakout_room_config_json) 
            pending_changes = true;
    }
    if (!pending_changes) {
        if (JSON.stringify(booked_tablet_sets_config) !== stored_booked_tablet_sets_config) 
            pending_changes = true;
    }
    $('.bu-discard-changes').removeClass(pending_changes ? 'btn-outline-secondary' : 'btn-secondary').addClass(pending_changes ? 'btn-secondary' : 'btn-outline-secondary').prop('disabled', !pending_changes);
    $('.bu-save-changes').removeClass(pending_changes ? 'btn-outline-secondary' : 'btn-success').addClass(pending_changes ? 'btn-success' : 'btn-outline-secondary').prop('disabled', !pending_changes);
}

function update_tablet_booking_status(info) {
    $('.tablet-booking-status').html(`Für diese Stunde ist das Tablet <span style='background-color: ${info.bg_color}; color: ${info.fg_color}; padding: 0 4px;'>${info.tablet_id}</span> (${info.lagerort}) reserviert. Bitte beachten Sie, dass die Buchung verfällt, falls diese Stunde durch den Vertretungsplan verschoben werden sollte. Sie können dann ggfs. eine neue Buchung vornehmen.`);
}

function update_tablet_set_booking_status() {
    if (booked_tablet_sets_config.length === 0) {
        $('#ti_lesson_need_tablet_set').removeClass('btn-info').addClass('btn-outline-secondary');
        $('#ti_lesson_need_tablet_set').find('.fa').removeClass('fa-check').addClass('fa-times');
        $('.tablet-set-booking-status').empty();
    } else {
        $('#ti_lesson_need_tablet_set').addClass('btn-info').removeClass('btn-outline-secondary');
        $('#ti_lesson_need_tablet_set').find('.fa').removeClass('fa-times').addClass('fa-check');
        let names = booked_tablet_sets_config.map(function(x) { return `<b class='bg-warning' style='border-radius: 2px; padding: 0 4px;'>${x}</b>`; });
        $('.tablet-set-booking-status').html(`Für diese Stunde reserviert: ${names.join(', ')}. Bitte beachten Sie, dass die Buchung verfällt, falls diese Stunde durch den Vertretungsplan verschoben werden sollte. Sie können dann ggfs. eine neue Buchung vornehmen.`);
    }
}

function selection_updated() {
    $('#recording_row').detach().prependTo($('.schueler_table')).hide();
    $('.schueler_table tr').removeClass('current').removeClass('selected');
    let entries = [];
    for (i of Object.keys(row_for_lesson_offset)) {
        if (row_for_lesson_offset[i].hasClass('selected'))
            entries.push(i);
    }
    if (entries.length === 1)
        $('.delete-lessons-label').html('Diese Stunde');
    else
        $('.delete-lessons-label').html('' + entries.length + ' Stunden');
    if (entries.length === 0)
        $('.status_label').html('keine Stunden ausgewählt');
    else if (entries.length === 1)
        $('.status_label').html('1 Stunde ausgewählt');
    else
        $('.status_label').html('' + entries.length + ' Stunden ausgewählt');
        
    breakout_room_config = null;
    booked_tablet_sets_config = [];
    single_selected_offset = null;
    $('.tablet-booking-status').empty();
    $('.tablet-set-booking-status').empty();
    if (entries.length === 0) {
        $('.pane_items *').prop('disabled', true);
        $('.bu-discard-changes').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        $('.bu-save-changes').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
        $('.bu-umplanen').removeClass('btn-primary').addClass('btn-outline-secondary').prop('disabled', true);
        for (key of data_keys) {
            $('#ti_' + key).val('');
            $('#ti_' + key).attr('placeholder', '');
        }
        $('.na-on-multi-select').hide();
        $('#bu_feedback').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
        $('#bu_sus_feedback').removeClass('btn-warning').addClass('btn-outline-secondary').prop('disabled', true);
        $('.sus_feedback_label').text('').hide();
    } else { 
        if (entries.length === 1) {
            single_selected_offset = parseInt(entries[0]);
            $('.na-on-multi-select').hide();
            $('#bu_feedback').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
            $('#bu_sus_feedback').removeClass('btn-outline-secondary').addClass('btn-warning').prop('disabled', true);
            $('.sus_feedback_label').html(((lesson_data[entries[0]] || {}).feedback || {}).summary || 'Zu dieser Stunde liegt kein Feedback vor.').show();
            breakout_room_config = {
                rooms: JSON.parse(JSON.stringify(((lesson_data[entries[0]] || {}).info || {}).breakout_rooms || null)),
                participants: JSON.parse(JSON.stringify(((lesson_data[entries[0]] || {}).info || {}).breakout_room_participants || null)),
                roaming: JSON.parse(JSON.stringify(((lesson_data[entries[0]] || {}).info || {}).breakout_rooms_roaming || null)),
            }
            if (breakout_room_config.rooms === null || breakout_room_config.participants === null)
                breakout_room_config = null;
            let button = $('#ti_lesson_jitsi_breakout_rooms_popup');
            if (breakout_room_config !== null) {
                // fix participants if SuS numbers have changed in the meantime
                if (breakout_room_config.rooms !== null && breakout_room_config.participants !== null)
                    breakout_room_config = sanitize_breakout_room_config(breakout_room_config);
                button.removeClass('btn-outline-secondary').removeClass('half').addClass('btn-info');
                button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                button.data('state', 'yes');
            } else {
                button.removeClass('btn-info').removeClass('half').addClass('btn-outline-secondary');
                button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                button.data('state', 'no');
            }
            button = $('#ti_lesson_need_tablet');
            if (((lesson_data[single_selected_offset] || {}).info || {}).booked_tablet) {
                button.removeClass('btn-outline-secondary').removeClass('half').addClass('btn-info');
                button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                button.data('state', 'yes');
                let info = ((lesson_data[single_selected_offset] || {}).info || {}).booked_tablet;
                update_tablet_booking_status(info);
            } else {
                button.removeClass('btn-info').removeClass('half').addClass('btn-outline-secondary');
                button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                button.data('state', 'no');
            }
            button = $('#ti_lesson_need_tablet_set');
            if (((lesson_data[single_selected_offset] || {}).info || {}).booked_tablet_sets) {
                booked_tablet_sets_config = ((lesson_data[single_selected_offset] || {}).info || {}).booked_tablet_sets;
            }
            button = $('#ti_lesson_fixed');
            if (((lesson_data[single_selected_offset] || {}).info || {}).lesson_fixed) {
                button.removeClass('btn-outline-secondary').removeClass('half').addClass('btn-info');
                button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                button.data('state', 'yes');
            } else {
                button.removeClass('btn-info').removeClass('half').addClass('btn-outline-secondary');
                button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                button.data('state', 'no');
            }
        } else {
            $('.na-on-multi-select').show();
            $('#bu_feedback').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
            $('#bu_sus_feedback').removeClass('btn-warning').addClass('btn-outline-secondary').prop('disabled', true);
            $('.sus_feedback_label').text('').hide();
        }
        $('.bu-umplanen').removeClass('btn-outline-secondary').addClass('btn-primary').prop('disabled', false);
        $('.pane_items *').prop('disabled', false);
        $('.bu-discard-changes').addClass('btn-outline-secondary').removeClass('btn-secondary').prop('disabled', true);
        $('.bu-save-changes').addClass('btn-outline-secondary').removeClass('btn-success').prop('disabled', true);
        for (key of data_keys) {
            let seen_values = {};
            for (entry of entries) {
                let value = (((lesson_data[entry] || {}).info || {})[key] || '').trim();
                seen_values[value] = true;
            }
            if (Object.keys(seen_values).length === 1) {
                // only one value
                let v = Object.keys(seen_values)[0];
                $('#ti_' + key).val(v);
                $('#ti_' + key).attr('placeholder', '');
                $('#ti_' + key).data('original-value', v);
                $('#dd_' + key).css('display', 'none');
            } else {
                // multiple values
                $('#ti_' + key).val('');
                $('#ti_' + key).attr('placeholder', '(Einträge unverändert lassen)');
                $('#dd_' + key).css('display', 'block');
                let menu = $('#dd_' + key + ' .dropdown-menu').data('key', key);
                menu.empty();
                $('<button>').addClass('dropdown-item checked').data('special', 'unchanged').html('Einträge unverändert lassen').appendTo(menu);
                $('<button>').addClass('dropdown-item').data('special', 'clear').html('alle Einträge löschen').appendTo(menu);
                $('<div>').addClass('dropdown-divider').appendTo(menu);
                for (v of Object.keys(seen_values))
                {
                    if (v.length > 0)
                        $('<button>').addClass('dropdown-item').data('value', v).html(v).appendTo(menu);
                }
                menu.find('.dropdown-item').click(function(e) {
                    let item = $(e.target);
                    let menu = item.closest('.dropdown-menu');
                    let key = menu.data('key');
                    menu.find('.dropdown-item').removeClass('checked');
                    $(e.target).addClass('checked');
                    if (item.data('special') === 'unchanged')
                        $('#ti_' + key).attr('placeholder', '(Einträge unverändert lassen)').val('');
                    else if (item.data('special') === 'clear')
                        $('#ti_' + key).attr('placeholder', '(alle Einträge löschen)').val('');
                    else {
                        $('#ti_' + key).attr('placeholder', '').val(item.data('value'));
                    }
                    update_changes();
                });
            }
        }
        for (key of data_keys_bools) {
            let seen_values = {};
            for (entry of entries) {
                let value = ((lesson_data[entry] || {}).info || {})[key] || false;
                seen_values[value] = true;
            }
            let button = $('#ti_' + key);
            if (Object.keys(seen_values).length === 1) {
                // only one value
                let v = (Object.keys(seen_values)[0] === 'true');
                if (v === true) {
                    button.removeClass('btn-outline-secondary').removeClass('half').addClass('btn-info');
                    button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                    button.data('state', 'yes');
                    button.data('original_state', 'yes');
                } else {
                    button.removeClass('btn-info').removeClass('half').addClass('btn-outline-secondary');
                    button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                    button.data('state', 'no');
                    button.data('original_state', 'no');
                }
            } else {
                // multiple values
                button.removeClass('btn-outline-secondary').addClass('btn-info').addClass('half');
                button.find('.fa').removeClass('fa-times').removeClass('fa-check').addClass('fa-question-circle');
                button.data('state', 'mixed');
                button.data('original_state', 'mixed');
            }
        }
        if (entries.length === 1) {
            $('#ti_lesson_jitsi_breakout_rooms_popup').prop('disabled', false);
            $('#ti_lesson_need_tablet').prop('disabled', false);
            $('#ti_lesson_need_tablet_set').prop('disabled', false);
        } else {
            $('#ti_lesson_jitsi_breakout_rooms_popup').prop('disabled', true);
            $('#ti_lesson_need_tablet').prop('disabled', true);
            $('#ti_lesson_need_tablet_set').prop('disabled', true);
        }
    } 
    if ((#{@@lessons[:lesson_keys][show_lesson_key][:lehrer]}.indexOf('#{@session_user[:shorthand]}') < 0) && (#{(@@lessons[:historic_lessons_for_shorthand][@session_user[:shorthand]] || Set.new()).to_a}.indexOf('#{show_lesson_key}') < 0)) {
        $('.pane_items *').prop('disabled', true);
        $('.bu-discard-changes').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        $('.bu-save-changes').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
        $('.bu-umplanen').removeClass('btn-primary').addClass('btn-outline-secondary').prop('disabled', true);
    }
    update_tablet_set_booking_status();
    stored_breakout_room_config_json = JSON.stringify(breakout_room_config);
    stored_booked_tablet_sets_config = JSON.stringify(booked_tablet_sets_config);
}

function update_table() {
    for (i of Object.keys(row_for_lesson_offset)) {
        let row = row_for_lesson_offset[i];
        for (key of data_keys)
        {
            if (key === 'hausaufgaben_text') {
                let cell = row.find('.tc_homework');
                cell.empty();
                let printed_something = false;
                if (((lesson_data[i] || {}).info || {}).homework_nc) {
                    cell.append($('<span>').addClass('bv').html('NC'));
                    printed_something = true;
                }
                if (((lesson_data[i] || {}).info || {}).homework_lr) {
                    printed_something = true;
                    cell.append($('<span>').addClass('bv').html('LR'));
                }
                let parts = [];
                parts.push(((lesson_data[i] || {}).info || {})[key] || '');
                parts.push(((lesson_data[i] || {}).info || {})['ha_amt_text'] || '');
                let s = parts.filter((x) => (x.length > 0)).join(' / ');
                cell.append($('<span>').html(s));
                if ((!printed_something) && s.length == 0)
                    cell.append($('<span>').html('&ndash;'));
                cell.append($('<span>').html('&nbsp;'));
            } else if (key === 'stundenthema_text') {
                let cell = row.find('.tc_stundenthema');
                cell.empty();
                let printed_something = false;
                if (((lesson_data[i] || {}).info || {}).lesson_fixed ?? false) {
                    cell.append($(`<i style='display: inline; margin-right: 0.5em; font-size: 80%;' class='fa fa-calendar-check-o'></i>`));
                }
                cell.append($('<span>').html(((lesson_data[i] || {}).info || {})[key] || ''));
                if ((!printed_something) && (((lesson_data[i] || {}).info || {})[key] || '').length == 0)
                    cell.append($('<span>').html('&ndash;'));
                cell.append($('<span>').html('&nbsp;'));
            } else {
                let value = ((lesson_data[i] || {}).info || {})[key] || '';
                if (value.length > 0)
                    row.find('.tc_' + key).html(value);
                else
                    row.find('.tc_' + key).html('&ndash;');
            }
        }
        let cell = row.find('.tc_lesson');
        cell.empty();
        let wrote_something = false;
        if (((lesson_data[i] || {}).info || {}).lesson_jitsi) {
            if (((lesson_data[i] || {}).info || {}).breakout_rooms) {
                cell.append($('<span>').addClass('bv').html('Jitsi / GR'));
            } else {
                cell.append($('<span>').addClass('bv').html('Jitsi'));
            }
            wrote_something = true;
        }
        if (((lesson_data[i] || {}).info || {}).booked_tablet) {
            let span = $('<span>').addClass('bv');
            span.html(lesson_data[i].info.booked_tablet.tablet_id);
            span.css('background-color', lesson_data[i].info.booked_tablet.bg_color);
            span.css('color', lesson_data[i].info.booked_tablet.fg_color);
            cell.append(span);
            wrote_something = true;
        }
        if (((lesson_data[i] || {}).info || {}).booked_tablet_sets) {
            let span = $('<span>').addClass('bv');
            span.html(`<i class='fa fa-laptop'></i> <i class='fa fa-tablet'></i> <span style='font-weight: normal;'>&times;${(lesson_data[i].info.booked_tablet_sets_tablet_count) || 0}</span>`);
            cell.append(span);
            wrote_something = true;
        }
        if (((lesson_data[i] || {}).info || {}).lesson_nc) {
            cell.append($('<span>').addClass('bv').html('NC'));
            wrote_something = true;
        }
        if (((lesson_data[i] || {}).info || {}).lesson_lr) {
            cell.append($('<span>').addClass('bv').html('LR'));
            wrote_something = true;
        }
        if (!wrote_something)
            cell.append($('<span>').html('&ndash;'));
        cell.append($('<span>').html('&nbsp;'));
        cell = row.find('.tc_feedback');
        cell.empty();
        let comment_count = 0;
        let audio_comment_count = 0;
        let comments = ((lesson_data[i] || {}).comments || {});
        for (email of Object.keys(comments)) {
            if ((comments[email].audio_comment_tag || '').length > 0)
                audio_comment_count += 1;
            if ((comments[email].text_comment || '').length > 0)
                comment_count += 1;
        }
        if (comment_count > 0)
            cell.append($("<span class='badge badge-success' style='margin-right: 4px;'><i class='fa fa-comment'></i>&nbsp;&nbsp;" + comment_count + "</span>"));
        if (audio_comment_count > 0)
            cell.append($("<span class='badge badge-success' style='margin-right: 4px;'><i class='fa fa-microphone'></i>&nbsp;&nbsp;" + audio_comment_count + "</span>"));
        if (comment_count === 0 && audio_comment_count === 0)
            cell.append($('<span>').html('&ndash;'));
    }
}

function discard_changes() {
    selection_updated();
    force_pending_changes = false;
    update_changes();
}

function save_changes() {
    let data = {};
    data.lesson_key = lesson_key;
    data.lesson_offsets = [];
    for (i of Object.keys(row_for_lesson_offset)) {
        if (row_for_lesson_offset[i].hasClass('selected'))
            data.lesson_offsets.push(parseInt(i));
    }
    data.data = {};
    for (key of data_keys) {
        let record_this_key = true;
        let value = $('#ti_' + key).val().trim();
        if ($('#dd_' + key).is(':visible')) {
            let el = $('#dd_' + key + ' .dropdown-item.checked');
            if (el.length > 0) {
                let e = $(el[0]);
                if (e.data('special') === 'unchanged')
                    record_this_key = false;
                else if (e.data('special') === 'clear')
                    value = '';
            }
        }
        if (value.length === 0)
            value = '';
        if (record_this_key)
            data.data[key] = value;
    }
    for (key of data_keys_bools) {
        let record_this_key = true;
        let value = $('#ti_' + key).data('state');
        if (value === 'mixed')
            record_this_key = false;
        else if (value === 'yes')
            value = true;
        else
            value = false;
        if (record_this_key)
            data.data[key] = value;
    }
    if (data.lesson_offsets.length === 1) {
        // if we have one lesson selected, store breakout room config
        data.breakout_rooms = {};
        if (breakout_room_config !== null) {
            data.breakout_rooms = {
                rooms: breakout_room_config.rooms,
                participants: breakout_room_config.participants,
                roaming: breakout_room_config.roaming || false
            };
        };
        // if we have one lesson selected, store booked tablet sets config
        data.booked_tablet_sets = booked_tablet_sets_config;
        let time_span = window.time_span_for_lesson_offset[window.single_selected_offset];
        data.booked_tablet_sets_timespan = {
            datum: time_span.datum,
            start_time: time_span.start_time,
            end_time: time_span.end_time
        };
    }
    data.datum_for_offset = {};
    for (let offset of data.lesson_offsets)
        data.datum_for_offset[offset] = window.time_span_for_lesson_offset[offset].datum;
    (function(data) {
        api_call('/api/save_lesson_data', data, function(result) {
            if (result.success) {
                for (i of data.lesson_offsets) {
                    for (k of Object.keys(data.data))
                    {
                        if (typeof(lesson_data[i]) === 'undefined')
                            lesson_data[i] = {};
                        let v = data.data[k];
                        if (v === null)
                            delete lesson_data[i].info[k];
                        else
                        {
                            if (typeof(lesson_data[i].info) === 'undefined')
                                lesson_data[i].info = {};
                            lesson_data[i].info[k] = v;
                        }
                    }
                    if (data.lesson_offsets.length === 1) {
                        if (typeof(data.breakout_rooms.rooms) !== 'undefined')
                            lesson_data[i].info.breakout_rooms = data.breakout_rooms.rooms;
                        else
                            delete lesson_data[i].info.breakout_rooms;
                        if (typeof(data.breakout_rooms.participants) !== 'undefined')
                            lesson_data[i].info.breakout_room_participants = data.breakout_rooms.participants;
                        else
                            delete lesson_data[i].info.breakout_room_participants;
                        if (typeof(data.breakout_rooms.roaming) !== 'undefined')
                            lesson_data[i].info.breakout_rooms_roaming = data.breakout_rooms.roaming;
                        else
                            delete lesson_data[i].info.breakout_rooms_roaming;
                        if ((data.booked_tablet_sets || []).length == 0)
                            delete lesson_data[i].info.booked_tablet_sets;
                        else {
                            lesson_data[i].info.booked_tablet_sets = data.booked_tablet_sets;
                            lesson_data[i].info.booked_tablet_sets_tablet_count = 0;
                            for (let x of data.booked_tablet_sets)
                                lesson_data[i].info.booked_tablet_sets_tablet_count += tablet_set_info[x].count;
                        }
                    }
                }
                stored_breakout_room_config_json = JSON.stringify(breakout_room_config);
                stored_booked_tablet_sets_config = JSON.stringify(booked_tablet_sets_config);
                if (typeof(lesson_data[i].info.preliminary_booked_tablet) !== 'undefined') {
                    lesson_data[i].info.booked_tablet = lesson_data[i].info.preliminary_booked_tablet;
                    delete lesson_data[i].info.preliminary_booked_tablet;
                } else {
                    delete lesson_data[i].info.booked_tablet;
                }
                update_table();
                selection_updated();
                force_pending_changes = false;
                update_changes();
            }
        });
    })(data);
}

function update_feedback_buttons() {
    let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
    let comment_data = (((lesson_data[lesson_offset] || {}).comments || {})[$($('.schueler_table tr.selected')[0]).data('email')] || {});
    if (recording) {
        $('#bu_record_audio_comment').prop('disabled', true);
        $('#bu_stop_audio_comment').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-primary');
        $('#bu_play_audio_comment').prop('disabled', true).removeClass('btn-primary').addClass('btn-outline-secondary');
    } else if (playing) {
        $('#bu_record_audio_comment').prop('disabled', true);
        $('#bu_stop_audio_comment').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-primary');
        $('#bu_play_audio_comment').prop('disabled', true).removeClass('btn-primary').addClass('btn-outline-secondary');
    } else {
        if (!pending_feedback_audio_comment_changes()) {
            $('#bu_record_audio_comment').prop('disabled', false);
            $('#bu_stop_audio_comment').prop('disabled', true).removeClass('btn-primary').addClass('btn-outline-secondary');
            $('#bu_play_audio_comment').prop('disabled', true).removeClass('btn-primary').addClass('btn-outline-secondary');
        } else {
            $('#bu_record_audio_comment').prop('disabled', false);
            $('#bu_stop_audio_comment').prop('disabled', true).removeClass('btn-primary').addClass('btn-outline-secondary');
            $('#bu_play_audio_comment').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-primary');
        }
        if (pending_feedback_changes()) {
            $('#bu_close_feedback_modal').prop('disabled', true);
        } else {
            $('#bu_close_feedback_modal').prop('disabled', false);
        }
    }
    if (!pending_feedback_audio_comment_changes()) {
        $('#bu_publish_audio_comment').prop('disabled', true);
        $('#bu_publish_audio_comment').removeClass('btn-success').addClass('btn-outline-secondary');
        $('#bu_discard_audio_comment').prop('disabled', true);
        $('#bu_discard_audio_comment').removeClass('btn-secondary').addClass('btn-outline-secondary');
    } else {
        $('#bu_publish_audio_comment').prop('disabled', false);
        $('#bu_publish_audio_comment').removeClass('btn-outline-secondary').addClass('btn-success');
        $('#bu_discard_audio_comment').prop('disabled', false);
        $('#bu_discard_audio_comment').removeClass('btn-outline-secondary').addClass('btn-secondary');
    }
    if ((comment_data.audio_comment_tag || '').length > 0) {
        $('#recording_row #bu_publish_audio_comment').html('Kommentar ersetzen');
    } else {
        $('#recording_row #bu_publish_audio_comment').html('Kommentar freigeben');
    }
    if (recording) {
        $('#recording_row #bu_delete_audio_comment').removeClass('btn-danger').addClass('btn-outline-secondary').prop('disabled', true);
    } else {
        if ((comment_data.audio_comment_tag || '').length > 0) {
            $('#recording_row #bu_delete_audio_comment').removeClass('btn-outline-secondary').addClass('btn-danger').prop('disabled', false);
        } else {
            $('#recording_row #bu_delete_audio_comment').removeClass('btn-danger').addClass('btn-outline-secondary').prop('disabled', true);
        }
    }
    if ((comment_data.text_comment || '').length > 0) {
        $('#recording_row #bu_delete_text_comment').removeClass('btn-outline-secondary').addClass('btn-danger').prop('disabled', false);
    } else {
        $('#recording_row #bu_delete_text_comment').removeClass('btn-danger').addClass('btn-outline-secondary').prop('disabled', true);
    }
    if (!pending_feedback_text_comment_changes()) {
        $('#bu_publish_text_comment').prop('disabled', true);
        $('#bu_publish_text_comment').removeClass('btn-success').addClass('btn-outline-secondary');
        $('#bu_discard_text_comment').prop('disabled', true);
        $('#bu_discard_text_comment').removeClass('btn-secondary').addClass('btn-outline-secondary');
    } else {
        $('#bu_publish_text_comment').prop('disabled', false);
        $('#bu_publish_text_comment').removeClass('btn-outline-secondary').addClass('btn-success');
        $('#bu_discard_text_comment').prop('disabled', false);
        $('#bu_discard_text_comment').removeClass('btn-outline-secondary').addClass('btn-secondary');
    }
    if ((comment_data.text_comment || '').length > 0) {
        $('#recording_row #bu_publish_text_comment').html('Kommentar ersetzen');
    } else {
        $('#recording_row #bu_publish_text_comment').html('Kommentar freigeben');
    }
}

function update_rec_time_label() {
    if (mediaRecorder.state !== 'recording')
        return;

    let duration = (Date.now() - rec_start_time) / 1000;
    if (duration > max_recording_time * 60)
        $('#bu_stop_audio_comment').click();
    
    $('#duration').html(duration_to_str(duration));
    let width = (duration / (max_recording_time * 60) * 100);
    if (width > 100)
        width = 100;
    $('#audio_time .progress-bar').css('width', '' + width + '%');
}

function stop() {
    if (recording) {
        recording = false;
        rec_duration = Math.floor(Date.now() - rec_start_time);
        clearInterval(update_rec_time_label_timeout);
        if (mediaRecorder.state === 'recording')
            mediaRecorder.stop();
        $('#audio_time .progress-bar').css('width', '0%');
    }
    if (playing) {
        playing = false;
        audio.pause();
        audio.currentTime = 0;
    }
    if (pb_playing) {
        pb_audio.pause();
        pb_audio.currentTime = 0;
        pb_audio.dispatchEvent(new Event('ended'));
    }
    setTimeout(function() {
        $('#audio_time .progress-bar').css('width', '0%');
    }, 0);
    update_feedback_buttons();
}

function pending_feedback_audio_comment_changes() {
    if (audio !== null)
        return true;
    return false;
}

function pending_feedback_text_comment_changes() {
    let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
    let schueler = $($('.schueler_table tr.selected')[0]).data('email');
    if ($('#ti_feedback_comment').val() !== ((((lesson_data[lesson_offset] || {}).comments || {})[schueler] || {}).text_comment || ''))
        return true;
    return false;
}

function pending_feedback_changes() {
    return pending_feedback_audio_comment_changes() || pending_feedback_text_comment_changes();
}

function update_present_amt_rows() {
    api_call('/api/get_amt_sus', {lesson_key: lesson_key}, function(data) {
        if (data.success) {
            let added_rows = false;
            $('#present_amt_rows').empty();
            for (let user of schueler_for_lesson) {
                let email = user.email;
                if (email in data.results) {
                    added_rows = true;
                    let row = $('<tr>');
                    row.append($('<td>').text(user.display_name));
                    let amt_list = data.results[email] || [];

                    let has_ha_amt = (amt_list.indexOf('hausaufgaben') >= 0);
                    if (has_ha_amt) {
                        let bu_remove_ha = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').css('font-size', '0.7rem').html("<i class='fa fa-times'></i>");
                        row.append($('<td>').append(bu_remove_ha));
                        bu_remove_ha.click(function() {
                            api_call('/api/remove_sus_from_amt', {lesson_key: lesson_key, email: email, amt: 'hausaufgaben'}, function(data) {
                                if (data.success)
                                    update_present_amt_rows();
                            });
                        });
                    } else {
                        row.append($('<td>'));
                    }

                    let has_ma_amt = (amt_list.indexOf('material') >= 0);
                    if (has_ma_amt) {
                        let bu_remove_ma = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').css('font-size', '0.7rem').html("<i class='fa fa-times'></i>");
                        row.append($('<td>').append(bu_remove_ma));
                        bu_remove_ma.click(function() {
                            api_call('/api/remove_sus_from_amt', {lesson_key: lesson_key, email: email, amt: 'material'}, function(data) {
                                if (data.success)
                                    update_present_amt_rows();
                            });
                        });
                    } else {
                        row.append($('<td>'));
                    }

                    $('#present_amt_rows').append(row);
                }
            }
            if (added_rows)
                $('#present_amt_table').show();
            else
                $('#present_amt_table').hide();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    $('body').keydown(function(e) {
        if (!can_select)
            return;
        if ($(e.target).hasClass('form-control'))
            return;
        if (e.code === 'KeyA' && e.ctrlKey === true) {
            e.preventDefault();
            e.stopPropagation();
            if (pending_changes) {
                $('.bu-save-discard-container').effect('shake', {direction: 'left', distance: 4});
                return;
            }
            $('.lesson_table tr.lesson').removeClass('current');
            $('.lesson_table tr.lesson').addClass('selected');
            cursor = null;
            selection_updated();
        }
    });
    $('body').mousedown(function(e) {
        if ($('#feedbackModal').is(':visible'))
            return;
        if ($('#breakoutRoomsModal').is(':visible'))
            return;
        if ($('#tabletSetModal').is(':visible'))
            return;
        if ($(e.target).closest('tr').length > 0)
            return;
        if (!can_select)
            return;
        if ($(e.target).closest('.lesson_pane').length > 0)
            return;
        if (pending_changes) {
            $('.bu-save-discard-container').effect('shake', {direction: 'left', distance: 4});
            return;
        }
        $('.lesson_table tr').removeClass('current');
        $('.lesson_table tr').removeClass('selected');
        cursor = null;
        selection_updated();
    });
    
    $('#ti_feedback_comment').keyup(function(e) {
        update_feedback_buttons();
    });
    
    $('.pane_items .form-control').keyup(function(e) {
        update_changes();
    });
    $('.pane_items .form-control').change(function(e) {
        update_changes();
    });
    
    $('.btn_lesson_data').click(function(e) {
        let button = $(e.target);
        if (button.attr('id') !== 'ti_lesson_jitsi_breakout_rooms_popup') {
            button.removeClass('half');
            if (button.data('state') === 'yes') {
                button.removeClass('btn-info').addClass('btn-outline-secondary');
                button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                button.data('state', 'no');
                button.blur();
            }
            else {
                button.removeClass('btn-outline-secondary').addClass('btn-info');
                button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                button.data('state', 'yes');
            }
            if (button.attr('id') === 'ti_lesson_jitsi' && button.data('state') !== 'yes') {
                breakout_room_config = null;
                update_breakout_room_widgets();
                let tablet_button = $('#ti_lesson_need_tablet');
                if (tablet_button.data('state') === 'yes')
                    tablet_button.click();
            }
            update_changes();
        }
    });
    
    $('#ti_lesson_need_tablet').click(function(e) {
        let button = $('#ti_lesson_need_tablet');
        $('.tablet-booking-status').empty();
        if (button.data('state') === 'yes') {
            // we don't need a tablet anymore
            let data = {
                lesson_key: lesson_key, 
                offset: window.single_selected_offset
            };
            api_call('/api/unbook_streaming_tablet_for_lesson', data, function(data) {
                if (data.success) {
                    if (typeof(lesson_data[window.single_selected_offset].info.preliminary_booked_tablet) !== 'undefined')
                        delete lesson_data[window.single_selected_offset].info.preliminary_booked_tablet;
                    button.removeClass('btn-info').addClass('btn-outline-secondary');
                    button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
                    button.data('state', 'no');
                    button.blur();
                    force_pending_changes = true;
                    update_changes();
                }
            });
        }
        else {
            let time_span = window.time_span_for_lesson_offset[window.single_selected_offset];
            let data = {
                lesson_key: lesson_key, 
                offset: window.single_selected_offset, 
                datum: time_span.datum,
                start_time: time_span.start_time,
                end_time: time_span.end_time
            };
            // try to find a bookable tablet
            // don't make it permanent yet before saving
            api_call('/api/book_streaming_tablet_for_lesson', data, function(data) {
                if (data.success) {
                    if (data.found_tablet) {
                        if (typeof(lesson_data[window.single_selected_offset]) === 'undefined')
                            lesson_data[window.single_selected_offset] = {};
                        if (typeof(lesson_data[window.single_selected_offset].info) === 'undefined')
                            lesson_data[window.single_selected_offset].info = {};
                        lesson_data[window.single_selected_offset].info.preliminary_booked_tablet = {
                            tablet_id: data.tablet,
                            lagerort: data.tablet_info.lagerort,
                            bg_color: data.tablet_info.bg_color,
                            fg_color: data.tablet_info.fg_color
                        };
                        update_tablet_booking_status(lesson_data[window.single_selected_offset].info.preliminary_booked_tablet);

                        $('.tablet-booking-status').html(`Für diese Stunde ist das Tablet <span style='background-color: ${data.tablet_info.bg_color}; color: ${data.tablet_info.fg_color}; padding: 0 4px;'>${data.tablet}</span> (${data.tablet_info.lagerort}) für Sie reserviert. Bitte beachten Sie, dass die Buchung verfällt, falls diese Stunde durch den Vertretungsplan verschoben werden sollte. Sie können dann ggfs. eine neue Buchung vornehmen.`);
                        let jitsi_button = $('#ti_lesson_jitsi');
                        if (jitsi_button.data('state') !== 'yes') {
                            jitsi_button.click();
                        }
                        button.removeClass('btn-outline-secondary').addClass('btn-info');
                        button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
                        button.data('state', 'yes');
                        force_pending_changes = true;
                        update_changes();
                    } else {
                        $('.tablet-booking-status').html(`Es konnte leider kein verfügbares Tablet gefunden werden.`);
                    }
                }
            });
        }
        update_changes();
    });
    
    $('#ti_lesson_need_tablet_set').click(function(e) {
        let button = $('#ti_lesson_need_tablet_set');
        let time_span = window.time_span_for_lesson_offset[window.single_selected_offset];
        let _data = {
            lesson_key: lesson_key, 
            offset: window.single_selected_offset, 
            datum: time_span.datum,
            start_time: time_span.start_time,
            end_time: time_span.end_time
        };
        // try to find a bookable tablet
        // don't make it permanent yet before saving
        api_call('/api/find_available_tablet_sets_for_lesson', _data, function(data) {
            let div = $('#available_tablet_sets_here');
            div.empty();
            for (let key of data.available_tablet_sets_order) {
                let row = $('<tr>');
                let bu_div = $('<div>').addClass('button-with-label');
                let bu_book_tablet_set = $('<button>').addClass('btn').addClass('btn-sm').data('tablet_set_id', key).css('width', '120px');
                if (booked_tablet_sets_config.indexOf(key) >= 0) {
                    bu_book_tablet_set.addClass('btn-info').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Gebucht");
                } else
                {
                    bu_book_tablet_set.addClass('btn-outline-secondary').html("<i class='fa fa-times'></i>&nbsp;&nbsp;Nicht gebucht");
                }
                bu_book_tablet_set.click(function(e) {
                    let button = $(e.target).closest('button');
                    let tablet_set_id = button.data('tablet_set_id');
                    if (booked_tablet_sets_config.indexOf(tablet_set_id) >= 0) {
                        button.removeClass('btn-info').addClass('btn-outline-secondary');
                        button.html("<i class='fa fa-times'></i>&nbsp;&nbsp;Nicht gebucht");
                        booked_tablet_sets_config = booked_tablet_sets_config.filter(item => item !== tablet_set_id);
                    } else {
                        button.removeClass('btn-outline-secondary').addClass('btn-info');
                        button.html("<i class='fa fa-check'></i>&nbsp;&nbsp;Gebucht");
                        booked_tablet_sets_config = booked_tablet_sets_config.filter(item => item !== tablet_set_id);
                        booked_tablet_sets_config.push(tablet_set_id);
                        booked_tablet_sets_config.sort();
                    }
                    update_changes();
                    update_tablet_set_booking_status();
                });
                row.append($('<td>').text(key));
                row.append($('<td>').text(data.available_tablet_sets[key].label));
                row.append($('<td>').text(data.available_tablet_sets[key].standort));
                row.append($('<td>').css('padding-top', '4px').css('padding-bottom', '4px').append(bu_div.append(bu_book_tablet_set)));
                console.log(data.available_tablet_sets[key]);
                if (data.available_tablet_sets[key].blocked_by && data.available_tablet_sets[key].blocked_by.length > 0) {
                    bu_book_tablet_set.prop('disabled', true).hide();
                }
                div.append(row);
                if (!data.available_tablet_sets[key].is_tablet_set) {
                    row.hide();
                }
                if (data.available_tablet_sets[key].hint) {
                    row = $('<tr>').addClass('annotation_row');
                    row.append($('<td>').attr('colspan', 4).css('white-space', 'unset').css('position', 'relative').css('top', '-10px').html(data.available_tablet_sets[key].hint));
                    div.append(row);
                    if (!data.available_tablet_sets[key].is_tablet_set) {
                        row.hide();
                    }
                }
            }
            if ($('tr:hidden').length > 0) {
            let button = $(`<button class='btn btn-sm btn-outline-secondary mb-1'>Alle Geräte anzeigen</button>`);
            button.on('click', function(e) {
                button.remove();
                all_devices_displayed = true
                $('tr:hidden').show();
            });
            div.append(button);
        }
            $('#tabletSetModal').modal('show');
        });
    });
    
    $('.bu-discard-changes').click(function(e) { discard_changes() });
    $('.bu-save-changes').click(function(e) { save_changes() });
    $('.lesson_pane input').keydown(function(e) {
        let key = $(e.target).attr('id').replace('ti_', '');
        if (data_keys.indexOf(key) >= 0)
            $('#dd_' + key + ' .dropdown-item').removeClass('checked');
        $(e.target).attr('placeholder', '');
        if (e.key === 'Enter')
        {
            $('.bu-save-changes').click();
            e.preventDefault();
            e.stopPropagation();
        }
    });
    $('.lesson_pane textarea').keydown(function(e) {
        let key = $(e.target).attr('id').replace('ti_', '');
        if (data_keys.indexOf(key) >= 0)
            $('#dd_' + key + ' .dropdown-item').removeClass('checked');
        $(e.target).attr('placeholder', '');
        if (e.key === 'Enter' && e.ctrlKey)
        {
            $('.bu-save-changes').click();
            e.preventDefault();
            e.stopPropagation();
        }
    });
    
    $('#ti_feedback_comment').keydown(function(e) {
        if (e.key === 'Enter' && e.ctrlKey)
        {
            $('#bu_publish_text_comment').click();
            e.preventDefault();
            e.stopPropagation();
        }
    });
    
    let n = 0;
    for (user of schueler_for_lesson) {
        n += 1;
        let row = $('<tr>').addClass('schueler');
        row.data('email', user.email);
        row.data('first_name', user.first_name);
        $('<td>').css('text-align', 'right').text(`${n}.`).appendTo(row);
        $('<td>').html(user.display_name).appendTo(row);
        $('<td>').addClass('td_comment').html('&ndash;').appendTo(row);
        $('<td>').addClass('td_audio_comment').html('&ndash;').appendTo(row);
//         $('<td>').html("<button class='btn btn-primary btn-xs'><i class='fa fa-play' style='font-size: 60%;'></i>&nbsp;&nbsp;0:07</button>").appendTo(row);
        $('#feedbackModal .schueler_table').append(row);
        row.click(function(e) {
            if ($(e.target).hasClass('btn'))
                return;
            if (pending_feedback_changes()) {
                if (pending_feedback_text_comment_changes())
                    $('#publish_text_comment_btn_container').effect('shake', {direction: 'left', distance: 4});
                if (pending_feedback_audio_comment_changes())
                    $('#publish_audio_comment_btn_container').effect('shake', {direction: 'left', distance: 4});
                return;
            }
            stop();
            audio = null;
            audio_blob = null;
            $('#duration').html('0:00');
            $('#feedbackModal .schueler_table tr').removeClass('selected');
            let row = $(e.target).closest('tr');
            $('#recording_row .first_name_here').html(row.data('first_name'));
            $('#recording_row').detach().insertAfter(row).show();
            row.addClass('selected');
            let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
            let schueler = $($('.schueler_table tr.selected')[0]).data('email');
            $('#ti_feedback_comment').val((((((lesson_data[lesson_offset] || {}) || {}).comments || {})[schueler] || {}).text_comment || ''));
            update_feedback_buttons();
            $('#ti_feedback_comment').focus();
        });
    }
    
    $('#feedbackModal').on('hide.bs.modal', function(e) {
        if (pending_feedback_changes()) {
            if (pending_feedback_text_comment_changes())
                $('#publish_text_comment_btn_container').effect('shake', {direction: 'left', distance: 4});
            if (pending_feedback_audio_comment_changes())
                $('#publish_audio_comment_btn_container').effect('shake', {direction: 'left', distance: 4});
            e.preventDefault();
            e.stopImmediatePropagation();
            return false; 
        }
    });
    
    $('#feedbackModal').on('hidden.bs.modal', function() {
        stop();
    });
    
    $('#bu_feedback').click(function(e) {
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let this_data = lesson_data[lesson_offset] || {};
        jQuery.each($('.schueler_table tr'), function(i, row) {
            row = $(row);
            let email = row.data('email');
            let comment_cell = row.find('.td_comment')
            let audio_comment_cell = row.find('.td_audio_comment');
            comment_cell.empty();
            audio_comment_cell.empty();
            let printed_something_in_audio_comment_cell = false;
            let printed_something_in_text_comment_cell = false;
            if (((this_data.comments) || {})[email]) {
                if ((this_data.comments[email].audio_comment_tag || '').length > 0)
                {
                    let duration_str = duration_to_str(this_data.comments[email].duration / 1000);
                    let play_button = $('<span>').addClass('btn btn-xs btn-success').html("<i class='fa fa-play'></i>&nbsp;&nbsp;" + duration_str);
                    play_button.css('margin-right', '4px');
                    play_button.data('tag', this_data.comments[email].audio_comment_tag);
                    play_button.data('duration_str', duration_str);
                    play_button.click(function(e) {
                        if (pb_playing)
                        {
                            if ($(e.target).data('tag') !== pb_button.data('tag')) {
                                stop();
                                $(e.target)[0].dispatchEvent(new Event('click'));
                                return;
                            } else {
                                stop();
                                return;
                            }
                        }
                        pb_button = $(e.target);
                        if (pb_audio === null) {
                            pb_audio = document.createElement('audio');
                            pb_audio.setAttribute('controls', '');
                            pb_audio.controls = true;
                            pb_audio.addEventListener('play', function(e) {
                                pb_playing = true;
                                pb_button.html("<i class='fa fa-stop'></i>&nbsp;&nbsp;0:00");
                            });
                            pb_audio.addEventListener('ended', function() {
                                pb_playing = false;
                                pb_button.html("<i class='fa fa-play'></i>&nbsp;&nbsp;" + pb_button.data('duration_str'))
                            });
                            pb_audio.addEventListener('timeupdate', function(e) {
                                if (!pb_playing)
                                    return;
                                pb_button.html("<i class='fa fa-stop'></i>&nbsp;&nbsp;" + duration_to_str(pb_audio.currentTime));
                            });
                        }
                        let tag = pb_button.data('tag');
                        pb_audio.src = '/raw/uploads/audio_comment/' + tag.substr(0, 2) + '/' + tag.substr(2, tag.length - 2) + '.mp3';
                        pb_audio.play();
                    });
                    audio_comment_cell.append(play_button);
                    printed_something_in_audio_comment_cell = true;
                }
                else
                    audio_comment_cell.html('&ndash;');
                if ((this_data.comments[email].text_comment || '').length > 0)
                {
                    comment_cell.html(this_data.comments[email].text_comment);
                    printed_something_in_text_comment_cell = true;
                }
            }
            if (!printed_something_in_audio_comment_cell)
                audio_comment_cell.html('&ndash;');
            if (!printed_something_in_text_comment_cell)
                comment_cell.html('&ndash;');
        });
        $('#feedbackModal').modal('show');
    });
    
    $('#bu_stop_audio_comment').click(function(e) {
        stop();
    });
    
    $('#bu_play_audio_comment').click(function(e) {
        stop();
        playing = true;
        audio.play();
        update_feedback_buttons();
    });
    
    $('#bu_publish_audio_comment').click(function(e) {
        stop();
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let schueler = $($('.schueler_table tr.selected')[0]).data('email');
        var fd = new FormData();
        fd.append('file', audio_blob);
        fd.append('lesson_key', lesson_key);
        fd.append('schueler', schueler);
        fd.append('lesson_offset', lesson_offset);
        fd.append('duration', rec_duration);
        $.ajax({
            type: 'POST',
            url: '/api/upload_audio_comment',
            data: fd,
            processData: false,
            contentType: false
        }).done(function(data) {
            data = JSON.parse(data);
            audio = null;
            audio_blob = null;
            $('#duration').html('0:00');
            lesson_data[lesson_offset] = lesson_data[lesson_offset] || {};
            lesson_data[lesson_offset].comments = lesson_data[lesson_offset].comments || {};
            lesson_data[lesson_offset].comments[schueler] = lesson_data[lesson_offset].comments[schueler] || {};
            lesson_data[lesson_offset].comments[schueler].audio_comment_tag = data.tag;
            lesson_data[lesson_offset].comments[schueler].audio_comment_from = '#{@session_user[:email]}';
            lesson_data[lesson_offset].comments[schueler].duration = rec_duration;
            $('#bu_feedback').click();
            update_feedback_buttons();
            update_table();
        });           
    });
    
    $('#bu_delete_audio_comment').click(function(e) {
        stop();
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let schueler = $($('.schueler_table tr.selected')[0]).data('email');
        api_call('/api/delete_audio_comment', {lesson_key: lesson_key, lesson_offset: lesson_offset, schueler: schueler}, function(data) {
            if (data.success) {
                delete lesson_data[lesson_offset].comments[schueler].audio_comment_tag;
                delete lesson_data[lesson_offset].comments[schueler].audio_comment_from;
                $('#bu_feedback').click();
                update_feedback_buttons();
                update_table();
            }
        });
    });
    
    $('#bu_delete_text_comment').click(function(e) {
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let schueler = $($('.schueler_table tr.selected')[0]).data('email');
        api_call('/api/delete_text_comment', {lesson_key: lesson_key, lesson_offset: lesson_offset, schueler: schueler}, function(data) {
            if (data.success) {
                delete lesson_data[lesson_offset].comments[schueler].text_comment;
                $('#ti_feedback_comment').val('');
                $('#bu_feedback').click();
                update_feedback_buttons();
                update_table();
            }
        });
    });
    
    $('#bu_discard_audio_comment').click(function(e) {
        stop();
        audio = null;
        audio_blob = null;
        update_feedback_buttons();
        $('#duration').html('0:00');
    });
    
    $('#bu_discard_text_comment').click(function(e) {
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let schueler = $($('.schueler_table tr.selected')[0]).data('email');
        $('#ti_feedback_comment').val((((lesson_data[lesson_offset] || {}).comments || {})[schueler] || {}).text_comment || '');
        update_feedback_buttons();
    });
    
    $('#bu_publish_text_comment').click(function(e) {
        $('#ti_feedback_comment').blur();
        let lesson_offset = $($('.lesson_table tr.selected')[0]).data('lesson_offset');
        let schueler = $($('.schueler_table tr.selected')[0]).data('email');
        let comment = $('#ti_feedback_comment').val().trim();
        api_call('/api/publish_text_comment', {lesson_key: lesson_key, lesson_offset: lesson_offset, schueler: schueler, comment: comment}, function(data) { 
            if (data.success) {
                lesson_data[lesson_offset] = lesson_data[lesson_offset] || {};
                lesson_data[lesson_offset].comments = lesson_data[lesson_offset].comments || {};
                lesson_data[lesson_offset].comments[schueler] = lesson_data[lesson_offset].comments[schueler] || {};
                lesson_data[lesson_offset].comments[schueler].text_comment = comment;
                $('#ti_feedback_comment').val(comment);
                $('#bu_feedback').click();
                update_feedback_buttons();
                update_table();
            }
        });
    });
    
    $('#bu_record_audio_comment').click(function(e) {
        stop();
        $('#audio_time').show();
        $('.audio_error_warning').hide();
        if (navigator.mediaDevices.getUserMedia) {
            const constraints = { audio: true, video: false };
            chunks = [];

            let onSuccess = function(stream) {
                mediaRecorder = new MediaRecorder(stream);
                recording = true;
                mediaRecorder.start();
                rec_start_time = Date.now();
                update_rec_time_label_timeout = setInterval(update_rec_time_label, 100);
                
                update_feedback_buttons();

                mediaRecorder.onstop = function(e) {
                    stream.getTracks().forEach( track => track.stop() );
                    audio = document.createElement('audio');
                    audio.setAttribute('controls', '');
//                     $('.sound-clip').append(audio);
                    audio.controls = true;
                    $('#bu_play_audio_comment').prop('disabled', false);
                    $('#bu_play_audio_comment').removeClass('btn-outline-secondary').addClass('btn-primary');
                    audio_blob = new Blob(chunks, { 'type' : 'audio/mpeg-3' });
                    chunks = [];
                    let audioURL = window.URL.createObjectURL(audio_blob);
                    audio.src = audioURL;
                    audio.addEventListener('ended', stop);
                    audio.addEventListener('timeupdate', function(e) {
                        if (audio === null)
                            return;
                        let width = (audio.currentTime / (rec_duration / 1000)) * 100;
                        $('#audio_time .progress-bar').css('width', '' + width + '%');
                    });
                    update_feedback_buttons();
                }

                mediaRecorder.ondataavailable = function(e) {
                    chunks.push(e.data);
                }
            }

            let onError = function(err) {
                console.log('The following error occured: ' + err);
                $('#audio_time').hide();
                $('.audio_error_warning').show();
            }

            navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);
        } else {
            console.log('getUserMedia not supported on your browser!');
        }
    });
    
    $('.bu-insert-lesson-above').click(function(e) {
        e.preventDefault();
        let data = {};
        data.lesson_key = lesson_key;
        let lesson_offsets = [];
        for (i of Object.keys(row_for_lesson_offset)) {
            if (row_for_lesson_offset[i].hasClass('selected'))
                lesson_offsets.push(parseInt(i));
        }
        data.offset = lesson_offsets[0];
        data.shift = 1;
        (function(insert_above_offset, shift) {
            api_call('/api/insert_lesson', data, function(data) {
                if (data.success) {
                    let new_lesson_data = {};
                    for (let offset of Object.keys(lesson_data)) {
                        offset = parseInt(offset);
                        let new_offset = offset;
                        if (offset >= insert_above_offset)
                            new_offset += shift;
                        new_lesson_data[new_offset] = lesson_data[offset];
                    }
                    lesson_data = new_lesson_data;
                    selection_updated();
                    update_table();
                }
            });
        })(data.offset, data.shift);
    });
    
    $('.bu-insert-2-lesson-above').click(function(e) {
        e.preventDefault();
        let data = {};
        data.lesson_key = lesson_key;
        let lesson_offsets = [];
        for (i of Object.keys(row_for_lesson_offset)) {
            if (row_for_lesson_offset[i].hasClass('selected'))
                lesson_offsets.push(parseInt(i));
        }
        data.offset = lesson_offsets[0];
        data.shift = 2;
        (function(data, insert_above_offset, shift) {
            api_call('/api/insert_lesson', data, function(data) {
                if (data.success) {
                    let new_lesson_data = {};
                    for (let offset of Object.keys(lesson_data)) {
                        offset = parseInt(offset);
                        let new_offset = offset;
                        if (offset >= insert_above_offset)
                            new_offset += shift;
                        new_lesson_data[new_offset] = lesson_data[offset];
                    }
                    lesson_data = new_lesson_data;
                    selection_updated();
                    update_table();
                }
            });
        })(data, data.offset, data.shift);
    });
    
    $('.bu-delete-lesson').click(function(e) {
        e.preventDefault();
        let data = {};
        data.lesson_key = lesson_key;
        let lesson_offsets = [];
        for (i of Object.keys(row_for_lesson_offset)) {
            if (row_for_lesson_offset[i].hasClass('selected'))
                lesson_offsets.push(parseInt(i));
        }
        data.offsets = lesson_offsets;
        (function(data, lesson_offsets) {
            api_call('/api/delete_lessons', data, function(data) {
                if (data.success) {
                    let new_lesson_data = {};
                    let offsets = Object.keys(lesson_data).map(function(x) { return parseInt(x); }).sort();
                    let max = Math.max(...offsets);
                    let cumulative_shift = 0;
                    for (let offset = 0; offset <= max; offset++) {
                        if (lesson_offsets.length > 0 && lesson_offsets[0] === offset) {
                            cumulative_shift += 1;
                            lesson_offsets.shift();
                        } else {
                            if (lesson_data[offset])
                                new_lesson_data[offset - cumulative_shift] = lesson_data[offset];
                        }
                    }
                    lesson_data = new_lesson_data;
                    selection_updated();
                    update_table();
                }
            });
        })(data, data.offsets);
    });
    
    $('.bu-delete-lesson').click(function(e) {
//         e.stopPropagation();
        e.preventDefault();
    });
    
    let uri = '/gen/w/' + lesson_key_id + '/all.json.gz';
    var oReq = new XMLHttpRequest();
    oReq.open('GET', uri, true);
    oReq.responseType = 'arraybuffer';

    oReq.onload = function(oEvent) {
        let data = pako.ungzip(oReq.response);
        let bb = new Blob([new Uint8Array(data)]);
        let f = new FileReader();
        f.onload = function(e) {
            let table = $('.lesson_table');
            let events = JSON.parse(e.target.result);
            window.time_span_for_lesson_offset = {};
            let last_datum = null;
            let last_datum_odd = 0;
            let now = new Date();
            let last_before_now = null;
            for (event of events)
            {
                event.color = color_palette.primary;
                if (event.entfall)
                    event.color = color_palette.disabled;
                if (event.lesson === true)
                {
                    let before_now = (new Date(event.start)) < now;
                    if (last_before_now && (before_now === false)) {
                        let row = $('<tr>').addClass('lesson-table-info-row').addClass('today');
                        row.append($('<td>').attr('colspan', 11).html('heute'));
                        table.append(row);
                    }
                    last_before_now = before_now;
                    for (let i = 0; i < event.count; i++)
                    {
                        let lesson_offset = event.lesson_offset + i;
                        window.time_span_for_lesson_offset[lesson_offset] = {
                            datum: event.datum,
                            start_time: event.start.substr(11, 5),
                            end_time: event.end.substr(11, 5)
                        };
                        let row = $('<tr>').addClass('lesson');
                        $('<td>').html('' + (lesson_offset + 1) + '.').css('text-align', 'right').appendTo(row);
                        let d = new Date(event.datum);
                        if (last_datum !== event.datum)
                        {
                            last_datum_odd = (last_datum_odd + 1) & 1;
                            row.addClass('sep');
                            $('<td>').html(event.datum.substr(8, 2) + '.' + event.datum.substr(5, 2) + '.' + event.datum.substr(0, 4)).appendTo(row);
                            $('<td>').html(weekdays[d.getDay()]).appendTo(row);
                        }
                        else
                        {
                            $('<td>').html('').appendTo(row);
                            $('<td>').html('').appendTo(row);
                        }
                        if (last_datum_odd === 1)
                            row.addClass('odd');
                        $('<td>').html('' + (event.stunde + i) + '.').appendTo(row);
                        $('<td>').addClass('nowrap').html(event.label).appendTo(row);
                        $('<td>').addClass('tc_thema').html('').appendTo(row);
                        $('<td>').addClass('tc_stundenthema').html('').appendTo(row);
                        $('<td>').addClass('tc_lesson').html('').appendTo(row);
                        $('<td>').addClass('tc_homework').html('').appendTo(row);
                        $('<td>').addClass('tc_feedback').html('').appendTo(row);
                        $('<td>').addClass('tc_notizen').html('').appendTo(row);
                        table.append(row);
                        last_datum = event.datum;
                        row_for_lesson_offset[lesson_offset] = row;
                        row.data('lesson_offset', lesson_offset);
                        row.mousedown(function(e) {
                            if (!can_select)
                                return;
                            if (e.buttons === 1) {
                                e.preventDefault();
                                e.stopPropagation();
                                if (pending_changes) {
                                    $('.bu-save-discard-container').effect('shake', {direction: 'left', distance: 4});
                                    return;
                                }
                                let row = $(e.target).closest('tr');
                                let lesson_offset = row.data('lesson_offset');
                                if (e.shiftKey === true && cursor !== null) {
                                    let cursor_ext = lesson_offset;
                                    $('.lesson_table tr').removeClass('current');
                                    row.addClass('current');
                                    if (e.ctrlKey === false)
                                        $('.lesson_table tr').removeClass('selected');
                                    let a = Math.min(cursor, cursor_ext);
                                    let b = Math.max(cursor, cursor_ext);
                                    for (let i = a; i <= b; i++)
                                        row_for_lesson_offset[i].addClass('selected');
                                }
                                else {
                                    cursor = lesson_offset;
                                    $('.lesson_table tr').removeClass('current');
                                    row.addClass('current');
                                    if (e.ctrlKey === false) {
                                        $('.lesson_table tr').removeClass('selected');
                                        row.addClass('selected');
                                    } else {
                                        row.toggleClass('selected');
                                    }
                                }
                                selection_updated();
                            }
                        });
                        row.mouseenter(function(e) {
                            if (!can_select)
                                return;
                            if (e.buttons === 1) {
                                e.preventDefault();
                                e.stopPropagation();
                                if (pending_changes) {
                                    return;
                                }
                                let row = $(e.target).closest('tr');
                                let lesson_offset = row.data('lesson_offset');
                                let cursor_ext = lesson_offset;
                                $('.lesson_table tr').removeClass('current');
                                row.addClass('current');
                                $('.lesson_table tr').removeClass('selected');
                                let a = Math.min(cursor, cursor_ext);
                                let b = Math.max(cursor, cursor_ext);
                                for (let i = a; i <= b; i++)
                                    row_for_lesson_offset[i].addClass('selected');
                                selection_updated();
                            }
                        });
                    }
                }
                else
                {
                    let row = $('<tr>').addClass('lesson-table-info-row');
                    let t0 = event.start.substr(8, 2) + '.' + event.start.substr(5, 2) + '.';
                    let t1 = event.end.substr(8, 2) + '.' + event.end.substr(5, 2) + '.';
                    if (t0 !== t1)
                        t0 += ' &ndash; ' + t1;
                    row.append($('<td>').attr('colspan', 11).html(event.title + ' (' + t0 + ')'));
                    table.append(row);
                }
            }

            update_table();
            if (window.location.hash.length > 1) {
                let first = null;
                for (i of window.location.hash.substr(1).split(',')) {
                    let select_this = parseInt(i);
                    if (first === null)
                        first = select_this;
                    row_for_lesson_offset[select_this].addClass('selected');
                }
                selection_updated();
                if ($(window).width() >= 768) {
                    $('html, body').animate({
                        scrollTop: row_for_lesson_offset[first].position().top - 200,
                    }, 1);
                }
            }
            else
            {
                if ($('.lesson-table-info-row.today').length > 0) {
                    if ($(window.width) >= 768) {
                        $('html, body').animate({
                            scrollTop: $('.lesson-table-info-row.today').position().top - 200,
                        }, 1);
                    }
                }
            }
            can_select = true;
            selection_updated();
        };
        f.readAsText(bb);
    };
    oReq.send();
    let i = 0;
    for (let user of schueler_for_lesson) {
        schueler_info_for_email[user.email] = user;
        schueler_for_lesson_index[user.email] = i;
        i += 1;
    }
    $('#ti_lesson_jitsi_breakout_rooms_popup').click(function(e) {
        update_breakout_room_widgets();
        $('#breakoutRoomsModal').modal('show');
    });
    $('#ti_breakout_room_count').attr('max', schueler_for_lesson.length);
    $('#ti_breakout_room_count').change(function(e) {
        let count = parseInt($('#ti_breakout_room_count').val());
        if (count < 1)
            count = 1;
        if (count > schueler_for_lesson.length)
            count = schueler_for_lesson.length;
        $('#ti_breakout_room_count').val(count);
        if (count < breakout_room_config.rooms.length) {
            breakout_room_config.rooms = breakout_room_config.rooms.slice(0, count);
            for (let user of schueler_for_lesson) {
                if (breakout_room_config.participants[schueler_for_lesson_index[user.email]] >= breakout_room_config.rooms.length)
                    breakout_room_config.participants[schueler_for_lesson_index[user.email]] = breakout_room_config.rooms.length - 1;
            }
        }
        while (count > breakout_room_config.rooms.length) {
            breakout_room_config.rooms.push(`Gruppe ${breakout_room_config.rooms.length + 1}`);
        }
        update_breakout_room_widgets();
    });
//     $('#ti_lesson_jitsi_breakout_rooms').click();
    $('.bu-fewer-breakout-rooms').click(function(e) {
        let count = parseInt($('#ti_breakout_room_count').val());
        if (count > 1) {
            count -= 1;
            $('#ti_breakout_room_count').val(count);
            breakout_room_config.rooms = breakout_room_config.rooms.slice(0, -1);
            for (let user of schueler_for_lesson) {
                if (breakout_room_config.participants[schueler_for_lesson_index[user.email]] >= breakout_room_config.rooms.length)
                    breakout_room_config.participants[schueler_for_lesson_index[user.email]] = breakout_room_config.rooms.length - 1;
            }
            update_breakout_room_widgets();
        }
    });
    $('.bu-more-breakout-rooms').click(function(e) {
        let count = parseInt($('#ti_breakout_room_count').val());
        if (count < schueler_for_lesson.length) {
            count += 1;
            $('#ti_breakout_room_count').val(count);
            breakout_room_config.rooms.push(`Gruppe ${count}`);
            update_breakout_room_widgets();
        }
    });
    $('#ti_event_jitsi_breakout_rooms').click(function(e) {
        let value = $('#ti_event_jitsi_breakout_rooms').data('state');
        if (value === 'yes') {
            let count = parseInt($('#ti_breakout_room_count').val());
            breakout_room_config = {
                rooms: [],
                participants: []
            };
            for (let i = 0; i < count; i++)
                breakout_room_config.rooms.push(`Gruppe ${i + 1}`);
            let i = 0;
            for (let user of schueler_for_lesson) {
                breakout_room_config.participants.push(i);
                i = (i + 1) % breakout_room_config.rooms.length;
            }
            $('.bu-breakout-room-arrange-reuse-last').click();
        } else {
            breakout_room_config = null;
        }
        update_breakout_room_widgets();
    });
    $('#ti_breakout_rooms_roaming').click(function(e) {
        let value = $('#ti_breakout_rooms_roaming').data('state');
        if (value === 'yes') {
            breakout_room_config.roaming = true;
        } else {
            breakout_room_config.roaming = false;
        }
        update_breakout_room_widgets();
    });
    $('.bu-breakout-room-arrange-reuse-last').click(function(e) {
        let o = single_selected_offset;
        found_config = null;
        while (o > 0) {
            o -= 1;
            if (((lesson_data[o] || {}).info || {}).breakout_rooms) {
                found_config = {
                    rooms: lesson_data[o].info.breakout_rooms,
                    participants: lesson_data[o].info.breakout_room_participants,
                    roaming: lesson_data[o].info.breakout_rooms_roaming
                };
                break;
            }
        }
        if (found_config !== null) {
            found_config = sanitize_breakout_room_config(found_config);
            breakout_room_config = found_config;
            update_breakout_room_widgets();
        }
    });
    $('.bu-breakout-room-arrange-random').click(function(e) {
        let i = 0;
        for (let user of schueler_for_lesson.sort(() => Math.random() - 0.5)) {
            breakout_room_config.participants[schueler_for_lesson_index[user.email]] = i;
            i = (i + 1) % breakout_room_config.rooms.length;
        }
        update_breakout_room_widgets();
    });
    $('.bu-breakout-room-arrange-sort-first-name').click(function(e) {
        let i = 0;
        let offsets = [];
        for (let k = 0; k < schueler_for_lesson.length; k++) {
            offsets.push(i);
            i = (i + 1) % breakout_room_config.rooms.length;
        }
        offsets = offsets.sort();
        i = 0;
        for (let user of schueler_for_lesson.sort((a, b) => a.first_name.localeCompare(b.first_name))) {
            breakout_room_config.participants[schueler_for_lesson_index[user.email]] = offsets[i];
            i = i + 1;
        }
        update_breakout_room_widgets();
    });
    $('.bu-breakout-room-arrange-sort-last-name').click(function(e) {
        let i = 0;
        let offsets = [];
        for (let k = 0; k < schueler_for_lesson.length; k++) {
            offsets.push(i);
            i = (i + 1) % breakout_room_config.rooms.length;
        }
        offsets = offsets.sort();
        i = 0;
        for (let user of schueler_for_lesson.sort((a, b) => a.last_name.localeCompare(b.last_name))) {
            breakout_room_config.participants[schueler_for_lesson_index[user.email]] = offsets[i];
            i = i + 1;
        }
        update_breakout_room_widgets();
    });
    let s = [];
    for (let user of schueler_for_lesson) {
        s.push(`${user.display_name} <${user.email}>`);
    }
    $('#emailListModal textarea').val(s.join("\n"));
    $('#bu_email_list').click(function(e) {
        e.preventDefault();
        $('#emailListModal').modal('show');
    });
    for (let user of schueler_for_lesson) {
        let row = $('<tr>');
        let icon = $('<div>').addClass('icon');
        icon.append('<div>').addClass('avatar-md').css('background-image', `url(#{NEXTCLOUD_URL}/index.php/avatar/${user.nc_login}/128), url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mO88h8AAq0B1REmZuEAAAAASUVORK5CYII=)`);
        row.append($('<td>').append(icon));
        row.append($('<td>').text(user.display_name));
        let bu_add = $('<button>').addClass('btn').addClass('btn-success').addClass('btn-xs').text('Hinzufügen').data('email', user.email);
        row.append($('<td>').append(bu_add));
        $('#amt_sus_here').append(row);
        bu_add.click(function(e) {
            let email = $(e.target).closest('button').data('email');
            let amt = $('#amtModal').data('amt');
            console.log(`Adding ${email} to ${amt} amt`);
            api_call('/api/add_sus_to_amt', {lesson_key: lesson_key, amt: amt, email: email}, function(data) {
                if (data.success) {
                    $('#amtModal').modal('hide');
                    update_present_amt_rows();                    
                }
            });
        });
    }
    $('.bu-add-amt').click(function(e) {
        let amt = $(e.target).closest('button').data('amt');
        e.preventDefault();
        $('#amtModal .modal-title').text(`${amt == 'hausaufgaben' ? 'Hausaufgabenamt' : 'Materialamt'}: Schülerin oder Schüler hinzufügen`);
        $('#amtModal').data('amt', amt);
        $('#amtModal').modal('show');
    });
    update_present_amt_rows();
});
</script>
