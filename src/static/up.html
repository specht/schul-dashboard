#{require_user_with_role!(:unterstufenparty)}
<style>
    .video-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 86 / 54;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }

    video, canvas {
        max-width: 100%;
        border-radius: 8px;
    }

    #video,
    #cardPreview {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* border: 2px solid #555; */
        border-radius: 8px;
    }

    #video { display: block; }
    #cardPreview { display: none; }

    #status { margin-top: 0.5rem; font-weight: bold; }

    .video-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
    }

    .target-frame {
        aspect-ratio: 86 / 54;
        width: 85%;
        max-height: 85%;
        border: 2px dashed rgba(255,255,255,0.9);
        border-radius: 10px;
        box-shadow:
            0 0 0 1px rgba(0,0,0,0.4),
            0 0 12px rgba(0,0,0,0.6);
    }

    .target-frame.ready { display: none; }

</style>

<div class="container" style="padding-top: 15px;">
    <div class="row">
        <div class="col-md-12">
            <div class="input-group mb-3">
                <input id='ti_sus' type="text" list="people" class="form-control form-control-lg" placeholder="Suchen oder QR-Code scannen">
                <div class="input-group-append">
                    <button class="btn btn-lg btn-success" type="button" id="scanQrBtn"><i class='fa fa-qrcode'></i></button>
                </div>
            </div>
            <datalist id="people">
            </datalist>

            <div class="video-wrapper mb-3">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="cardPreview" width="1024" height="640"></canvas>
                <div class="video-overlay"><div class="target-frame ready"></div></div>
            </div>

            <div class="d-flex" style="margin-top: 1em;">
                <button id="scanCardBtn" class="btn btn-lg btn-success flex-fill mr-1"><i class='fa fa-id-card-o'></i>&nbsp;&nbsp;Rückseite scannen</button>
                <button id="scanResetBtn" class="btn btn-lg btn-secondary flex-fill ml-1"><i class='fa fa-times'></i>&nbsp;&nbsp;Reset</button>
            </div>

            <div id="status">Initializing…</div>

            <div class="d-flex" style="margin-top: 4em;">
                <button id='bu_checkin' disabled class="btn btn-lg btn-success flex-fill mr-1"><i class='fa fa-sign-in'></i>&nbsp;&nbsp;Check-in</button>
                <button id='bu_checkout' disabled class="btn btn-lg btn-danger flex-fill ml-1"><i class='fa fa-sign-out'></i>&nbsp;&nbsp;Check-out</button>
            </div>
        </div>
    </div>
</div>

<script src="/include/opencv/opencv.js"></script>
<script>
    var is_safari = false;
</script>
<script type="module">
    import { CardScanner } from "./include/card-scanner.js";
    import { QrScanner } from "./include/qr-scanner.js";
    let sound = new SoundPlayer();

    const videoEl = document.getElementById("video");
    const cardPreview = document.getElementById("cardPreview");
    const statusEl = document.getElementById("status");
    const targetFrame = document.querySelector(".target-frame");

    const up_sus_list = #{up_sus_list.to_json};
    let up_sus_map = {};
    let up_sus_email_for_code = {};

    let got_email = null;
    let got_card = null;
    let got_info = null;

    const sorted_sus = [...up_sus_list].sort((a, b) =>
        a.display_name.localeCompare(b.display_name, undefined, { sensitivity: 'base' })
    );
    for (let sus of sorted_sus) {
        up_sus_map[sus.email] = sus;
        up_sus_email_for_code[sus.code] = sus.email;
        let option = $('<option>').attr('value', `${sus.display_name} (${sus.klasse})`).attr('data-email', sus.email);
        $('#people').append(option);
    }

    let mode = null;
    let cardScanner = null;
    let qrScanner = null;

    function showLive() {
        videoEl.style.display = "block";
        cardPreview.style.display = "none";
        targetFrame.style.display = "flex";
    }

    function showCapture() {
        videoEl.style.display = "none";
        cardPreview.style.display = "block";
        targetFrame.style.display = "none";
    }

    function stopAll() {
        if (cardScanner) cardScanner.stop();
        if (qrScanner) qrScanner.stop();
    }

    async function uploadCardCanvas(canvas) {
        // Update status
        statusEl.textContent = "Uploading…";

        // Wrap toBlob in a Promise so we can await it
        const blob = await new Promise((resolve, reject) => {
            canvas.toBlob(
                (b) => b ? resolve(b) : reject(new Error("Canvas toBlob failed")),
                "image/jpeg",
                0.9 // quality 0–1
            );
        });

        const formData = new FormData();
        formData.append("card", blob, "card.jpg");

        console.log(blob);

        // Adjust URL to your backend route
        const response = await fetch("/api/up_upload_image", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            throw new Error("Upload failed: " + response.status);
        }

        const result = await response.json().catch(() => null);

        statusEl.textContent = "Upload finished.";
        return result;
    }


    // --- Card scanner setup ---
    cardScanner = new CardScanner({
        videoEl,
        previewCanvas: cardPreview,
        statusEl,
        sharpnessThreshold: 150,
        scanIntervalMs: 400,
        onGoodCapture: async () => {
            sound.play('snapshot');
            showCapture();
            mode = null;
            let result = await uploadCardCanvas(cardPreview);
            got_card = result.sha1;
            update_status();
        }
    });
    cardScanner.attachTapToFocus();

    // --- QR scanner setup ---
    qrScanner = new QrScanner({
        videoEl,
        previewCanvas: cardPreview,
        statusEl,
        scanIntervalMs: 200,
        onResult: ({ text }) => {
            sound.play('scan');
            statusEl.textContent = "QR: " + text;
            let info = up_sus_map[up_sus_email_for_code[text]];
            $('#ti_sus').val(`${info.display_name} (${info.klasse})`);
            got_email = info.email;
            update_status();
            // showCapture();
            mode = null;
        }
    });
    qrScanner.attachTapToFocus();

    // --- UI buttons ---
    document.getElementById("scanCardBtn").addEventListener("click", async () => {
        got_card = null;
        update_status();
        stopAll();
        mode = "card";
        showLive();
        await cardScanner.start();
    });

    document.getElementById("scanQrBtn").addEventListener("click", async () => {
        stopAll();
        mode = "qr";
        showLive();
        $('#ti_sus').val('');
        got_email = null;
        got_card = null;
        update_status();
        await qrScanner.start();
    });

    function stopCamera() {
        stopAll();
        mode = null;
        showLive();
        statusEl.textContent = "Stopped.";
    }

    // Reset view only
    document.getElementById("scanResetBtn").addEventListener("click", () => {
        stopCamera();
        $('#ti_sus').val('');
        got_email = null;
        got_card = null;
        update_status();
    });

    const options = document.querySelectorAll('#people option');

    $('#ti_sus')[0].addEventListener('click', () => {
        stopCamera();
        $('#ti_sus').val('');
        got_email = null;
        got_card = null;
        update_status();
    });
    $('#ti_sus')[0].addEventListener('input', () => {
        const opt = Array.from(options).find(o => o.value === $('#ti_sus').val());
        if (opt) {
            let email = opt.dataset.email;
            got_email = email;
            update_status();
            $('#ti_sus').blur();

        } else {
            got_email = null;
            got_card = null;
            update_status();
        }
    });

    async function update_status() {
        console.log("Got email:", got_email, "Got card:", got_card);
        if (got_email !== null && got_card !== null) {
            let info = got_info || {};
            if (info.email !== got_email) {
                api_call('/api/up_get_info_for_email', { email: got_email }, function(data) {
                    if (data.success) {
                        got_info = data;
                        console.log("Got info from email:", got_info);
                        $('#bu_checkin').attr('disabled', false);
                        $('#bu_checkout').attr('disabled', got_info.up_checked_in === null);
                    } else {
                        got_info = null;
                        $('#bu_checkin').attr('disabled', false);
                        $('#bu_checkout').attr('disabled', true);
                    }
                });
            }
        } else {
            $('#bu_checkin').attr('disabled', true);
            $('#bu_checkout').attr('disabled', true);
            got_info = null;
        }
        console.log("Got info:", got_info);
    }

    // Initial state
    showLive();
    statusEl.textContent = "Ready.";
</script>
