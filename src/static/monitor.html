#{require_monitor_or_user_who_can_manage_monitors!}
<style>
    .navbar, .foot {
        display: none;
    }

    body {
        padding-top: 0;
        overflow: hidden;
        color: #{color_palette[:contrast]};
        background: none;
        background-color: #{color_scheme[0] == 'd' ? '#080808' : '#fff'};
    }

    .main_sek {
        display: none;
    }

    .main_lz {
        display: none;
    }

    .container-fluid {
        padding: 2vw 1vw;
        padding-top: 1vw;
    }

    .main > div {
        width: 24.5vw;
        padding: 0 1vw;
        /* position: absolute; */
    }

    .main_sek_left > .wrapper > div {
        width: 49vw;
        padding: 0 1vw;
    }

    .main_sek_right > .wrapper > div {
        width: 49vw;
        padding: 0 1vw;
    }

    .main_lz_left > .wrapper > div {
        width: 49vw;
        padding: 0 1vw;
    }

    .main_lz_right > .wrapper > div {
        width: 49vw;
        padding: 0 1vw;
    }

    .klasse {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 0.7vw;
        box-shadow: 0 0 0.5vw rgba(0, 0, 0, 0.4);
        padding: 1vw 2vw;
        margin: 1vw 0;
        position: relative;
        color: #{color_palette[:darker]};
        transition: background-color 1000ms linear;
    }

    .klasse.highlight {
        background-color: rgba(250, 211, 28, 0.9);
        transition: background-color 1000ms linear;
    }

    .main .klasse {
        height: 6.2vw;
    }

    .klasse.k11, .klasse.k12 {
        height: 13.37vw;
    }

    .klasse.k12 {
        /* display:  none; */
    }

    h3 {
        user-select: none;
        font-size: 1.2vw;
        font-weight: bold;

        position: relative;
        background-color: #fff;
        display: inline-block;
        width: 2.8vw;
        height: 2.8vw;
        border-radius: 1.2vw;
        left: -3.2vw;
        top: -1.5vw;
        box-shadow: 0 0 0.4vw rgba(0, 0, 0, 0.4);
        text-align: center;
        padding-top: 0.7vw;
    }

    .row {
        margin: 0;
    }

    .ticker {
        user-select: none;
        position: absolute;
        bottom: -0.5vw;
        font-size: 2.5vw;
        padding: 1vw 1vw;
        overflow-x: hidden;
        white-space: nowrap;
    }

    .ticker-photo-bg {
        background-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 1vh rgba(0,0,0,0.6);
    }

    .ticker-photo-bg .ticker-message {
        color: #222;
    }

    .ticker-message {
        position: relative;
    }

    .ticker-message span:after {
        content: '+++';
        display: inline-block;
        margin: 0 2vw;
    }

    .ticker-message span.empty:after {
        content: '';
        display: inline-block;
        margin: 0 2vw;
    }

    .attribution {
        position: absolute;
        bottom: 5vw;
        left: 98.45vw;
        color: #{color_palette[:contrast]};
        font-size: 0.9vw;
        text-align: left;
        /* border: 1px solid red; */
        white-space: pre;
        transform-origin: 0 0;
        transform: rotate(-90deg);
        user-select: none;
    }

    .main .content {
        position: absolute;
        left: 2vw;
        top: 0vw;
        bottom: 0vw;
        right: 0.5vw;
        overflow: hidden;
    }

    .main_sek_left .content, .main_sek_right .content {
        position: relative;
        top: -4.4vw;
        margin-bottom: -5vw;
    }

    .main_lz_left .content, .main_lz_right .content {
        position: relative;
        top: -4.4vw;
        margin-bottom: -5vw;
    }

    .content {
        /* border: 1px solid red; */
    }

    .content table {
        width: 100%;
        background: none;
        position: relative;
        margin-top: 0.2vw;
        /* border: 1px solid red; */
    }

    .content table td {
        /* border: 1px solid red; */
        font-size: 1.05vw;
        padding: 0 0.5vw;
        user-select: none;
    }

    .content table td.vertretungs_text {
        position: relative;
        top: -0.3vw;
    }

    .content table td s {
        margin-right: 0.5vw;
    }

    .embed-responsive-item {
        background-image: url(/gen/bg/bg-#{color_scheme}.jpg);
        background-color: #{color_scheme[0] == 'l' ? '#f8f8f8' : '#080808'};
        background-repeat: no-repeat;
        background-size: 100vw;
        background-position: 50% 0%;
    }
    
    .main_sek_left {
        /* border: 1px solid red; */
        width: 50vw;
        position: absolute;
        left: -0.5vw;
        top: 1vw;
        bottom: 5vw;
        padding: 0 0.5vw 1.5vw 0.5vw;
    }

    .main_sek_left::-webkit-scrollbar {
        display: none;
    }
    .main_sek_left {
        overflow: scroll;
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .main_sek_left > div {
        padding: 0 1vw;
    }

    .main_sek_right {
        /* border: 1px solid red; */
        width: 50vw;
        position: absolute;
        left: 48.5vw;
        top: 1vw;
        bottom: 5vw;
        padding: 0 0.5vw 1.5vw 0.5vw;
    }

    .main_sek_right::-webkit-scrollbar {
        display: none;
    }
    .main_sek_right {
        overflow: scroll;
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }


    .main_sek td {
        vertical-align: top;
    }

    .main_sek_right > div {
        padding: 0 1vw;
    }

    .main_sek td:nth-child(1) {
        width: 4vw!important;
    }

    .main_sek td:nth-child(2) {
        width: 6vw!important;
    }

    .main_sek td:nth-child(3) {
        width: 6vw!important;
    }

    .main_sek td:nth-child(4) {
        width: 6vw!important;
    }

    .main_sek td:nth-child(5) {
        width: 8vw!important;
    }

    .main_lz_left {
        /* border: 1px solid red; */
        width: 50vw;
        position: absolute;
        left: -0.5vw;
        top: 8.5vw;
        bottom: 5vw;
        padding: 0 0.5vw 1.5vw 0.5vw;
    }

    .main_lz_left::-webkit-scrollbar {
        display: none;
    }
    .main_lz_left {
        overflow: scroll;
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .main_lz_left > div {
        padding: 0 1vw;
    }

    .main_lz_right {
        /* border: 1px solid red; */
        width: 50vw;
        position: absolute;
        left: 48.5vw;
        top: 8.5vw;
        bottom: 5vw;
        padding: 0 0.5vw 1.5vw 0.5vw;
    }

    .main_lz_right::-webkit-scrollbar {
        display: none;
    }
    .main_lz_right {
        overflow: scroll;
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .main_lz td {
        vertical-align: top;
    }

    .main_lz_right > div {
        padding: 0 1vw;
    }

    .main_lz td:nth-child(1) {
        width: 4vw!important;
    }

    .main_lz td:nth-child(2) {
        width: 6vw!important;
    }

    .main_lz td:nth-child(3) {
        width: 6vw!important;
    }

    .main_lz td:nth-child(4) {
        width: 6vw!important;
    }

    .main_lz td:nth-child(5) {
        width: 8vw!important;
    }

    .wrapper {
        position: absolute;
        /* width: 100%; */
        /* height: 100%; */
        /* border: 1px solid red; */
        /* width: 50vw; */
        padding: 0 1vw;
    }

    .main_lz .heading {
        position: fixed;
        top: 0.8vw;
        text-align: center;
        width: 47vw;
        left: 2vw;
    }

    .main_lz .heading .la_date {
        display: inline-block;
        font-size: 1vw;
        font-weight: bold;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 2vw;
        padding: 0 0.8vw;
        /* box-shadow: 0 0 0.5vw rgba(0, 0, 0, 0.3); */
    }

    .main_lz .heading .la_shorthands {
        display: inline-block;
        font-size: 1vw;
        font-weight: bold;
        /* overflow: scroll;    */
        /* white-space: nowrap; */
        width: 48vw;
        position: relative;
        left: -2vw;
        top: 0.5vw;
        /* background-color: rgba(255, 255, 255, 0.8); */
        /* border-radius: 2vw; */
        /* padding: 0 0.8vw; */
        /* box-shadow: 0 0 0.5vw rgba(0, 0, 0, 0.3); */
        /* border: 1px solid red; */
    }

    .main_lz .heading .la_shorthands::-webkit-scrollbar {
        display: none;
    }
    .main_lz .heading .la_shorthands {
        overflow: scroll;
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    .la_shorthands h3 {
        position: unset;
        margin-right: 0.2vw;
        width: 1.4vw;
        height: 1.4vw;
        font-size: 0.7vw;
        padding-top: 0.3vw;
        border-radius: 0.55vw;
        display: inline-block;
        margin: 0.07vw;
        font-weight: normal;
        background-color: rgba(255,255,255,0.5);
        box-shadow: none;
    }

    .la_shorthands h3.highlight{
        font-weight: bold;
        background-color: #fff;
        cursor: pointer;
    }

    .main_lz div:nth-child(2) .heading {
        left: 51vw;
    }

    .monitor_advent_calendar {
        /* border: 1px solid red; */
        position: absolute;
        left: 2vw;
        bottom: -0.1vw;
        width: 23vw;
        height: 4.5vw;
    }
    .monitor_advent_calendar img {
        background-color: #023;
        /* image-rendering: pixelated; */
        /* -ms-interpolation-mode: nearest-neighbor;  */
        width: 3.7vw;
        height: 3.7vw;
        margin-left: 0.5vw;
        border-radius: 0.2vw;
    }

    .ticker {
        /*left: #{advents_calendar_date_today < 0 ? '0' : '24.5'}vw;*/
    }

    .image_container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        transition: opacity 3s linear;
    }
</style>

<div class="embed-responsive embed-responsive-16by9">
    <div class='embed-responsive-item'>
        <div class='container-fluid main row'>
        </div>
        <div class='container-fluid main_sek row'>
            <div class='main_sek_left'>
                <div class='wrapper'>
                    <div></div>
                    <!-- <div style='position: absolute; top: 0; left: 25.5vw;'></div> -->
                </div>
            </div>
            <div class='main_sek_right'>
                <div class='wrapper'>
                    <div></div>
                    <!-- <div style='position: absolute; top: 0; left: 25.5vw;'></div> -->
                </div>
            </div>
        </div>
        <div class='container-fluid main_lz row'>
            <div class='main_lz_left'>
                <div class='heading'><div class='la_today la_date'></div><div class='la_today_shorthands la_shorthands'></div></div>
                <div class='wrapper'>
                    <div></div>
                </div>
            </div>
            <div class='main_lz_right'>
                <div class='heading'><div class='la_tomorrow la_date'></div><div class='la_tomorrow_shorthands la_shorthands'></div></div>
                <div class='wrapper'>
                    <div></div>
                </div>
            </div>
        </div>
        <div class='attribution'><span class='color_scheme'></span><span style='margin: 0 0.5em;'>//</span>Stand: <span class='monitor_timestamp'></span></div>
        <div class='monitor_advent_calendar' style='display: none;'>#{print_current_monitor_advent_calendar_images()}</div>
        <div class='image_container ic_back' style='display: none;'>
        </div>
        <div class='image_container ic_front' style='display: none;'>
        </div>
        <div class='container-fluid ticker row'>
            <div class='ticker-message'></div>
        </div>
    </div>
</div>

<script>
    var monitor_mode = 'public';
    var top_delay = 5.0;
    var bottom_delay = 2.0;
    var klassen = #{ KLASSEN_ORDER.to_json };
    var klassen_tr = #{ KLASSEN_TR.to_json };
    var shorthand_order = #{ @@shorthand_order.to_json };
    var real_shorthands = shorthand_order.filter((x) => x.charAt(0) != '_' );
    var attribution = #{@@color_scheme_info[color_scheme[0, 19]].to_json};
    var klassen_div = {};
    var klassen_animation_config = {};
    var last_timestamp = 0.0;
    var ticker_offset = 0.0;
    var scroll_down_speed = 1.0;
    var scroll_up_speed = 10.0;
    var ticker_speed = 6.0;
    var ticker_div = null;
    var ticker_messages = [];
    var ticker_index = 0;
    var images = [];
    var image_index = 0;
    var image_swap_timer = null;
    var klassen_tr = #{KLASSEN_TR.to_json};
    var server_time_diff = 0;

    var ws = null;
    var ws_timer_id = null;
    var last_vplan_timestamp = null;

    function js_time() {
        return Math.floor(Date.now() / 1000.0) + 999999;
    }

    function server_time() {
        return js_time() + server_time_diff;
    }

    function keep_alive() {
        var timeout = 20000;
        if (ws.readyState == ws.OPEN) {
            ws.send('');
        }
        (function() {
            ws_timer_id = setTimeout(keep_alive, timeout);
        })();
    }

    function append_vplan_table(div, data, long) {
        if (typeof(long) == 'undefined')
            long = false;
        let table = $('<table>');
        div.append(table);
        let first_entry = true;
        for (let entry of data) {
            let row = $('<tr>').appendTo(table);
            if (!first_entry)
                row.css('border-top', '1px solid rgba(0,0,0,0.3)')
            first_entry = false;
            if (entry.type === 'extra') {
                row.append($("<td colspan='5'>").html(`${entry.salzh_sus_label}`));
            } else {
                row.append($('<td>').css('width', '4vw').html(`<b>${entry.stunde_label}</b>`));
                if (entry.klassen_alt) entry.klassen_alt = entry.klassen_alt.map(function(x) { return klassen_tr[x] || x; });
                if (entry.klassen_neu) entry.klassen_neu = entry.klassen_neu.map(function(x) { return klassen_tr[x] || x; });
                row.append($('<td>').html(gen_label_arr(entry.klassen_alt, entry.klassen_neu)));
                if ((entry.fach_neu || '').substring(0, 5) === 'Test-') {
                    row.append($('<td>').html(gen_label(entry.fach_alt, 'Testung')));
                    row.append($('<td>'));
                } else {
                    row.append($('<td>').html(gen_label(entry.fach_alt, entry.fach_neu)));
                    row.append($('<td>').html(gen_label_arr(entry.lehrer_alt, entry.lehrer_neu)));
                }
                if (long) {
                    row.append($('<td>').html(gen_label(entry.raum_alt, entry.raum_neu)));
                } else {
                    row.append($('<td>').css('text-align', 'right').html(gen_label(entry.raum_alt, entry.raum_neu)));
                }
                if (long) {
                    row.append($('<td>').text(entry.vertretungs_text));

                } else {
                    if (entry.vertretungs_text) {
                        let row = $('<tr>').appendTo(table);
                        row.append($('<td>'));
                        let cell = $('<td>').addClass('vertretungs_text').attr('colspan', '4');
                        cell.append($('<span>').text(entry.vertretungs_text));
                        row.append(cell);
                    }
                }
            }
        }
    }

    function interrupt_on_scroll(selector, key) {
        for (let event of ['mousewheel', 'touchmove', 'wheel'])
            $(selector).bind(event, function(e) {
                klassen_animation_config[key].phase = 0;
                klassen_animation_config[key].timestamp = last_timestamp + top_delay;
            });
    }

    function setup_ws(ws)
    {
        ws.onopen = function() {
            console.log('ws.onopen');
            keep_alive();
        }

        ws.onclose = function() {
            console.log('ws.onclose');
            clearTimeout(ws_timer_id);
            // try to re-establish connection in 10 seconds
            setTimeout(establish_websocket_connection, 10000);
        }

        ws.onmessage = function(msg) {
            data = JSON.parse(msg.data);
            console.log(data.command);
            if (data.command == 'force_reload') {
                /* $('.embed-responsive-item')[0].requestFullscreen(); */
                window.location.reload();
            } else if (data.command == 'update_time') {
                server_time_diff = data.time - js_time();
            } else if (data.command == 'update_monitor_messages') {
                console.log(data);
                ticker_messages = data.data.messages;
                images = data.data.images;
                image_index = 0;
                refresh_images();
            } else if (data.command == 'update_vplan') {
                if (data.timestamp !== last_vplan_timestamp) {
                    last_vplan_timestamp = data.timestamp;
                    data = data.data;
                    let today = data.today;
                    let tomorrow = data.tomorrow;
                    data_today = data.data[data.today];
                    data_tomorrow = data.data[data.tomorrow];
                    $('.monitor_timestamp').text(moment(data_today.vplan_timestamp).format('dddd, D.M.Y, LT [Uhr]'));
                    if (monitor_mode === 'public') {
                        for (let klasse of klassen) {
                            let div = klassen_div[klasse];
                            div.empty();
                            if (data_today.klassen[klasse]) {
                                append_vplan_table(div, data_today.klassen[klasse]);
                                install_auto_scroller(klasse, div, div.find('table')[0]);
                            }
                        }
                    }

                    if (monitor_mode === 'sekretariat') {
                        $('.main_sek_left > .wrapper > div').empty();
                        let l = $('.main_sek_left > .wrapper > div')[0];
                        // let r = $('.main_sek_left > .wrapper > div')[1];
                        for (let klasse of klassen) {
                            if (data_today.klassen[klasse]) {
                                let box = $('<div>');
                                let div = $('<div>').addClass('klasse').appendTo(box);
                                div.append($('<h3>').text(`${klassen_tr[klasse] || klasse}`))
                                let content = $('<div>').addClass('content').appendTo(div);
                                // if ($(l).height() <= $(r).height())
                                    $(l).append(box);
                                // else
                                    // $(r).append(box);
                                append_vplan_table(content, data_today.klassen[klasse], true);
                            }
                        }
                        install_auto_scroller_continuous('sus', $('.main_sek_left')[0], $('.main_sek_left > .wrapper')[0]);
                        interrupt_on_scroll('.main_sek_left', 'sus');

                        $('.main_sek_right > .wrapper > div').empty();
                        l = $('.main_sek_right > .wrapper > div')[0];
                        // r = $('.main_sek_right > .wrapper > div')[1];
                        for (let shorthand of shorthand_order) {
                            if (data_today.lehrer[shorthand] && data_today.lehrer[shorthand].length > 0) {
                                let box = $('<div>');
                                let div = $('<div>').addClass('klasse').appendTo(box);
                                div.append($('<h3>').text(shorthand))
                                let content = $('<div>').addClass('content').appendTo(div);
                                // if ($(l).height() <= $(r).height())
                                    $(l).append(box);
                                // else
                                    // $(r).append(box);
                                append_vplan_table(content, data_today.lehrer[shorthand], true);
                            }
                        }
                        install_auto_scroller_continuous('lehrer', $('.main_sek_right')[0], $('.main_sek_right > .wrapper')[0]);
                        interrupt_on_scroll('.main_sek_right', 'lehrer');
                    }

                    if (monitor_mode === 'lehrerzimmer') {
                        $('.la_today').text(moment(today).format('dddd, D.M.Y'));
                        $('.la_tomorrow').text(moment(tomorrow).format('dddd, D.M.Y'));
                        $('.la_today_shorthands').empty();
                        $('.main_lz_left > .wrapper > div').empty();
                        let l = $('.main_lz_left > .wrapper > div')[0];
                        for (let shorthand of real_shorthands) {
                            let e = $('<h3>').text(shorthand);
                            $('.la_today_shorthands').append(e);
                            if (data_today.lehrer[shorthand] && data_today.lehrer[shorthand].length > 0) {
                                e.addClass('highlight');
                                e.data('shorthand', shorthand);
                                e.click(function(e) {
                                    let shorthand = $(e.target).closest('h3').data('shorthand');
                                    console.log(`scroll to ${shorthand}`);
                                    let boxes = $('.main_lz_left .box-teacher-' + shorthand);
                                    let current_scroll = $('.main_lz_left').scrollTop();
                                    let best_top = null;
                                    let best_box = null;
                                    for (let box of boxes) {
                                        let top = $(box).position().top - 100;
                                        if (best_top === null) {
                                            best_top = top;
                                            best_box = box;
                                        }
                                        if (Math.abs(top - current_scroll) < Math.abs(best_top - current_scroll)) {
                                            best_top = top;
                                            best_box = box;
                                        }
                                    }
                                    klassen_animation_config['sus'].phase = 0;
                                    klassen_animation_config['sus'].timestamp = last_timestamp + top_delay;
                                    $('.main_lz_left').animate({ scrollTop: best_top }, 1000);
                                    $(best_box).addClass('highlight');
                                    setTimeout(function() { $(best_box).removeClass('highlight');}, 5000);
                                });
                                let box = $('<div>');
                                let div = $('<div>').addClass('klasse').appendTo(box);
                                div.addClass('box-teacher-' + shorthand);
                                div.append($('<h3>').text(shorthand))
                                let content = $('<div>').addClass('content').appendTo(div);
                                $(l).append(box);
                                append_vplan_table(content, data_today.lehrer[shorthand], true);
                            }
                        }
                        install_auto_scroller_continuous('sus', $('.main_lz_left')[0], $('.main_lz_left > .wrapper')[0]);
                        interrupt_on_scroll('.main_lz_left', 'sus');

                        $('.la_tomorrow_shorthands').empty();
                        $('.main_lz_right > .wrapper > div').empty();
                        l = $('.main_lz_right > .wrapper > div')[0];
                        for (let shorthand of real_shorthands) {
                            let e = $('<h3>').text(shorthand);
                            $('.la_tomorrow_shorthands').append(e);
                            if (data_tomorrow.lehrer[shorthand] && data_tomorrow.lehrer[shorthand].length > 0) {
                                e.addClass('highlight');
                                e.data('shorthand', shorthand);
                                e.click(function(e) {
                                    let shorthand = $(e.target).closest('h3').data('shorthand');
                                    console.log(`scroll to ${shorthand}`);
                                    let boxes = $('.main_lz_right .box-teacher-' + shorthand);
                                    let current_scroll = $('.main_lz_right').scrollTop();
                                    let best_top = null;
                                    let best_box = null;
                                    for (let box of boxes) {
                                        let top = $(box).position().top - 100;
                                        if (best_top === null) {
                                            best_top = top;
                                            best_box = box;
                                        }
                                        if (Math.abs(top - current_scroll) < Math.abs(best_top - current_scroll)) {
                                            best_top = top;
                                            best_box = box;
                                        }
                                    }
                                    klassen_animation_config['lehrer'].phase = 0;
                                    klassen_animation_config['lehrer'].timestamp = last_timestamp + top_delay;
                                    $('.main_lz_right').animate({ scrollTop: best_top }, 1000);
                                    $(best_box).addClass('highlight');
                                    setTimeout(function() { $(best_box).removeClass('highlight');}, 5000);
                                });
                                let box = $('<div>');
                                let div = $('<div>').addClass('klasse').appendTo(box);
                                div.addClass('box-teacher-' + shorthand);
                                div.append($('<h3>').text(shorthand))
                                let content = $('<div>').addClass('content').appendTo(div);
                                $(l).append(box);
                                append_vplan_table(content, data_tomorrow.lehrer[shorthand], true);
                            }
                        }
                        install_auto_scroller_continuous('lehrer', $('.main_lz_right')[0], $('.main_lz_right > .wrapper')[0]);
                        interrupt_on_scroll('.main_lz_right', 'lehrer');
                    }
                }
            }
        }
    }

    function establish_websocket_connection() {
        var ws_uri = (location.protocol == 'http:' ? 'ws://' : 'wss://') + location.host + '/ws_monitor';
        ws = new WebSocket(ws_uri);
        setup_ws(ws);
    }

    function animation_step(timestamp) {
        timestamp *= 0.001;
        let diff = timestamp - last_timestamp;
        for (let klasse in klassen_animation_config) {
            let config = klassen_animation_config[klasse];
            if (config.type === 'elevator') {
                if (config.phase == 0) {
                    config.position += diff * scroll_down_speed;
                    if (config.position > config.range) {
                        config.position = config.range;
                        config.phase = 1;
                        config.timestamp = timestamp + bottom_delay;
                    }
                } else if (config.phase == 1) {
                    if (timestamp >= config.timestamp)
                        config.phase = 2;
                } else if (config.phase == 2) {
                    config.position -= diff * scroll_up_speed;
                    if (config.position < 0.0) {
                        config.position = 0.0;
                        config.phase = 3;
                        config.timestamp = timestamp + top_delay;
                    }
                } else if (config.phase == 3) {
                    if (timestamp >= config.timestamp)
                        config.phase = 0;
                }
                $(klassen_animation_config[klasse].table).css('top', `-${config.position}vw`);
            } else if (config.type === 'continuous') {
                if (config.phase == 0) {
                    if (timestamp >= config.timestamp) {
                        config.phase = 1;
                        let top = $(klassen_animation_config[klasse].parent).scrollTop();
                        config.position = top * 100.0 / window.innerWidth;
                    }
                } else if (config.phase == 1) {
                    config.position += diff * scroll_down_speed;
                    while (config.position > config.range && config.range > 0)
                        config.position -= config.range;
                    let top = config.position / 100.0 * window.innerWidth;
                    $(klassen_animation_config[klasse].parent).scrollTop(top);
                }
            }
        }
        if ($('.ticker-message span').length > 0) {
            let message_width = $('.ticker-message span').first().width() * 100.0 / window.innerWidth;
            if (message_width < 1.0)
                message_width = 1.0;
            ticker_offset += diff * ticker_speed;
            while (ticker_offset > message_width && ticker_offset >= 0) {
                $('.ticker-message span').first().remove();
                ticker_offset -= message_width;
            }
            $('.ticker-message').css('left', `-${ticker_offset}vw`);
        }
        while ($('.ticker-message').width() + $('.ticker-message').position().left < window.innerWidth) {
            if (ticker_messages.length > 0) {
                ticker_index %= ticker_messages.length;
                $('<span>').text(ticker_messages[ticker_index]).appendTo($('.ticker-message'));
                ticker_index = (ticker_index + 1) % ticker_messages.length;
            } else {
                $('<span>').addClass('empty').appendTo($('.ticker-message'));
            }
        }

        last_timestamp = timestamp;
        window.requestAnimationFrame(animation_step);
    }

    function gen_label_arr(alt, neu) {
        let label = '';
        if (alt)
            label += `<s>${alt.join(', ')}</s>`;
        if (neu)
            label += `<b>${neu.join(', ')}</b>`;
        return label;
    }

    function gen_label(alt, neu) {
        let label = '';
        if (alt)
            label += `<s>${alt}</s>`;
        if (neu)
            label += `<b>${neu}</b>`;
        return label;
    }

    function install_auto_scroller(klasse, parent, child) {
        parent = $(parent);
        child = $(child);
        let child_height = child.height() * 100.0 / window.innerWidth;
        let parent_height = parent.height() * 100.0 / window.innerWidth;
        console.log(child_height, parent_height);
        if (child_height > parent_height) {
            let diff = child_height - parent_height;
            klassen_animation_config[klasse] = {
                type: 'elevator',
                range: diff,
                phase: 2,
                timestamp: top_delay,
                position: 0,
                table: child[0],
            };
        }
    }

    function install_auto_scroller_continuous(klasse, parent, child) {
        parent = $(parent);
        child = $(child);
        let child_height = child.height() * 100.0 / window.innerWidth;
        let parent_height = parent.height() * 100.0 / window.innerWidth;
        console.log(child_height, parent_height);
        if (child_height > parent_height) {
            let html = child.find('div').html();
            child.append(html);
            let diff = child_height - 1.0;
            klassen_animation_config[klasse] = {
                type: 'continuous',
                range: diff,
                phase: 0,
                timestamp: 0,
                position: 0,
                table: child[0],
                parent: parent,
            };
        }
    }

    function refresh_images() {
        if (monitor_mode !== 'public')
            return;
        let div_bg = $('.image_container.ic_back');
        let div_fg = $('.image_container.ic_front');
        if (images.length === 0) {
            $('.ticker').removeClass('ticker-photo-bg');
            div_bg.css('background-image', 'none');
            div_fg.css('background-image', 'none');
            div_bg.hide();
            div_fg.hide();
            if (image_swap_timer !== null) {
                clearInterval(image_swap_timer);
                image_swap_timer = null;
            }
        } else {
            $('.ticker').addClass('ticker-photo-bg');
            div_bg.css('background-image', `url(/gen/i/${images[image_index]}-2048.jpg)`);
            div_fg.css('background-image', `none`);
            div_fg.css('opacity', 0.0);
            div_bg.show();
            div_fg.show();
            image_swap_timer = setInterval(function() {
                if (images.length > 1) {
                    image_index = (image_index + 1) % images.length;
                    div_fg.css('background-image', `url(/gen/i/${images[image_index]}-2048.jpg)`);
                    div_fg.css('opacity', 1.0);
                    setTimeout(function() {
                        div_bg.css('background-image', `url(/gen/i/${images[image_index]}-2048.jpg)`);
                        div_fg.css('opacity', 0.0);
                    }, 4000);
                }
            }, 30000)
        }
    }

    window.addEventListener('load', function () {
        if (#{@session_user[:email] == "monitor-sek@#{SCHUL_MAIL_DOMAIN}"} || window.location.pathname === '/monitor/sek') {
            monitor_mode = 'sekretariat';
            $('.main').hide();
            $('.main_sek').show();
        }
        else if (#{@session_user[:email] == "monitor-lz@#{SCHUL_MAIL_DOMAIN}"} || window.location.pathname === '/monitor/lz') {
            monitor_mode = 'lehrerzimmer';
            $('.main').hide();
            $('.main_lz').show();
        }
        /* else { */
            /* if (#{advents_calendar_date_today() || -1} >= 0) */
                /* $('.monitor_advent_calendar').show(); */
        /* } */
        establish_websocket_connection();
        let a = `<b>»${attribution[0]}«</b>`;
        if (attribution[1])
            a += ` von <b>${attribution[1]}</b>`;
        $('.color_scheme').html(a);
        moment.locale('de');
        let col = null;
        let i = 0;
        for (let klasse of klassen) {
            if (i % 7 == 0) {
                col = $('<div>');
                col.appendTo($('.main'));
            }
            let box = $('<div>');
            let div = $('<div>').addClass('klasse').addClass(`k${klasse}`).appendTo(box);
            div.append($('<h3>').text(`${klassen_tr[klasse] || klasse}`))
            let content = $('<div>').addClass('content').appendTo(div);
            klassen_div[klasse] = content;
            col.append(box);
            i += 1;
        }
        window.requestAnimationFrame(animation_step);
    });
</script>
