#{this_is_a_page_for_logged_in_users}
<style>
    .fc-v-event .fc-event-main, .fc-h-event .fc-event-main {
        color: #{color_palette[:main_text]};
    }

    .cem span {
        background-color: #{color_palette[:is_light] ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.2)'};
        /* background-color: rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.2); */
    }
    .odometer.odometer-theme-default {
        font-family: unset;
        font-weight: bold;
    }
    #tresor_countdown_here {
        font-size: 200%;
        text-align: center;
    }
</style>
<div class='container-fluid' style='padding-top: 30px;'>
    <div class='row'>
        <div class='#{tablet_logged_in? ? 'col-md-6 offset-md-1' : 'col-md-2'} timetable_chooser' style='#{tablet_logged_in? ? 'margin-top: 23px;' : 'display: none;'}'>
            <div class='hint'>
                <div style='position: relative; top: 8px;'>
                <span class='bullet'><i class='fa fa-check'></i></span><b>Schritt 1:</b> Seite aktualisieren
                <a style='position: relative; top: -8px;' class='btn btn-success float-right' href='/'><i class='fa fa-refresh'></i>&nbsp;&nbsp;Jetzt aktualisieren</a>
                </div>
                <div style='clear: both;'></div>
            </div>
            <div class='hint' style='#{(kurs_tablet_logged_in? || teacher_tablet_logged_in?) ? '' : 'display: none;'}'>
                <div style='position: relative; top: 8px;'>
                <span class='bullet'><i class='fa fa-check'></i></span><b>Schritt 2:</b> K√ºrzel ausw√§hlen<br /><br />
                    #{print_timetable_chooser()}
                </div>
            </div>
            <div class='hint' style='#{(klassenraum_logged_in?) ? '' : 'display: none;'}'>
                <div style='position: relative; top: 8px;'>
                <span class='bullet'><i class='fa fa-check'></i></span><b>Schritt 2:</b> Klasse ausw√§hlen<br /><br />
                    #{print_timetable_chooser()}
                </div>
            </div>
            <div class='hint future_homework' style='display: none;'></div>
            <div style='#{(tablet_logged_in? && (@@tablets[@session_user[:tablet_id]] || {})[:klassen_stream]) ? '' : 'display: none;'}'>
                <div class='hint'>
                <h4><strong style='color: #a40000;'>Streaming-Amt</strong></h4>
                <p>
                Ab jetzt m√ºsst ihr bitte <strong>nach jeder Stunde</strong> den Klassenstream beenden (auflegen).
                Geht wieder auf den Button ¬ªKlassenstreaming¬´, aktualisiert die Seite (Schritt 1) w√§hlt die n√§chste Stunde aus (Schritt 2) und startet das Meeting wieder, falls die Stunde per Jitsi √ºbertragen werden soll. Danke! üôÇüëçü¶Ñ
                </p>
                </div>
            </div>
        </div>
        <div class='#{tablet_logged_in? ? '' : 'col-lg-2 col-md-12 side-panel'}'>
            <!--
            <div class='hint' style='display: #{(@session_user[:user_agent] || '').include?('WebView') ? 'block' : 'none'};'>
                <p>
                    <i class="fa fa-exclamation-triangle" style="font-size: 200%; color: #888; float: left; margin-right: 15px; margin-top: 5px; position: relative; top: 3px;"></i>
                    <strong>Hinweis:</strong> Du benutzt die Dashboard-App f√ºr Android, die nicht mehr unterst√ºtzt wird.
                    Bitte l√∂sche die App und richte dir ggfs. einen Shortcut zur Dashboard-Website ein:
                </p>
                <p>
                    <a href='https://dashboard.gymnasiumsteglitz.de' target="_blank">https://dashboard.gymnasiumsteglitz.de</a>
                </p>
                <p>
                    Wie du einen Shortcut anlegen kannst, <a href='https://de.wikihow.com/Eine-Verkn%C3%BCpfung-f%C3%BCr-ein-Lesezeichen-auf-deinen-Android-Homebildschirm-legen'>erf√§hrst du hier</a>.
                </p>
                <p>
                    Falls du Fragen dazu hast, schreib bitte eine E-Mail an <a href='mailto:specht@gymnasiumsteglitz.de'>specht@gymnasiumsteglitz.de</a>.
                </p>
            </div>
            -->

            <div class='row'>
                <div class='switch_week_panel'></div>
                <div id='rsag' style='display: none;'>
                    <div class='col-lg-12 col-md-4 col-sm-6'>
                        <div class='hint'>
                            <select class='form-control'>
                            </select>
                        </div>
                    </div>
                    <div class='col-lg-12 col-md-4 col-sm-6'>
                        <div class='hint' style='padding: 0;'>
                            <iframe src='' style='width: 100%; height: 220px; border: none; border-radius: 4px;'></iframe>
                        </div>
                    </div>
                </div>
                #{print_ad_hoc_2fa_panel()}
                #{print_summoned_books_panel()}
                #{print_tresor_countdown_panel()}
                #{#print_lehrerzimmer_panel()}
                #{#print_self_test_panel()}
                #{print_current_polls()}
                #{#print_salzh_panel()}
                #{#print_timetable_chooser_sus()}
            </div>
        </div>
        <div class='#{tablet_logged_in? ? 'col-md-4' : 'col-lg-8 col-md-12'}'>
            <div class='card' style='margin-bottom: 20px; display: #{session_user_has_streaming_button? ? 'block' : 'none'};'>
                <div class='card-body' style='padding: 5px 15px;'>
                    <i class='fa fa-lightbulb-o' style='font-size: 200%;'></i>&nbsp;&nbsp;<span style='position: relative; top: -4px;'>Hier kommst du zu deinem ggf. aktivierten Klassenstream:</span>&nbsp;&nbsp;<a class='float-right btn btn fc-button-primary streaming-button' href='#{class_stream_link_for_session_user}' target='_blank'><i class='fa fa-microphone'></i>&nbsp;&nbsp;Zum Klassenstream&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i></a>
                    <div style='clear: both;'></div>
                </div>
            </div>
            <div class='hint' style='height: 60px; position: relative; top: 23px; #{tablet_logged_in? ? '' : 'display: none;'}'>
                <div style='position: relative; top: 8px;'>
                <span class='bullet'><i class='fa fa-check'></i></span><b>Schritt #{(kurs_tablet_logged_in? || teacher_tablet_logged_in? || klassenraum_logged_in?) ? '3' : '2'}:</b> Stunde ausw√§hlen
                </div>
            </div>
            <div id='calendar' style='margin-bottom: 30px;'>
            </div>
        </div>
        <div class='#{tablet_logged_in? ? 'col-md-6' : 'col-lg-2 col-md-12 side-panel'} timetable_chooser tablet_timetable_chooser' style='#{tablet_logged_in? ? 'display: none;' : ''}'>
            #{print_timetable_chooser()}
            <div class='hint weekend_events' style='display: none;'></div>
            <div class='hint future_homework' style='display: none;'></div>
        </div>
    </div>
</div>

<div class="modal" id="lessonModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" >
            <span class='lesson-label'></span>
            <div class='zeitpunkt' style='font-size: 80%;'></div>
        </h5>
        <div class='raum-label' style='font-size: 1.25rem'></div>
      </div>
      <div class="modal-body">
          <div class='container-fluid' style='padding: 0;'>
            <div class='row'>
                <div class='col-md-12'>
                    <div class='vertretungs-text'></div>
                    <div class='lesson-infos-here'></div>
                    <div class='sus-notes-here' style='display: none;'>
                        <hr />
                        <textarea id='ta_sus_notes' style='height: 10rem;' class='form-control' placeholder="Bitte gib hier ein, woran du in dieser Stunde gearbeitet hast (nur wenn es sich um eine Hybridstunde handelt, die du zu Hause verbracht hast)."></textarea>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class='small show-ha-amt-only' style='width: 100%;'>
            Du vertrittst in diesem Fach das Hausaufgabenamt und kannst deshalb Hausaufgaben f√ºr deine Klasse / deinen Kurs eintragen.
        </div>
        <div class="ha-amt-container" style='display: none; width: 100%;'>
            <textarea class='form-control' id='ta_ha_amt_text' placeholder='Hier kannst du die Hausaufgaben zu dieser Stunde eintragen'></textarea>
        </div>
        <a class="btn btn-success bu-edit-lesson">Bearbeiten</a>
        <button class="show-ha-amt-only btn btn-secondary bu-discard-ha-amt-text-changes"><i class='fa fa-trash'></i>&nbsp;&nbsp;√Ñnderungen verwerfen</button>
        <button class="show-ha-amt-only btn btn-success bu-save-ha-amt-text-changes"><i class='fa fa-check'></i>&nbsp;&nbsp;√Ñnderungen speichern</button>
        <button class="show-ha-amt-only btn btn-success bu-enter-ha-amt-text"><i class='fa fa-pencil'></i>&nbsp;&nbsp;Hausaufgaben eintragen</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Schlie√üen</button>
      </div>
    </div>
  </div>
  </div>
</div>

<div class="modal" id="homeworkFeedbackModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Feedback zur Hausaufgabe im Fach <span class='hw-fb-fach'></span> zu <span class='hw-fb-hw-date'></span></h5>
      </div>
      <div class="modal-body">
          <div class='container-fluid' style='padding: 0;'>
            <div class='row'>
                <div class='col-md-12'>
                <div class='alert alert-success'>
                    Wenn du m√∂chtest, kannst du hier Feedback zur Hausaufgabe an <span class='hw-fb-lehrer-genitiv'></span> senden. Dein Feedback ist anonym.
                </div>
                <p style='text-align: center;'><strong>Wie bist du mit der Hausaufgabe zurecht gekommen?</strong></p>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='hf-emoji col-md-4' data-feedback='good'>
                <div>üôÇ</div>
                Ich glaube, ich habe alles richtig gemacht.
                </div>
                <div class='hf-emoji col-md-4' data-feedback='hmmm'>
                <div>ü§î</div>
                Ich bin mir nicht ganz sicher, ob ich alles richtig gemacht habe.
                </div>
                <div class='hf-emoji col-md-4' data-feedback='lost'>
                <div>üòï</div>
                Ich wusste nicht genau, was ich tun sollte.
                </div>
            </div>
            <div class='hw-fb-got-est-time'>
                <div class='row'>
                    <div class='col-md-12'>
                    <p style='text-align: center;'><strong><span class='hw-fb-lehrer'></span> hat f√ºr diese Hausaufgabe <span class='hw-fb-est-time'></span> Minuten vorgesehen. Wie lange hast du f√ºr die Hausaufgabe ben√∂tigt?</strong></p>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-lg-4 offset-lg-4 col-md-6 offset-md-3 col-sm-6 offset-sm-3'>
                        <div class="input-group mb-3">
                        <input style='text-align: center;' class='form-control' id='ti_hw_spent_minutes' min='0' type='number'></input>
                        <div class="input-group-append">
                            <span class="input-group-text">Minuten</span>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class='feedback_submit_success mr-auto'><i class='fa fa-check-circle text-success'></i>&nbsp;&nbsp;Dein Feedback wurde gespeichert.</div>
        <div class='feedback_submit_error mr-auto'><i class='fa fa-exclamation-circle text-danger'></i>&nbsp;&nbsp;Dein Feedback konnte nicht gespeichert werden<span class='poll_submit_error_message'></span></div>
        <button id='bu_send_homework_feedback' type='button' class="btn btn-success"><i class='fa fa-send'></i>&nbsp;&nbsp;Feedback speichern</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class='fa fa-times'></i>&nbsp;&nbsp;Schlie√üen</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="adHoc2FaRequestModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ad-hoc-Anmeldung im Datentresor</h5>
        </div>
        <div class="modal-body">
            <div class='container-fluid' style='padding: 0;'>
              <div class='row'>
                  <div class='col-md-12'>
                    <p>
                    Sie k√∂nnen nun den Zugang zum Datentresor f√ºr <strong><span class="ad_hoc_login_name_here"></span></strong> (<span id="ad_hoc_login_email_here"></span>) freischalten.
                    </p>
                    <div class='alert alert-warning'>
                          <i class='fa fa-exclamation-circle'></i>&nbsp;&nbsp;<b>Achtung!</b> Bitte vergewissern Sie sich, dass Sie die richtige Person am Telefon haben.
                    </div>
                    <div class='alert alert-secondary div_ad_hoc_fresh_sms'>
                        F√ºr <span class="ad_hoc_login_name_here"></span> wurde heute eine neue Telefonnummer hinterlegt, die erst ab morgen zur Anmeldung am Datentresor verwendet werden kann.
                        <br />
                    </div>
                    <div class='alert alert-secondary div_ad_hoc_fresh_otp'>
                        F√ºr <span class="ad_hoc_login_name_here"></span> wurde heute ein neuer OTP-Code hinterlegt, der erst ab morgen zur Anmeldung am Datentresor verwendet werden kann.
                    </div>
                  </div>
              </div>
          </div>
        </div>
        <div class="modal-footer">
        <button class="btn btn-secondary div_ad_hoc_fresh_sms bu_unlock_2fa_sms"><i class='fa fa-mobile'></i>&nbsp;&nbsp;SMS jetzt freigeben</button>
        <button class="btn btn-secondary div_ad_hoc_fresh_otp bu_unlock_2fa_otp"><i class='fa fa-qrcode'></i>&nbsp;&nbsp;OTP jetzt freigeben</button>
        <button id='bu_perform_ad_hoc_signin' type='button' class="btn btn-success"><i class='fa fa-sign-in'></i>&nbsp;&nbsp;Anmeldung erlauben</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal"><i class='fa fa-times'></i>&nbsp;&nbsp;Anmeldung ablehnen</button>
        </div>
      </div>
    </div>
</div>

<style>
.fc-button-primary {
    background-color: #{color_palette[:desaturated_color]};
    border: 1px solid #{color_palette[:desaturated_color]};
    color: #fff;
}

.fc-button-primary:hover, .fc-button-primary:active {
    background-color: #{color_palette[:desaturated_color_darker]};
    border: 1px solid #{color_palette[:desaturated_color_darker]};
    color: #fff;
}

/* .streaming-button { */
/*     position: absolute; */
/*     top: 1px; */
/* } */

.card {
    background-color: rgba(255,255,255,0.5);
}

</style>

<script>
var my_lessons = #{(@@lessons_for_shorthand[@session_user[:shorthand]] || []).to_json};
var sus_for_my_lessons = #{Hash[(@@lessons_for_shorthand[@session_user[:shorthand]] || []).map { |x| [x, (@@schueler_for_lesson[x] || []).map { |y| {:email => y, :display_name => @@user_info[y][:display_name]}}]}].to_json};
var tablet_logged_in = ('#{tablet_logged_in?}' === 'true');
var teacher_tablet_logged_in = ('#{teacher_tablet_logged_in?}' === 'true');
var klassenraum_logged_in = ('#{klassenraum_logged_in?}' === 'true');
var sus_logged_in = ('#{sus_logged_in?}' === 'true');
var teacher_logged_in = ('#{teacher_logged_in?}' === 'true');
var fixed_timetable_data = #{fixed_timetable_data.to_json};
var homework_feedback = {};
var jitsi_refresh_config = {
    lesson_key: null,
    lesson_offset: null,
    jitsi_names_div: null,
    jitsi_missing_names_div: null,
    jitsi_breakout_rooms_names_divs: []
};
var tablet_set_info = #{@@tablet_sets.to_json};
var ha_amt_lesson_keys = #{get_ha_amt_lesson_keys.to_json};

function clear_polling_handler() {
    if (jitsi_refresh_config.poll_handle !== null) {
        clearTimeout(jitsi_refresh_config.poll_handle);
        jitsi_refresh_config = {
            poll_handle: null,
            lesson_key: null,
            lesson_offset: null,
            jitsi_names_div: null,
            jitsi_missing_names_div: null,
            jitsi_breakout_rooms_names_divs: []
        };
    }
}

function refresh_jitsi_presence() {
    let in_data = {lesson_key: jitsi_refresh_config.lesson_key, offset: jitsi_refresh_config.lesson_offset};
    api_call('/api/get_current_jitsi_users_for_lesson', in_data, function(data) {
        if (data.success) {
            jitsi_refresh_config.jitsi_names_div.text((data.lesson_room || []).join(', '));
            if ((data.missing_sus || []).length === 0) {
                jitsi_refresh_config.jitsi_missing_names_div.hide();
            } else {
                jitsi_refresh_config.jitsi_missing_names_div.empty();
                jitsi_refresh_config.jitsi_missing_names_div.append($('<strong><em>Momentan abwesend in Jitsi:</em></strong>'));
                jitsi_refresh_config.jitsi_missing_names_div.append(' ');
                jitsi_refresh_config.jitsi_missing_names_div.append($('<span>').text(((data.missing_sus || []).join(', '))));
                jitsi_refresh_config.jitsi_missing_names_div.append($('<hr />'));
                jitsi_refresh_config.jitsi_missing_names_div.show();
            }
            if (jitsi_refresh_config.jitsi_breakout_rooms_names_divs.length > 0) {
                for (let i = 0; i < data.breakout_rooms.length; i++) {
                    jitsi_refresh_config.jitsi_breakout_rooms_names_divs[i].text(((data.breakout_rooms || {})[i] || []).join(', '));
                }
            }
        } else {
            clear_polling_handler();
        }
    });
}

function render_timetable(result, successCallback) {
    events = result.events;
    $('.switch_week_panel').empty();
    if ((!tablet_logged_in) && (teacher_logged_in || '#{(sus_logged_in? && WECHSELUNTERRICHT_KLASSENSTUFEN.include?(@session_user[:klasse].to_i))}' === 'true')) {
        if (typeof(result.switch_week) !== 'undefined' && result.switch_week !== null) {
            let user_group2 = '#{@session_user[:group2]}';
            let s = `Diese Woche ist eine <strong>${result.switch_week}-Woche</strong>. `;
            if (sus_logged_in) {
                if ('#{@session_user[:homeschooling]}' === 'true') {
                    s += `Du bist momentan als ¬ªzu Hause¬´ markiert und nimmst deshalb von <strong>zu Hause</strong> am Unterricht teil. `;
                } else {
                    s += `F√ºr Dich hei√üt das, dass Du in dieser Woche ${user_group2 === result.switch_week ? 'in der Schule' : 'zu Hause'} unterrichtet wirst. `; 
                    if (user_group2 === result.switch_week)
                        s += `Wenn Deine Eltern entscheiden sollten, dass Du erst einmal noch weiter zu Hause bleiben sollst, m√ºssen Sie dies Deiner Klassenleitung und dem Sekretariat mitteilen. Dann werden wir Dich als ¬ªzu Hause¬´ markieren, so dass alle wissen, dass Du nicht in die Schule kommst und ggfs. von zu Hause am Jitsi-Unterricht teilnehmen kannst.`;
                }
            }
            let div = $('<div>').addClass('hint').html(s);
            $('.switch_week_panel').append(div);
        }
    }
    // if ('#{@session_user[:can_upload_vplan]}' === 'true') {
    //     moment.locale('de');
    //     if ('#{latest_vplan_timestamp}' === (result.vplan_timestamp || ''))
    //         $('.timetable_updated').html("<i class='fa fa-check text-success'></i>&nbsp;&nbsp;Vertretungsplan ist aktuell");
    //     else
    //         $('.timetable_updated').html("<i class='fa fa-warning text-danger'></i>&nbsp;&nbsp;Vertretungsplan wird gerade aktualisiert, bitte demn√§chst noch einmal neu laden.");
    // }

    var wrote_weekend_event_header = false;
    $('.weekend_events').hide();
    $('.weekend_events').empty();
    for (let event of events)
    {
        event.color = color_palette.primary;
        if (event.entfall)
            event.color = color_palette.disabled;
        if (event.is_event)
            event.color = color_palette.shifted;
        if (event.is_event && [6, 0].indexOf(new Date(event.datum).getDay()) >= 0) {
            if (wrote_weekend_event_header == false) {
                $('.weekend_events').append($('<p><b>Termine am Wochenende</b></p><hr />'));
                $('.weekend_events').show();
            } else {
                $('.weekend_events').append('<hr />')
            }
            let time_str = '' + parseInt(event.datum.substr(8, 2)) + '.' + event.datum.substr(5, 2) + '.' + event.datum.substr(0, 4) + '<br />' + event.start_time + '&ndash;' + event.end_time;
            $('.weekend_events').append($('<p>' + time_str + '<br /><b>' + event.event_title + '</b><br />' + event.organized_by));
            $('.weekend_events').append(fix_bad_html($('<div>').html(event.description)));
            if (event.jitsi == true) {
                $('.weekend_events').append($('<a href="/jitsi/event/' + event.eid + '" target="_blank" class="btn btn-sm btn-primary"><i class="fa fa-microphone"></i>&nbsp;&nbsp;Zum Jitsi-Raum&nbsp;&nbsp;<i class="fa fa-angle-double-right"></i></a></p>'));
            }
        var wrote_weekend_event_header = true;
        }

    }
    if (tablet_logged_in) {
        events = events.filter(x => x.lesson);
        for (let event of events) {
            for (let key in (event.data || {})) {
                if (key !== 'lesson_jitsi')
                    delete event.data[key];
            }
        }
    }
    let today = (new Date()).toISOString().substr(0, 10);

    let this_klasse = #{(@session_user[:klasse] || '0').to_i};
    if (this_klasse === 0) {
        this_klasse = parseInt($($('.ttc.active')[0]).text());
        if (this_klasse === NaN)
            this_klasse = 0;
    }
    if (this_klasse >= 5 && this_klasse <= 9) {
        which = '7-9';
        if (this_klasse <= 6)
            which = '4-6';
        
        for (let i = 1; i <= 24; i++)
        {
            let title = 'üéÖ Mathe im Advent';
            let day_s = '' + i;
            if (day_s.length < 2)
                day_s = '0' + day_s;
            let ds = '2021-12-' + day_s;
            let wday = new Date(ds).getDay();
            if (wday == 6) {
                // Saturday
                let day_s = '' + (i + 2);
                if (day_s.length < 2)
                    day_s = '0' + day_s;
                ds = '2021-12-' + day_s;
                title += ' (Sa)';
            } else if (wday == 0) {
                // Sunday
                let day_s = '' + (i + 1);
                if (day_s.length < 2)
                    day_s = '0' + day_s;
                ds = '2021-12-' + day_s;
                title += ' (So)';
            }
            if (today >= ds)
                events.push({eventOrder: i, color: color_palette.shifted, start: ds, end: ds, title: title, href: 'https://www.mathe-im-advent.de/de/kalender/' + which + '/' + i + '/' });
        }
    }
    successCallback(events);
}

function update_ha_amt_buttons() {
    let pending_changes = $('#ta_ha_amt_text').val().trim() !== $('#ta_ha_amt_text').data('stored_ha_amt_text');
    if (pending_changes) {
        $('.bu-discard-ha-amt-text-changes').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        $('.bu-save-ha-amt-text-changes').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
    } else {
        $('.bu-discard-ha-amt-text-changes').addClass('btn-outline-secondary').removeClass('btn-secondary').prop('disabled', true);
        $('.bu-save-ha-amt-text-changes').addClass('btn-outline-secondary').removeClass('btn-success').prop('disabled', true);
    }
}

var timetable_id = '#{timetable_id}';

function load_timetable(id) {
    timetable_id = id;
    window.calendar.refetchEvents();
}

function rsag() {
    $('#rsag').show();
    const points = [
        {name: "Gerberbruch", id:  1 },{name: "Lange Stra√üe", id:  2 },{name: "Graf-Stauffenberg-Stra√üe", id:  3 },{name: "Friedensforum", id:  4 },{name: "Platz der Jugend", id:  5 },{name: "Petridamm", id:  6 },{name: "S Parkstra√üe", id:  7 },{name: "Steintor IHK", id:  8 },{name: "Dierkower Kreuz", id:  9 },{name: "Hafenallee", id:  10 },{name: "Martin-Niem√∂ller-Stra√üe", id:  11 },{name: "H√∂lderlinweg", id:  12 },{name: "Dierkower Damm", id:  13 },{name: "Doberaner Platz", id:  14 },{name: "Schr√∂derplatz", id:  15 },{name: "Saarplatz", id:  16 },{name: "Kr√∂peliner Tor", id:  17 },{name: "Kurt-Schumacher-Ring", id:  18 },{name: "Hinrichsdorfer Stra√üe", id:  19 },{name: "Volkstheater", id:  20 },{name: "Kabutzenhof", id:  21 },{name: "Ma√ümannstra√üe", id:  22 },{name: "S Holbeinplatz", id:  23 },{name: "Heinrich-Sch√ºtz-Stra√üe", id:  24 },{name: "Kunsthalle", id:  25 },{name: "Reutershagen", id:  26 },{name: "Rahnst√§dter Weg", id:  27 },{name: "S Marienehe", id:  28 },{name: "Dierkower Allee", id:  29 },{name: "Katerweg", id:  30 },{name: "Dierkow-Zentrum", id:  31 },{name: "Lorenzstra√üe", id:  32 },{name: "Leibnizplatz", id:  33 },{name: "Hauptbahnhof", id:  34 },{name: "Neuer Friedhof", id:  35 },{name: "Zoo", id:  36 },{name: "Dr.-Lorenz-Weg", id:  37 },{name: "Weidendamm", id:  38 },{name: "Zum Sch√§ferteich", id:  39 },{name: "Urho-Kekkonen-Stra√üe", id:  40 },{name: "Albert-Schweitzer-Stra√üe", id:  41 },{name: "Jawaharlal-Nehru-Stra√üe", id:  42 },{name: "Martin-Luther-King-Allee", id:  43 },{name: "Stuthof", id:  46 },{name: "Hinrichsdorf", id:  47 },{name: "Neu Hinrichsdorf", id:  48 },{name: "Hohe D√ºne F√§hre", id:  49 },{name: "Breitling", id:  50 },{name: "Hohe D√ºne", id:  51 },{name: "Strand", id:  52 },{name: "Taterh√∂rn", id:  53 },{name: "Markgrafenheide", id:  54 },{name: "Schnatermannweg", id:  55 },{name: "Rostocker Heide", id:  56 },{name: "Am Seehafen", id:  57 },{name: "Krummendorf Nord", id:  58 },{name: "Bahnbetriebswerk", id:  59 },{name: "Thierfelderstra√üe", id:  60 },{name: "Markgrafenheide StrandResort", id:  61 },{name: "Heidenholzmoor", id:  62 },{name: "Krummendorf", id:  63 },{name: "Oldendorf", id:  64 },{name: "Warnowrande", id:  65 },{name: "Warnowblick", id:  66 },{name: "Langenort", id:  67 },{name: "Pressentinstra√üe", id:  68 },{name: "Sch√∂ffenweg", id:  69 },{name: "Kirchenplatz", id:  70 },{name: "F√§hrstr. Michaelshof", id:  71 },{name: "Gehlsheimer Stra√üe", id:  72 },{name: "Gehlsheim Klinik", id:  73 },{name: "Baumschulenweg", id:  74 },{name: "Schenkendorfweg", id:  75 },{name: "Am Petridamm", id:  77 },{name: "Brinckmansdorf", id:  81 },{name: "Tessiner Stra√üe", id:  82 },{name: "Wei√ües Kreuz", id:  83 },{name: "Flussbad", id:  84 },{name: "Am Bagehl", id:  85 },{name: "Lessingstra√üe", id:  86 },{name: "Puschkinplatz HBZ", id:  87 },{name: "Goetheplatz", id:  88 },{name: "Erich-Schlesinger-Stra√üe", id:  89 },{name: "S√ºdstadt-Center", id:  90 },{name: "Robert-Koch-Stra√üe", id:  91 },{name: "Klinikum S√ºd", id:  92 },{name: "Campus S√ºdstadt", id:  93 },{name: "Markt Reutershagen", id:  94 },{name: "Ulrich-von-Hutten-Stra√üe", id:  95 },{name: "Kuphalstra√üe", id:  96 },{name: "Tschaikowskistra√üe", id:  97 },{name: "Schwimmhalle", id:  98 },{name: "Ostseestadion", id:  99 },{name: "Schillingallee", id:  100 },{name: "Majakowskistra√üe", id:  101 },{name: "Weidengrund", id:  102 },{name: "Dieselmotorenwerk", id:  103 },{name: "Zur Mooskuhle", id:  104 },{name: "Schwaaner Landstra√üe", id:  105 },{name: "Am Kringelgraben", id:  106 },{name: "Tychsenstra√üe", id:  107 },{name: "Galileistra√üe", id:  108 },{name: "Grabower Stra√üe", id:  109 },{name: "Dethardingstra√üe", id:  110 },{name: "Eutiner Stra√üe", id:  111 },{name: "Kessiner Weg", id:  112 },{name: "Carl-Hopp-Stra√üe", id:  114 },{name: "Am Dorfteich", id:  115 },{name: "Biestow", id:  118 },{name: "Schutow", id:  120 },{name: "Theodor-Storm-Stra√üe", id:  121 },{name: "Bertolt-Brecht-Stra√üe", id:  122 },{name: "Ehm-Welk-Stra√üe", id:  123 },{name: "Thomas-Morus-Stra√üe", id:  124 },{name: "Sassnitzer Stra√üe", id:  125 },{name: "Binzer Stra√üe", id:  126 },{name: "Turkuer Stra√üe", id:  127 },{name: "Fischereihafen", id:  130 },{name: "Warnowallee", id:  131 },{name: "Osloer Stra√üe", id:  132 },{name: "Gedser Stra√üe", id:  133 },{name: "Kopenhagener Stra√üe", id:  134 },{name: "Mecklenburger Allee", id:  135 },{name: "M√∂llner Stra√üe", id:  138 },{name: "Rigaer Stra√üe", id:  139 },{name: "St. Petersburger Stra√üe", id:  140 },{name: "Helsinkier Stra√üe", id:  141 },{name: "Hundsburgallee", id:  143 },{name: "Stadtwerke", id:  144 },{name: "Siemens", id:  145 },{name: "Industriestra√üe", id:  146 },{name: "Blockmacherring\/IGA-Park", id:  150 },{name: "Ger√ºstbauerring", id:  151 },{name: "Taklerring", id:  152 },{name: "S Bramow", id:  153 },{name: "G√ºstrower Stra√üe", id:  154 },{name: "S Lichtenhagen", id:  155 },{name: "Werftblick", id:  156 },{name: "Richard-Wagner-Str. TZW", id:  157 },{name: "Wiesenweg", id:  158 },{name: "Haus Stolteraa", id:  159 },{name: "Warnem√ºnde Strand", id:  160 },{name: "Warnem√ºnde Friedhof", id:  161 },{name: "Diedrichshagen", id:  162 },{name: "D√§nenberg", id:  163 },{name: "Alter Hafen S√ºd", id:  164 },{name: "Westfriedhof", id:  166 },{name: "Bonhoefferstra√üe", id:  167 },{name: "J√ºrgeshof", id:  168 },{name: "Nienhager Koppel", id:  169 },{name: "Nienhagen", id:  170 },{name: "Sternwarte", id:  171 },{name: "Rosenweg", id:  172 },{name: "Greifswalder Stra√üe", id:  173 },{name: "H√ºerbaasweg", id:  174 },{name: "Lomonossowstra√üe", id:  175 },{name: "Schmarl Dorf", id:  178 },{name: "Deutsche-Med-Platz", id:  179 },{name: "S L√ºtten Klein", id:  183 },{name: "Hinrichshagen", id:  185 },{name: "Hafenbahnweg", id:  189 },{name: "Beim Pulverturm", id:  190 },{name: "Rostocker Stra√üe", id:  192 },{name: "Joachim-Jungius-Stra√üe", id:  193 },{name: "Campingplatz", id:  194 },{name: "Messestra√üe", id:  200 },{name: "Getreidehafen", id:  201 },{name: "Seehafen Ost", id:  202 },{name: "Rosa-Luxemburg-Stra√üe", id:  203 },{name: "Paulstra√üe", id:  204 },{name: "Etkar-Andr√©-Stra√üe", id:  218 },{name: "Walter-Husemann-Stra√üe", id:  219 },{name: "Immendiek", id:  222 },{name: "Juliot-Curie-Allee", id:  228 },{name: "Bl√ºcherstra√üe", id:  229 },{name: "Br√ºckenweg", id:  231 },{name: "Kraftwerk", id:  233 },{name: "Am Liepengraben", id:  234 },{name: "G√ºterverkehrszentrum", id:  236 },{name: "S Warnem√ºnde Werft", id:  248 },{name: "Fritz-Reuter-Stra√üe", id:  249 },{name: "Warnem√ºnde Kirchenplatz", id:  250 },{name: "Seestra√üe", id:  251 },{name: "Kurhausstra√üe", id:  252 },{name: "Rohrmannsche Koppel", id:  253 },{name: "Wachtlerstra√üe", id:  254 },{name: "Gartenstadt", id:  264 },{name: "Poststra√üe", id:  273 },{name: "Seelotsenring", id:  276 },{name: "Zum Laakkanal", id:  277 },{name: "Seehafen F√§hre", id:  279 },{name: "Liebherrstra√üe", id:  284 },{name: "Elmenhorster Weg", id:  290 },{name: "Stolteraer Weg", id:  305 },{name: "Charles-Darwin-Ring", id:  306 },{name: "Speicher", id:  307 },{name: "S Evershagen", id:  308 },{name: "Schulzenwiese", id:  312 },{name: "Schmarl Zentrum", id:  315 },{name: "Roald-Amundsen-Stra√üe", id:  316 },{name: "Handwerkstra√üe", id:  317 },{name: "Stephan-Jantzen-Ring", id:  318 },{name: "Streuwiesenweg", id:  319 },{name: "Gro√ü Schwa√üer Weg", id:  323 },{name: "Stadthafen", id:  332 },{name: "Evershagen S√ºd", id:  333 },{name: "Neuer Markt", id:  334 },{name: "Timmermannsstrat", id:  335 },{name: "Rudolf-Tarnow-Stra√üe", id:  336 },{name: "Brinckmansh√∂he", id:  337 },{name: "Albert-Schulz-Stra√üe", id:  338 },{name: "Riekdahl", id:  339 },{name: "Niederhagen", id:  340 },{name: "Kassebohm S√ºd", id:  342 },{name: "Vicke-Schorler-Ring", id:  343 },{name: "Zu den S√∂llen", id:  344 },{name: "Maxim-Gorki-Stra√üe", id:  345 },{name: "R√ºgener Stra√üe", id:  346 },{name: "S√ºdblick", id:  347 },{name: "Langenort Hufe", id:  350 },{name: "Fischerdorf", id:  358 },{name: "L√ºtten Klein Zentrum", id:  359 },{name: "Kassebohm", id:  361 },{name: "Mendelejewstra√üe", id:  366 },{name: "Stadthalle", id:  367 },{name: "Gro√ü Klein Dorf", id:  368 },{name: "Hauptbahnhof Nord", id:  369 },{name: "Hauptbahnhof S√ºd", id:  370 },{name: "Graureiherweg", id:  380 },{name: "Tannenweg", id:  381 },{name: "Friedrichsh√∂he", id:  382 },{name: "F√§hre Gehlsdorf", id:  401 },{name: "F√§hre Kabutzenhof", id:  402 },{name: "F√§hre Hohe D√ºne", id:  404 },{name: "F√§hre Warnem√ºnde", id:  405 },{name: "Zum Pagenwerder", id:  432 },{name: "Klinikum Schillingallee", id:  438 },
    ];
    points.sort(function(a, b) {
        if (a.name == b.name)
            return 0;
        return a.name < b.name ? -1 : 1;
    });
    for (let p of points) {
        $('#rsag select').append($('<option>').text(p.name).attr('value', p.id));
    }
    $('#rsag select').change(function(e) {
        let id = $('#rsag select').val();
        $('#rsag iframe').attr('src', `https://abfahrten-rsag.de/dfi/${id}`);
    });
    $('#rsag select').val('34');
    $('#rsag iframe').attr('src', `https://abfahrten-rsag.de/dfi/34`);
}

var physics_animation_elements = [];
var physics_last_t = null;
var physics_animation_running = false;

function physics_animation_step(t) {
    physics_animation_running = true;
    if (physics_last_t = null) {
        physics_last_t = t;
        return;
    }
    let delta = (t - physics_last_t) / 1000.0;
    physics_last_t = t;
    // console.log(`animating ${physics_animation_elements.length} elements!`);
    physics_animation_elements = physics_animation_elements.filter(function(x) {

        e = $(x[0]);
        let a = x[1];
        let v = x[2];
        let p = x[3];
        p += v;
        v += a;
        a -= Math.tan(p * 0.001);
        a *= 0.9;
        v *= 0.9;
        e.css('transform', `translate(0, -50%) rotate(${p}deg) translate(0, 50%)`);
        x[1] = a;
        x[2] = v;
        x[3] = p;
        let this_moving = (Math.abs(a) > 0.0001);
        if (!this_moving) {
            e.css('transform', `translate(0, -50%) rotate(0deg) translate(0, 50%)`);
            e.data('currently_animating', 0);
        }
        return this_moving;
    });
    if (physics_animation_elements.length > 0) {
        requestAnimationFrame(physics_animation_step);
    } else {
        physics_animation_running = false;
        // console.log('stop');
    }
}

function install_physics_handler(e) {
    return;
    if (`#{DEVELOPMENT}` !== '1' && moment().format('YYYY-MM-DD') !== '2023-04-01')
        return;
    if (e.data('physics_handler_installed') === 1)
        return;
    e.data('physics_handler_installed', 1);
    e.mouseenter(function(e) {
        // console.log(`mouseenter for `, e);
        let element = $(e.currentTarget);
        if (element.data('currently_animating') !== 1) {
            element.data('currently_animating', 1);
            physics_animation_elements.push([element, -0.2 - Math.random() * 0.1, 0.0, 0.0]);
            if (!physics_animation_running)
                requestAnimationFrame(physics_animation_step);
        } else {
            for (let x of physics_animation_elements) {
                // console.log(x[0][0], element[0]);
                if (x[0][0] === element[0]) {
                    x[1] -= 0.2;
                    break;
                }
            }
        }
    });
}

var lesson_notes = #{lesson_notes_for_session_user.to_json};

document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    let narrow_window = ($(window).width() <= 640);
    let initial_date = '#{initial_date}';
    if (window.location.hash.length > 0)
        window.location.hash = '';
    $('.ttc[data-id="' + timetable_id + '"]').addClass('active');
    let options = {
        initialView: (narrow_window || tablet_logged_in) ? 'timeGridDay' : 'timeGridWeek',
        dayHeaderFormat: { weekday: 'short', month: 'numeric', day: 'numeric', omitCommas: true },
        headerToolbar: {start: '', center: '', end: tablet_logged_in ? '' : 'today prev,next'},
        allDaySlot: true,
        slotMinTime: '#{@session_user[:teacher] ? '07:00' : '07:00'}',
        slotMaxTime: '22:00',
        nowIndicator: true,
        expandRows: true,
        locale: 'de',
        height: (!!window.chrome) ? #{@session_user[:teacher] ? 1330 : 1330} : #{@session_user[:teacher] ? 1350 : 1350},
        initialDate: initial_date,
        events: function(info, successCallback, failureCallback) {
            let start_date = new Date(info.startStr);
            while (start_date.getDay() != 1)
                start_date.setDate(start_date.getDate() - 1);
            let week = '' + start_date.getWeek();
            if (week.length < 2)
                week = '0' + week;

            let yw_date = start_date.getFullYear() + '-' + week;
            let month = '' + (start_date.getMonth() + 1);
            let day = '' + start_date.getDate();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            
            if (fixed_timetable_data !== null) {
                render_timetable(fixed_timetable_data, successCallback);
            } else {
                let uri = '/gen/w/' + timetable_id + '/' + yw_date + '.json.gz';
                if (#{@session_user[:teacher] ? true: false})
                    uri += '?' + Date.now();
                let oReq = new XMLHttpRequest();
                oReq.open('GET', uri, true);
                oReq.responseType = 'arraybuffer';

                oReq.onload = function(e) {
                    $('.timetable_updated').empty();
                    if (e.target.status === 200) {
                        $('.ttc').removeClass('active');
                        $('.ttc[data-id="' + timetable_id + '"]').addClass('active');
                        
                        let data = pako.ungzip(oReq.response);
                        let bb = new Blob([new Uint8Array(data)]);
                        let f = new FileReader();
                        f.onload = function(e) {
                            let result = JSON.parse(e.target.result);
                            console.log(result);
                            render_timetable(result, successCallback);
                        };
                        f.readAsText(bb);
                    }
                };
                oReq.send();
            }
        },
        hiddenDays: [6, 0],
        slotEventOverlap: false,
        slotLabelFormat: {
            hour: 'numeric',
            minute: '2-digit',
            omitZeroMinute: false
        },
        eventDidMount: function(event) {
            let parent = $(event.el).closest('.fc-timegrid-event-harness');
            install_physics_handler(parent);
        },
        eventContent: function(arg) {
            if (arg.event.extendedProps.lesson)
            {
                let event_data = arg.event.extendedProps.data || {};
                let per_user = arg.event.extendedProps.per_user || {};
                let divs = [];
                for (let pause of (arg.event.extendedProps.pausen || []))
                {
                    let bgdiv = $('<div>');
                    bgdiv.css({position: 'absolute', left: 0, top: (pause[0] * 75.0 / 60.0) + 'px', right: 0});
                    bgdiv.css('height', (((pause[1] - pause[0]) * 75.0 / 60.0)) + 'px');
                    bgdiv.css('z-index', '-1');
                    // bgdiv.css('border-top', '1px dashed rgba(255, 255, 255, 0.2)');
                    bgdiv.css('border-top', '1px dashed rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.2)');
                    // bgdiv.css('border-bottom', '1px dashed rgba(255, 255, 255, 0.2)');
                    bgdiv.css('border-bottom', '1px dashed rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.2)');
                    if (event_data.stundenthema_text || event_data.hausaufgaben_text)
                        bgdiv.css('background-color', 'rgba(255, 255, 255, 0.05)');
                    else
                        bgdiv.css('background-color', 'rgba(255, 255, 255, 0.15)');
    //                 bgdiv.css('background', 'url(/images/border-top.png) left top repeat-x , url(/images/border-bottom.png) left bottom repeat-x, #529ccc');
                    bgdiv.css('min-height', '7px');
                    divs.push(bgdiv[0]);
                }
                let div0 = $('<div>');
                div0.css('white-space', 'nowrap');
                div0.addClass('condensed');

                div0.css('opacity', 0.7);
                let t = $('<span>').text(arg.timeText);
                let raum = $('<span>').html(arg.event.extendedProps.raum);
                raum.addClass('condensed');

                raum.css('position', 'absolute').css('right', '-1px');
                raum.css('background-color', color_palette.primary);
                raum.css('padding-right', '2px');
                
                raum.css('padding-left', '4px');
                if (arg.event.extendedProps.entfall)
                    raum.css('background-color', color_palette.disabled);
                div0.append(t).append(raum);
                
                let div1 = $('<div>');
                if (arg.event.extendedProps.count === 1)
                    div1.css('white-space', 'nowrap');
                let fach = $('<div>').html(arg.event.extendedProps.label);
                // if ('#{!!DEVELOPMENT}' === 'true')
                //     fach.html('<b style="background-color: rgba(255,255,255,0.2);">[' + arg.event.extendedProps.lesson_key + '#' + arg.event.extendedProps.lesson_offset + ']</b><br />' + fach.html());
//                 if (arg.event.extendedProps.vnr)
//                     fach.html('#' + arg.event.extendedProps.vnr + ' ' + fach.html());
                div1.append(fach);
                let div1b = $('<div>').addClass('line2');
                if (arg.event.extendedProps.vertretungs_text)
                {
                    let span = $('<span>').html(arg.event.extendedProps.vertretungs_text);
                    span.css('opacity', 0.7);
                    div1b.append(span);
                }
                div1b.append('&nbsp;');
                if (per_user.text_comments)
                    per_user.text_comments = filter_events_by_timestamp(per_user.text_comments, show_messages_from);
                if (per_user.audio_comments)
                    per_user.audio_comments = filter_events_by_timestamp(per_user.audio_comments, show_messages_from);
                
                let markers = $('<span>').addClass('cem').css('background-color', arg.event.extendedProps.entfall ? color_palette.disabled : (arg.event.extendedProps.is_event ? color_palette.shifted : color_palette.primary));
                if (event_data.stundenthema_text)
                    markers.append($('<span>').html("<i class='fa fa-info-circle'></i>"));
                if (event_data.lesson_jitsi) {
                    if (event_data.breakout_rooms)
                        markers.append($('<span>').addClass('mute').html('Jitsi / GR'));
                    else
                        markers.append($('<span>').addClass('mute').html('Jitsi'));
                    if (event_data.booked_tablet)
                        markers.append($(event_data.booked_tablet_label_short));
                }
                if (event_data.booked_tablet_sets) {
                    markers.append($('<span>').css('font-weight', 'normal').html(`<i class='fa fa-tablet'></i> &times;${event_data.booked_tablet_sets_total_count}`));
                }
                let contact_person_sus = arg.event.extendedProps.contact_person_sus || [];
                if (contact_person_sus.length > 0) {
                    markers.append($('<span>').css('font-weight', 'normal').html(`<i class='fa fa-exclamation-circle'></i> &times;${contact_person_sus.length}`));
                }
                let salzh_sus = arg.event.extendedProps.salzh_sus || [];
                if (salzh_sus.length > 0) {
                    markers.append($('<span>').css('font-weight', 'normal').html(`<i class='fa fa-home'></i> &times;${salzh_sus.length}`));
                }
                if (event_data.lesson_nc || event_data.homework_nc)
                    markers.append($('<span>').addClass('mute').html('NC'));
                if (event_data.lesson_lr || event_data.homework_lr)
                    markers.append($('<span>').addClass('mute').html('LR'));
                if (event_data.hausaufgaben_text) {
                    if ((per_user.homework_feedback || {}).short_state)
                        markers.append($('<span>').text('HA ' + per_user.homework_feedback.short_state));
                    else
                        markers.append($('<span>').html('HA'));
                }
                if (per_user.text_comments || per_user.audio_comments)
                    markers.append($('<span>').html("<i class='fa fa-comment'></i>"));
                if (per_user.can_have_sus_feedback) {
                    if (teacher_logged_in) {
                        if ((Object.keys(per_user.lesson_notes || {})).length > 0) {
                            markers.append($('<span>').html(`${Object.keys(per_user.lesson_notes).length}x <i class='fa fa-file-text-o'></i>`));
                        }
                    } else {
                        markers.append($('<span>').html(`<i id='icon_hybrid_notes_${arg.event.extendedProps.lesson_key}_${arg.event.extendedProps.lesson_offset}' class='fa ${(((lesson_notes[arg.event.extendedProps.lesson_key] || {})[arg.event.extendedProps.lesson_offset] || '').length > 0) ? 'fa-file-text-o': 'fa-file-o'}'></i>`));
                    }
                }
                div1b.append(markers);

                let div2 = $('<div>');
                let div3 = $('<div>');
                let div4 = $('<div>');
                div2.addClass('condensed');

                // div2.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
                div2.css('border-top', '1px solid rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.5)');
                // div2.css('border-top', '1px solid #{color_palette[:main_text]};');
                div2.css('margin-top', '2px');
                div2.css('height', '100%');

                if ((arg.event.extendedProps.data || {}).stundenthema_text || (arg.event.extendedProps.data || {}).hausaufgaben_text)
                {
                    div3.css('white-space', 'nowrap');
                    div3.css('text-overflow', 'ellipsis');
                    div3.css('overflow', 'hidden');
                    div3.css('position', 'absolute');
                    div3.css('left', '0%');
                    div3.css('width', '100%');
                    div3.css('height', '100%');
                    div3.css('padding-left', '1px');
                    div3.css('padding-top', '4px');
                }
                
                if ((arg.event.extendedProps.data || {}).stundenthema_text)
                {
//                     div3.append($('<div>').html('Stundenthema'));
                    if (arg.event.extendedProps.count > 1)
                    {
                        let description = $('<div>').html((arg.event.extendedProps.data || {}).stundenthema_text || '');
                        description.css('opacity', 0.7);
                        description.css('white-space', 'normal');
//                         description.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
                        div3.append(description);
                    }
                }
                
                if ((arg.event.extendedProps.data || {}).hausaufgaben_text)
                {
                    div3.append($('<div>').html('Hausaufgaben (zu heute)'));
                    if (arg.event.extendedProps.count > 1)
                    {
                        let description = $('<div>').html((arg.event.extendedProps.data || {}).hausaufgaben_text || '');
                        description.css('opacity', 0.7);
                        description.css('white-space', 'normal');
                        // description.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
                        description.css('border-top', '1px solid rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.5)');
                        
                        div3.append(description);
                    }
                }
                
                if (arg.event.extendedProps.info)
                {
                    div4.css('white-space', 'nowrap');
                    div4.css('text-overflow', 'ellipsis');
                    div4.css('overflow', 'hidden');
                    div4.css('position', 'absolute');
                    div4.css('left', '50%');
                    div4.css('width', '50%');
                    div4.css('padding-bottom', '10px');
                    div4.css('border-left', '1px solid rgba(255, 255, 255, 0.5)');
                    div4.css('padding-left', '1px');
                    div4.css('height', '100%');
                    div4.html(arg.event.extendedProps.info.title);
                    if (arg.event.extendedProps.count > 1)
                    {
                        let description = $('<div>').html(arg.event.extendedProps.info.description || '');
                        description.css('opacity', 0.7);
                        description.css('white-space', 'normal');
                        // description.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
                        description.css('border-top', '1px solid rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.5)');
                        div4.append(description);
                    }
                }
                
                div2.append(div3).append(div4);
                divs.push(div0[0]);
                divs.push(div1[0]);
                divs.push(div1b[0]);
                if (arg.event.extendedProps.count > 1)
                {
                    if ((arg.event.extendedProps.data || {}).stundenthema_text || (arg.event.extendedProps.data || {}).hausaufgaben_text || arg.event.extendedProps.info)
                        divs.push(div2[0]);
                }
                return { domNodes: divs };
            }
            else if (arg.event.extendedProps.is_event)
            {
                let event_data = arg.event.extendedProps || {};
                let divs = [];
                let div0 = $('<div>');
                div0.css('white-space', 'nowrap');
                div0.addClass('condensed');

                div0.css('opacity', 0.7);
//                 div0.html('<b>' + event_data.event_title + '</b>');
                let t = $('<span>').text(arg.timeText);
                div0.append(t);
                
                let div1 = $('<div>');
                div1.css('white-space', 'nowrap');
                let fach = $('<div>').html('<b>' + event_data.event_title + '</b>');
//                 fach.html(arg.event.extendedProps.lesson_key + '#' + arg.event.extendedProps.lesson_offset + ' ' + fach.html());
//                 if (arg.event.extendedProps.vnr)
//                     fach.html('#' + arg.event.extendedProps.vnr + ' ' + fach.html());
                div1.append(fach);
                let div1b = $('<div>').addClass('line2');
                let span = $('<span>').html(event_data.organized_by);
                span.css('opacity', 0.7);
                div1b.append(span);
                div1b.append('&nbsp;');
                
                let markers = $('<span>').addClass('cem').css('background-color', arg.event.extendedProps.entfall ? color_palette.disabled : (arg.event.extendedProps.is_event ? color_palette.shifted : color_palette.primary));
                if (event_data.jitsi)
                    markers.append($('<span>').addClass('mute').html('Jitsi'));
                div1b.append(markers);

                let div2 = $('<div>');
                let div3 = $('<div>');
                let div4 = $('<div>');
                div2.addClass('condensed');

//                 div2.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
//                 div2.css('margin-top', '2px');
                div2.css('height', '100%');

                div3.css('white-space', 'nowrap');
                div3.css('text-overflow', 'ellipsis');
                div3.css('overflow', 'hidden');
                div3.css('position', 'absolute');
                div3.css('left', '0%');
                div3.css('width', '100%');
                div3.css('height', '100%');
                div3.css('padding-left', '1px');
                div3.css('padding-top', '4px');
                
                let description = fix_bad_html($('<div>').html(event_data.description));
                description.css('opacity', 0.7);
                description.css('white-space', 'normal');
                // description.css('border-top', '1px solid rgba(255, 255, 255, 0.5)');
                description.css('border-top', '1px solid rgba(#{hex_to_rgb(color_palette[:main_text]).map { |x| x.to_s }.join(', ')}, 0.5)');
                div3.append(description);
                
                div2.append(div3).append(div4);
                divs.push(div0[0]);
                divs.push(div1[0]);
                divs.push(div1b[0]);
                divs.push(div2[0]);
                return { domNodes: divs };
            } else {
                let divs = [];
                let div0 = $('<div>');
                div0.css('white-space', 'nowrap');
                div0.addClass('condensed');

                div0.css('opacity', 0.7);
                let t = $('<span>').text(arg.timeText);
                div0.append(t);
                divs.push(div0[0]);
                let div = $('<div>').html(arg.event.title).addClass('hide-br');
                div.css('overflow', 'hidden').css('white-space', 'nowrap');
                divs.push(div[0]);
                return { domNodes: divs };
            }
        },
        eventClick: function(info) {
            $('.show-ha-amt-only').hide();
            $('.ha-amt-container').hide();

            let event = info.event.extendedProps;
            if (event.href) {
                window.open(event.href, '_blank');
                return;
            }
//             console.log(event.lesson_key, event.lesson_offset);
            if (typeof(event.datum) === 'undefined') {
                console.log(info);
                console.log(info.event);
                event = {
                    datum: info.event.startStr,
                    vertretungs_text: info.event.title,
                    omit_time: true
                };
            }
            console.log(event);
            if (ha_amt_lesson_keys.indexOf(event.lesson_key) >= 0)
            {
                $('.show-ha-amt-only').show();
                $('.bu-enter-ha-amt-text').show();
            }

            $('.bu-discard-ha-amt-text-changes').hide();
            $('.bu-save-ha-amt-text-changes').hide();

            $('#lessonModal .lesson-label').html(event.label_lang || '');
            $('#lessonModal .raum-label').html(event.raum || '');
            if (event.vertretungs_text)
                $('#lessonModal .vertretungs-text').html(event.vertretungs_text).show();
            else
                $('#lessonModal .vertretungs-text').hide();
                
            if (event.is_event) {
                $('#lessonModal .lesson-label').html('<b>' + event.event_title + '</b>');
            }
            
            let d = new Date(event.datum);
            if (event.omit_time) {
                $('#lessonModal .zeitpunkt').html(weekdays_long[d.getDay()] + 
                    ', den ' + event.datum.substr(8, 2) + 
                    '.' + event.datum.substr(5, 2) + 
                    '.' + event.datum.substr(0, 4)
                );
            } else {
                $('#lessonModal .zeitpunkt').html(weekdays_long[d.getDay()] + 
                    ', den ' + event.datum.substr(8, 2) + 
                    '.' + event.datum.substr(5, 2) + 
                    '.' + event.datum.substr(0, 4) +
                    ' (' + parseInt(info.event.startStr.substr(11, 2)) + 
                    ':' + info.event.startStr.substr(14, 2) + 
                    ' &dash; ' + parseInt(info.event.endStr.substr(11, 2)) +
                    ':' + info.event.endStr.substr(14, 2) + ')'
                );
            }

            let offsets = [];
            for (let i = 0; i < 1; i++)
                offsets.push(event.lesson_offset + i);
            if (my_lessons.indexOf(event.lesson_key) >= 0 && event.lesson_offset !== null && event.lesson_offset >= 0)
                $('#lessonModal .bu-edit-lesson').attr('href', '/lessons/' + event.lesson_key + '#' + offsets.join(',')).show();
            else
                $('#lessonModal .bu-edit-lesson').hide();
            $('#lessonModal').data('lesson-key', event.lesson_key);
            $('#lessonModal').data('lesson-offset', event.lesson_offset);
            let body = $('#lessonModal .lesson-infos-here');
            body.empty();
            let wrote_something = (event.vertretungs_text || '').length > 0;
            
            if (event.is_event) {
                body.append('<div>Einladung erhalten von: ' + event.organized_by + '</div>');
                body.append('<hr />');
                if (event.jitsi) {
                    let jitsi_link = '/jitsi/event/' + event.eid;
                    body.append($('<a>').attr('href', jitsi_link).attr('target', '_blank').addClass('float-right').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-microphone'></i>&nbsp;&nbsp;Zum Jitsi-Raum&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                    body.append($('<div>').html('Die Veranstaltung findet per Jitsi Meet statt.'));
                    body.append("<hr style='margin-top: 30px;'/>");
                }
                let description = fix_bad_html($('<div>').html(event.description));
                body.append(description);
                wrote_something = true;
                if ('#{@session_user[:email]}' === event.organized_by_email)
                    $('#lessonModal .bu-edit-lesson').attr('href', '/events#' + event.eid).show();
                else
                    $('#lessonModal .bu-edit-lesson').hide();
//                 body.append($('<a>').attr('href', jitsi_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-microphone'></i>&nbsp;&nbsp;Zum Jitsi-Raum&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
            }
            let event_data = event.data || {};
            let per_user = event.per_user || {};
            if (event_data.stundenthema_text) {
                if (wrote_something)
                    body.append('<hr>');
                body.append('<p><b>Stundenthema</b></p>');
                if (event_data.stundenthema_text)
                    body.append(`<p style='white-space: pre-line;'>${event_data.stundenthema_text}</p>`);
                wrote_something = true;
            }
            let nc_ausgabe_link = '#';
            let nc_einsammel_link = '#';
            if (event.nc_folder) {
                nc_ausgabe_link = '#{NEXTCLOUD_URL}/index.php/apps/files/?dir=/Unterricht/' + event.nc_folder + '/Ausgabeordner';
                nc_einsammel_link = '#{NEXTCLOUD_URL}/index.php/apps/files/?dir=/Unterricht/' + event.nc_folder + '/' + event.nc_collect_folder;
            }
            let jitsi_link = '#';
            if ((((event.klassen || [])[0]) || []).length === 1) {
                let klasse = event.klassen[0][0];
                if (#{PROVIDE_CLASS_STREAM} && klasse !== '11' && klasse !== '12')
                {
                    jitsi_link = '/jitsi/Klassenstreaming' + klasse;
                }
            }
            if (jitsi_link === '#')
                jitsi_link = '/jitsi/lesson/' + event.lesson_key;
            if (teacher_tablet_logged_in)
            {
                jitsi_link += '@' + encodeURI(window.selected_shorthand);
            }
            if (event_data.booked_tablet_sets) {
                if (`${event_data.booked_tablet_sets_total_count}` > 1) {
                    let p = $('<p>').html(`F√ºr diese Unterrichtsstunde wurden insgesamt <strong>${event_data.booked_tablet_sets_total_count} Ger√§te</strong> reserviert. Bitte bringen Sie sie gleich nach dem Unterricht wieder zur√ºck.`);
                    body.append(p);
                } else {
                    let p = $('<p>').html(`F√ºr diese Unterrichtsstunde wurde insgesamt <strong>ein Ger√§t</strong> reserviert. Bitte bringen Sie es gleich nach dem Unterricht wieder zur√ºck.`);
                    body.append(p);
                }
                let list = $('<ul>');
                body.append(list);
                for (let tablet_set_id of event_data.booked_tablet_sets) {
                    let is_tablet = `${tablet_set_info[tablet_set_id].is_tablet_set}` === 'true';
                    let count = is_tablet ? ` (${tablet_set_info[tablet_set_id].count} Tablets) ` : '';
                    let item = $('<li>').html(`<strong>${tablet_set_id}</strong>${count}: ${tablet_set_info[tablet_set_id].standort}`);//<br/>___PRINT_HINTS_HERE___Die Tablets werden schon 5 Minuten nach Stundenende schon wieder gebraucht)`);
                    list.append(item);
                }
                wrote_something = true;
            }
            let contact_person_sus = event.contact_person_sus || [];
            if (contact_person_sus.length > 0) {
                let p = $('<p>').html(`In dieser Unterrichtsstunde befinde${contact_person_sus.length === 1 ? 't': 'n'} sich ${contact_person_sus.length} SuS, die Kontaktpersonen sind: ${contact_person_sus.map((x) => {return `<div class='bg-#{SALZH_MODE_COLORS[:contact_person]}' style='display: inline-block; padding: 2px 4px; margin: -2px 0px; border-radius: 4px;'>${x}</div>`; }).join(', ')}.`);
                body.append(p);
                wrote_something = true;
            }
            let salzh_sus = event.salzh_sus || [];
            if (salzh_sus.length > 0) {
                let p = $('<p>').html(`In dieser Unterrichtsstunde befinde${salzh_sus.length === 1 ? 't': 'n'} sich ${salzh_sus.length} SuS im saLzH: ${salzh_sus.map((x) => {return `<div class='bg-#{SALZH_MODE_COLORS[:salzh]}' style='display: inline-block; padding: 2px 4px; margin: -2px 0px; border-radius: 4px;'>${x}</div>`; }).join(', ')}.`);
                body.append(p);
                wrote_something = true;
            }
            if (event_data.lesson_jitsi || event_data.lesson_nc || event_data.lesson_lr) {
                if (event_data.lesson_jitsi) {
                    let p = $('<p>');
                    p.append('F√ºr diese Unterrichtsstunde wird ein Jitsi Meet-Stream bereitgestellt. ');
                    if (event_data.booked_tablet) {
                        p.append(`Das Tablet ${event_data.booked_tablet_label_long} ist f√ºr Sie reserviert. Bitte bringen Sie es gleich nach dem Unterricht wieder zur√ºck.`);
                    }
                    body.append(p);
                }
                if (event_data.lesson_jitsi) {
                    body.append($('<a>').attr('href', jitsi_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-microphone'></i>&nbsp;&nbsp;Zum Jitsi-Raum&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                    let names_div = $('<div>');
                    body.append(names_div);
                    jitsi_refresh_config.jitsi_names_div = names_div;
                    if ('#{sus_logged_in?}' === 'true' && event_data.breakout_rooms && event_data.breakout_room_participants) {
                        if (event_data.breakout_rooms_roaming) {
                            body.append($('<hr />'));
                            body.append($('<p>').text(`F√ºr diese Unterrichtsstunde stehen au√üerdem die folgenden Gruppenr√§ume zur Verf√ºgung. Bitte geh zuerst in den normalen Jitsi-Raum.`));
                            for (let group_room_name of event_data.breakout_rooms) {
                                let breakout_room_link = `/jitsi/lesson/${event.lesson_key}/${group_room_name}`;
                                body.append($('<a>').attr('href', breakout_room_link).attr('target', '_blank').addClass('btn').addClass('btn-sm').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html(`<i class='fa fa-microphone'></i>&nbsp;&nbsp;${group_room_name}&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>`));
                            }
                            body.append($('<hr />'));
                        } else {
                            let sus_offset = event.schueler_offset_in_lesson;
                            let group_room_name = event_data.breakout_rooms[event_data.breakout_room_participants[sus_offset]];
                            let breakout_room_link = `/jitsi/lesson/${event.lesson_key}/${group_room_name}`;
                            body.append($('<hr />'));
                            body.append($('<p>').text(`Du bist au√üerdem in den Gruppenraum ¬ª${group_room_name}¬´ eingeteilt. Bitte geh zuerst in den normalen Jitsi-Raum.`));
                            body.append($('<a>').attr('href', breakout_room_link).attr('target', '_blank').addClass('btn').addClass('btn-sm').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html(`<i class='fa fa-microphone'></i>&nbsp;&nbsp;Zum Gruppenraum ¬ª${group_room_name}¬´&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>`));
                            body.append($('<hr />'));
                        }
                    }
                    if ('#{teacher_logged_in?}' === 'true') {
                        if (event_data.breakout_rooms && event_data.breakout_room_participants) {
                            let first_room = true;
                            jitsi_refresh_config.jitsi_breakout_rooms_names_divs = [];
                            for (let group_room_name of event_data.breakout_rooms) {
                                body.append($('<hr />'));
                                let breakout_room_link = `/jitsi/lesson/${event.lesson_key}/${group_room_name}`;
                                body.append($('<a>').attr('href', breakout_room_link).attr('target', '_blank').addClass('btn').addClass('btn-sm').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html(`<i class='fa fa-microphone'></i>&nbsp;&nbsp;${group_room_name}&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>`));
                                let names_div = $('<div>');
                                body.append(names_div);
                                jitsi_refresh_config.jitsi_breakout_rooms_names_divs.push(names_div);
                            }
                        }
                        jitsi_refresh_config.lesson_key = event.lesson_key;
                        jitsi_refresh_config.lesson_offset = event.lesson_offset;
                        body.append($('<hr />'));
                        let missing_names_div = $('<div>').css('font-style', 'italic').addClass('muted');
                        body.append(missing_names_div);
                        jitsi_refresh_config.jitsi_missing_names_div = missing_names_div;
                        refresh_jitsi_presence();
                        jitsi_refresh_config.poll_handle = setInterval(function() {
                            refresh_jitsi_presence();
                        }, 10000);
                    }
                }
                    
                let parts = [];
                if (event_data.lesson_nc)
                    parts.push('in der Nextcloud');
                if (event_data.lesson_lr)
                    parts.push('im Lernraum');
                let first = parts.slice(0, parts.length - 1).join(', ');
                let second = [parts[parts.length - 1]];
                if (first.length > 0)
                    second.unshift(first);
                if (event_data.lesson_nc || event_data.lesson_lr) {
                    let label = second.join(' und ');
                    body.append('<p>Es befindet sich Unterrichtsmaterial ' + label + '.</p>');
                }
                if (event_data.lesson_nc) {
                    body.append($('<a>').attr('href', nc_ausgabe_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-nextcloud'></i>&nbsp;&nbsp;Zum Ausgabe-Ordner&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                    body.append($('<a>').attr('href', nc_einsammel_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-nextcloud'></i>&nbsp;&nbsp;Zum Einsammel-Ordner&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                }
                if (event_data.lesson_lr)
                    body.append($('<a>').attr('href', 'https://www.lernraum-berlin.de/').attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-external-link'></i>&nbsp;&nbsp;Zum Lernraum&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                wrote_something = true;
            }
            if (teacher_tablet_logged_in || klassenraum_logged_in) {
                if (!event_data.lesson_jitsi) {
                    if (event.lesson_key !== 0) {
                        console.log(event);
                        body.append($('<div>').addClass('alert').addClass('alert-warning').html("Diese Stunde ist bisher nicht als Jitsi-Stunde markiert. Sie k√∂nnen dies nun nachholen und den Raum betreten. Beachten Sie bitte, dass es eine Minute dauern kann, bis diese √Ñnderung bei Ihren Sch√ºlerinnen und Sch√ºlern zu sehen ist (diese m√ºssen daf√ºr auch ihren Stundenplan neu laden). Bitte markieren Sie die Stunden &ndash; wenn m√∂glich &ndash; mit etwas Vorlauf, damit die Information rechtzeitig bei Ihren Sch√ºlerinnen und Sch√ºlern angezeigt wird."));
                        let button = $('<button>').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-microphone'></i>&nbsp;&nbsp;Jitsi f√ºr diese Stunde aktivieren und per Jitsi Meet beitreten&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>");
                        button.data('jitsi_link', jitsi_link);
                        button.data('lesson_key', event.lesson_key);
                        button.data('lesson_offset', event.lesson_offset);
                        body.append(button);
                        button.click(function(e) {
                            let button_data = $(e.target).data();
                            console.log(button_data);
                            api_call('/api/force_jitsi_for_lesson', {lesson_key: button_data.lesson_key, lesson_offset: button_data.lesson_offset}, function(data) {
                                if (data.success)
                                    window.location.href = jitsi_link;
                            });
                        });
                    } else {
                        body.append($('<div>').addClass('alert').addClass('alert-warning').html("F√ºr diese Stunde k√∂nnen Sie momentan leider kein Jitsi Meet aktivieren, da es sich um eine Vertretungsstunde handelt."));
                    }
                }
            }
            if (event_data.hausaufgaben_text || event_data.homework_nc || event_data.homework_lr) {
                if (wrote_something)
                    body.append('<hr>');
                body.append('<p><b>Hausaufgaben</b> (zu heute)</p>');
                if (event_data.hausaufgaben_text)
                    body.append("<p style='white-space: pre-line;'>" + event_data.hausaufgaben_text + '</p>');
                if (event_data.homework_nc) {
                    body.append('<p><b>Nextcloud</b></p>');
                    body.append($('<a>').attr('href', nc_ausgabe_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-nextcloud'></i>&nbsp;&nbsp;Zum Ausgabe-Ordner&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                    body.append($('<a>').attr('href', nc_einsammel_link).attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-nextcloud'></i>&nbsp;&nbsp;Zum Einsammel-Ordner&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                }
                if (event_data.homework_lr)
                    body.append($('<a>').attr('href', 'https://www.lernraum-berlin.de/').attr('target', '_blank').addClass('btn').addClass('btn-primary').css('margin-right', '5px').css('margin-bottom', '5px').html("<i class='fa fa-external-link'></i>&nbsp;&nbsp;Zum Lernraum&nbsp;&nbsp;<i class='fa fa-angle-double-right'></i>"));
                if (per_user.homework_feedback)
                {
                    let parts = [];
                    if (per_user.homework_feedback.state)
                        parts.push(per_user.homework_feedback.state);
                    if (per_user.homework_feedback.time_spent)
                        parts.push(`ben√∂tigte Zeit: ${per_user.homework_feedback.time_spent}`);
                    if (parts.length > 0)
                        body.append($('<p>').text('Feedback von SuS: ' + parts.join(', ')));
                }

                wrote_something = true;
            }
            if (event_data.notizen) {
                if (wrote_something)
                    body.append('<hr>');
                body.append('<p><b>Notizen</b> (nur f√ºr mich sichtbar)</p>');
                if (event_data.notizen)
                    body.append('<p>' + event_data.notizen + '</p>');
                wrote_something = true;
            }
            if (per_user.text_comments || per_user.audio_comments) {
                if (wrote_something)
                    body.append('<hr>');
                body.append('<p><b>R√ºckmeldungen</b></p>');
                let read_entries = [];
                for (let entry of (per_user.text_comments || [])) {
                    body.append($('<div>').addClass('text-comment').append($('<div>').addClass('from').html(entry.from)).append($('<div>').addClass('message').html(entry.comment)));
                    if (unread_message_ids.indexOf(entry.id) >= 0)
                        read_entries.push(entry.id);
                }
                for (let entry of (per_user.audio_comments || [])) {
                    let player = create_audio_player(entry.from, entry.tag, entry.duration / 1000);
                    body.append(player);
                    if (unread_message_ids.indexOf(entry.id) >= 0)
                        read_entries.push(entry.id);
                }
                if (read_entries.length > 0) {
                    api_call('/api/mark_as_read', {ids: read_entries}, function(data) {
                        if (data.success) {
                            unread_message_ids = data.new_unread_ids;
                            if (unread_message_ids.length > 0) {
                                $('.new-messages-indicator span').html('' + unread_message_ids.length);
                                $('.new-messages-indicator-mini span').html('' + unread_message_ids.length);
                            } else {
                                $('.new-messages-indicator span').html('');
                                $('.new-messages-indicator-mini span').html('');
                                $('.new-messages-indicator').hide();
                                $('.new-messages-indicator-mini').hide();
                            }
                        }
                    });
                }
                wrote_something = true;
            }
            if (!wrote_something) {
                if (tablet_logged_in)
                    body.append("<div class='text-muted'><i>(in diesem Modus werden keine weiteren Informationen angezeigt)</i></div>");
                else
                    body.append("<div class='text-muted'><i>(keine weiteren Informationen)</i></div>");
            }

            if (per_user.can_have_sus_feedback) {
                if (teacher_logged_in) {
                    $('.sus-notes-here').empty().show().append($('<hr>'));
                    // $('.sus-notes-here').append($('<b>Notizen von Sch√ºlerinnen und Sch√ºlern:</b>'));
                    for (let entry of (sus_for_my_lessons[event.lesson_key] || [])) {
                        if ((per_user.lesson_notes[entry.email] || '').length > 0) {
                            $('.sus-notes-here').append($(`<p style='margin-bottom: 0.5rem;'>`).html(`<b>${entry.display_name}:</b> ${per_user.lesson_notes[entry.email]}`));
                        }
                    }
                    let missing_sus = [];
                    for (let entry of (sus_for_my_lessons[event.lesson_key] || [])) {
                        if ((per_user.lesson_notes[entry.email] || '').length === 0) {
                            missing_sus.push(entry.display_name);
                        }
                    }
                    if (missing_sus.length > 0) {
                        $('.sus-notes-here').append($('<hr>'));
                        $('.sus-notes-here').append($(`<p>`).html(`<em>Keine R√ºckmeldung von: ${missing_sus.join(', ')}</em>`));
                    }
                    // sus_for_my_lessons

                } else {
                    $('.sus-notes-here').show();
                    $('#ta_sus_notes').data('lesson_key', event.lesson_key);
                    $('#ta_sus_notes').data('lesson_offset', event.lesson_offset);
                    $('#ta_sus_notes').val(((lesson_notes[event.lesson_key] || {})[event.lesson_offset]) || '');
                }
            }
            else
                $('.sus-notes-here').hide();

            $('#lessonModal').modal('show');
        }
    };
    if ('#{!!@session_user[:teacher]}' === 'false') {
        let d0 = moment(initial_date).day(1).subtract(28, 'days').format('YYYY-MM-DD');
        options.validRange = {
            start: d0
        };
    }

    window.calendar = new FullCalendar.Calendar(document.getElementById('calendar'), options);
    window.calendar.render();
    $('#lessonModal').on('hidden.bs.modal', function() {
        if (pb_playing)
        {
            pb_audio.pause();
            pb_url = null;
        }
        clear_polling_handler();
    });
    
    if (!tablet_logged_in) {
        let uri = '/gen/w/' + timetable_id + '/homework.json.gz';
        if (#{@session_user[:teacher] ? true: false})
            uri += '?' + Date.now();
        let oReq = new XMLHttpRequest();
        oReq.open('GET', uri, true);
        oReq.responseType = 'arraybuffer';
        
        function handle_homework(homework) {
            let last_date = null;
            if (homework.length > 0)
            {
                $('.future_homework').append($('<p><b>Hausaufgaben</b></p>'));
                $('.future_homework').show();
            }
            for (let entry of homework) {
                if (entry.datum !== last_date) {
                    $('.future_homework').append($('<hr />'));
                    $('.future_homework').append($('<p>').html(moment(entry.datum).format('ddd, D.M.Y')));
                }
                last_date = entry.datum;
                let div = $("<p style='white-space: pre-line;'>").html('<b>' + entry.fach + ':</b> ' + entry.text.join('<br />'));
                $('.future_homework').append(div);
                if ((entry.est_time || 0) > 0)
                    $('.future_homework').append($('<p>').html(`Geplanter Zeitaufwand: ${entry.est_time} Minuten`));
                if ('#{!!sus_logged_in?}' === 'true') {
                    let bu_done = $('<div>').addClass('dropdown');
                    bu_done.data('lesson_key', entry.lesson_key);
                    bu_done.data('offset', entry.offset);
                    bu_done.data('homework', entry);
                    let mi_button = $('<button>').addClass('btn').addClass('btn-sm').addClass('dropdown-toggle').attr('data-toggle', 'dropdown').css('margin-bottom', '5px');
                    let dropdown_menu = $('<div>').addClass('dropdown-menu');
                    let mi_set_undone = $('<button>').addClass('dropdown-item').addClass('bu-set-undone').html("<i class='fa fa-clock-o'></i>noch nicht erledigt");
                    let mi_set_done = $('<button>').addClass('dropdown-item').addClass('bu-set-done').html("<i class='fa fa-check'></i>erledigt");
                    let mi_feedback = $('<button>').addClass('dropdown-item').html("<i class='fa fa-comment-o'></i>Feedback geben‚Ä¶");
                    if (homework_feedback[`${entry.lesson_key}/${entry.offset}`].done) {
                        mi_button.addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;erledigt");
                        mi_set_done.hide();
                    } else {
                        mi_button.addClass('btn-outline-secondary').html("<i class='fa fa-clock-o'></i>&nbsp;&nbsp;noch nicht erledigt");
                        mi_set_undone.hide();
                    }
                    bu_done.append(mi_button);
                    dropdown_menu.append(mi_set_undone);
                    dropdown_menu.append(mi_set_done);
                    dropdown_menu.append($('<div>').addClass('dropdown-divider'));
                    dropdown_menu.append(mi_feedback);
                    bu_done.append(dropdown_menu);
                    $('.future_homework').append(bu_done);
                    mi_set_done.click(function(e) {
                        let parent = $(e.target).closest('.dropdown');
                        let lesson_key = parent.data('lesson_key');
                        let offset = parent.data('offset');
                        let button = parent.find('.dropdown-toggle');
                        api_call('/api/mark_homework_done', {lesson_key: lesson_key, offset: offset}, function(data) {
                            if (data.success) {
                                homework_feedback[`${lesson_key}/${offset}`].done = true;
                                button.removeClass('btn-outline-secondary').addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;erledigt");
                                parent.find('.bu-set-done').hide();
                                parent.find('.bu-set-undone').show();
                            }
                        });
                    });
                    mi_set_undone.click(function(e) {
                        let parent = $(e.target).closest('.dropdown');
                        let lesson_key = parent.data('lesson_key');
                        let offset = parent.data('offset');
                        let button = parent.find('.dropdown-toggle');
                        button.removeClass('btn-success').addClass('btn-outline-secondary').html("<i class='fa fa-clock-o'></i>&nbsp;&nbsp;noch nicht erledigt");
                        parent.find('.bu-set-undone').hide();
                        parent.find('.bu-set-done').show();
                        api_call('/api/mark_homework_undone', {lesson_key: lesson_key, offset: offset}, function(data) {
                            if (data.success) {
                                homework_feedback[`${lesson_key}/${offset}`].done = false;
                                button.removeClass('btn-success').addClass('btn-outline-secondary').html("<i class='fa fa-clock-o'></i>&nbsp;&nbsp;noch nicht erledigt");
                                parent.find('.bu-set-done').show();
                                parent.find('.bu-set-undone').hide();
                            }
                        });
                    });
                    mi_feedback.click(function(e) {
                        let parent = $(e.target).closest('.dropdown');
                        let lesson_key = parent.data('lesson_key');
                        let offset = parent.data('offset');
                        let homework = parent.data('homework');
                        $('#homeworkFeedbackModal').data('lesson_key', lesson_key);
                        $('#homeworkFeedbackModal').data('offset', offset);
                        $('#homeworkFeedbackModal .hw-fb-fach').text(homework.fach);
                        $('#homeworkFeedbackModal .hw-fb-lehrer').text(homework.lehrer);
                        $('#homeworkFeedbackModal .hw-fb-lehrer-genitiv').text(homework.lehrer.replace(/Herr/g, 'Herrn'));
                        $('#homeworkFeedbackModal .hw-fb-est-time').text(homework.est_time);
                        $('#homeworkFeedbackModal .hw-fb-hw-date').text(moment(entry.datum).format('ddd, D.M.Y'));
                        $('#homeworkFeedbackModal').on('shown.bs.modal', function () {
                            $('#ti_hw_spent_minutes').focus();
                        });
                        $('#ti_hw_spent_minutes').val();
                        if ((homework.est_time || 0) > 0)
                            $('.hw-fb-got-est-time').show();
                        else
                            $('.hw-fb-got-est-time').hide();
                        $('.feedback_submit_error').hide();
                        $('.feedback_submit_success').hide();
                        $('#homeworkFeedbackModal .hf-emoji').removeClass('selected');
                        let current_feedback = homework_feedback[`${lesson_key}/${offset}`] || {};
                        $(`#homeworkFeedbackModal .hf-emoji[data-feedback=${current_feedback.state}]`).addClass('selected');
                        $('#homeworkFeedbackModal #ti_hw_spent_minutes').val(current_feedback.time_spent || '');
//                         
                        $('#bu_send_homework_feedback').prop('disabled', true);
                        $('#homeworkFeedbackModal').modal('show');
                    });
                }
            }
        }

        oReq.onload = function(e) {
            if (e.target.status === 200) {
                let data = pako.ungzip(oReq.response);
                let bb = new Blob([new Uint8Array(data)]);
                let f = new FileReader();
                f.onload = function(e) {
                    let homework = JSON.parse(e.target.result);
                    let request_items = [];
                    for (let entry of homework)
                        request_items.push(`${entry.lesson_key}/${entry.offset}`);
                    if ('#{!!sus_logged_in?}' === 'true') {
                        api_call('/api/get_homework_feedback', {entries: request_items}, function(data) {
                            if (data.success) {
                                homework_feedback = data.homework_feedback;
                                handle_homework(homework);
                            }
                        });
                    } else {
                        handle_homework(homework);
                    }
                };
                f.readAsText(bb);
            }
        };
        oReq.send();
    }

    if (tablet_logged_in) {
        window.selected_shorthand = $($('.ttc.active')[0]).text();
        history.replaceState({}, '', '/timetable/');
//         if (window.selected_shorthand.length === 0) {
//             if ($('.tablet_timetable_chooser .ttc').length === 1) {
//                 $($('.tablet_timetable_chooser .ttc')[0]).click();
//             }
//         }
    }
    $('.hf-emoji').click(function(e) {
        let flag = $(e.target).closest('.hf-emoji').hasClass('selected');
        $(e.target).closest('.row').find('.hf-emoji').removeClass('selected');
        if (!flag)
            $(e.target).closest('.hf-emoji').addClass('selected');
        else
            $(e.target).closest('.hf-emoji').removeClass('selected');
        $('#bu_send_homework_feedback').prop('disabled', false);
    });
    $('#ti_hw_spent_minutes').change(function() {
        $('#bu_send_homework_feedback').prop('disabled', false);
    });
    $('#ti_hw_spent_minutes').keyup(function() {
        $('#bu_send_homework_feedback').prop('disabled', false);
    });
    
    $('#bu_send_homework_feedback').click(function() {
        let submit_data = {};
        submit_data.lesson_key = $('#homeworkFeedbackModal').data('lesson_key');
        submit_data.offset = $('#homeworkFeedbackModal').data('offset');
        submit_data.state = '';
        submit_data.time_spent = 0;
        let state = $('.hf-emoji.selected').data('feedback');
        if (typeof(state) !== 'undefined')
            submit_data.state = state;
        if ($('#ti_hw_spent_minutes').val().trim().length > 0)
            submit_data.time_spent = parseInt($('#ti_hw_spent_minutes').val().trim());
//         console.log(submit_data);
        $('.feedback_submit_error').hide();
        $('.feedback_submit_success').hide();
        api_call('/api/update_homework_feedback', submit_data, function(data) {
            if (data.success) {
                if (typeof(data.error) !== 'undefined') {
                    $('#homeworkFeedbackModal .feedback_submit_error_message').text(': ' + data.error);
                    $('#homeworkFeedbackModal .feedback_submit_error').fadeIn();
                } else {
                    $('#homeworkFeedbackModal .feedback_submit_success').fadeIn();
                    $('#bu_send_homework_feedback').prop('disabled', true);
                    homework_feedback[`${submit_data.lesson_key}/${submit_data.offset}`].state = submit_data.state;
                    homework_feedback[`${submit_data.lesson_key}/${submit_data.offset}`].time_spent = submit_data.time_spent;
                }
            } else {
                $('#homeworkFeedbackModal .feedback_submit_error_message').text('');
                $('#homeworkFeedbackModal .feedback_submit_error').fadeIn();
            }
        });
    });

    $('#bu_minimize_salzh_explanation').click(function(e) {
        $('#salzh_explanation').slideUp();
        api_call('/api/minimize_salzh_explanation');
    });

    for (x of ['keydown', 'keyup', 'change']) {
        $('#ta_ha_amt_text').on(x, function(e) {
            update_ha_amt_buttons();
        });
    }
    $('.bu-enter-ha-amt-text').click(function(e) {
        api_call('/api/get_ha_amt_text_for_lesson', {lesson_key: $('#lessonModal').data('lesson-key'), lesson_offset: $('#lessonModal').data('lesson-offset')}, function(data) {
            if (data.success) {
                $('#ta_ha_amt_text').val(data.ha_amt_text);
                $('#ta_ha_amt_text').data('stored_ha_amt_text', data.ha_amt_text);
                update_ha_amt_buttons();
                $('.bu-enter-ha-amt-text').hide();
                $('.bu-discard-ha-amt-text-changes').show();
                $('.bu-save-ha-amt-text-changes').show();
                $('.ha-amt-container').slideDown();
            }
        });
    });
    $('.bu-save-ha-amt-text-changes').click(function(e) {
        api_call('/api/set_ha_amt_text_for_lesson', {lesson_key: $('#lessonModal').data('lesson-key'), 
            lesson_offset: $('#lessonModal').data('lesson-offset'),
            ha_amt_text: $('#ta_ha_amt_text').val().trim()}, function(data) {
            if (data.success) {
                $('#lessonModal').modal('hide');
            }
        });
    });
    $('.bu-discard-ha-amt-text-changes').click(function(e) {
        $('#lessonModal').modal('hide');
    });
    let temp = '#{Digest::SHA1.hexdigest(@session_user[:email] + 'hey')}';
    if (temp === '1df442d73157838343b7f13f5111772228a7adb3')
        rsag();
    for (let x of $('.btn')) {
        install_physics_handler($(x));
    }
    for (let x of $('.fc-button')) {
        install_physics_handler($(x));
    }
    for (let x of $('a.nav-link')) {
        install_physics_handler($(x));
    }
    setTimeout(function() {
        for (let x of $('.fc-daygrid-event-harness')) {
            install_physics_handler($(x));
        }
    }, 1000);
    $('.bu-add-self-test').click(function(e) {
        showTemplateModal('Testung protokollieren',
                'Falls Sie sich <strong>heute</strong> getestet haben oder getestet worden sind <strong>und der Test negativ war</strong>, protokollieren Sie dieses Ergebnis nun bitte.',
                "<i class='fa fa-check'></i>&nbsp;&nbsp;Negativen Test protokollieren", 'btn-success',
                'Abbrechen', 'btn-secondary', function () {
                    api_call('/api/add_self_test_for_today', {}, function (data) {
                        if (data.success) {
                            window.location.reload();
                        }
                    });
                }
            );
    });
    $('#ta_sus_notes').change(function(e) {
        let data = {
            text: $('#ta_sus_notes').val().trim(),
            lesson_key: $('#ta_sus_notes').data('lesson_key'),
            lesson_offset: $('#ta_sus_notes').data('lesson_offset')
        };
        api_call('/api/set_hybrid_notes', data, function(data2) {
            if (data2.success) {
                if (!(data.lesson_key in lesson_notes))
                    lesson_notes[data.lesson_key] = {};
                lesson_notes[data.lesson_key][data.lesson_offset] = data.text;
                if (data.text.length === 0)
                    $(`#icon_hybrid_notes_${data.lesson_key}_${data.lesson_offset}`).removeClass('fa-file-text-o').addClass('fa-file-o');
                else
                    $(`#icon_hybrid_notes_${data.lesson_key}_${data.lesson_offset}`).removeClass('fa-file-o').addClass('fa-file-text-o');
            }
        });
    });
    $('.bu_open_ad_hoc_2fa_request').click(function(e) {
        let email = $(e.target).data('email');
        let name = $(e.target).data('name');
        api_call('/api/fresh_2fa_credentials_for_user', {email: email}, function(data) {
            console.log(data);
            $('.ad_hoc_login_name_here').text(name);
            $('#ad_hoc_login_email_here').text(email);
            $('.div_ad_hoc_fresh_sms').hide();
            $('.div_ad_hoc_fresh_otp').hide();
            if (data.has_fresh_sms)
                $('.div_ad_hoc_fresh_sms').show();
            if (data.has_fresh_otp)
                $('.div_ad_hoc_fresh_otp').show();
            $('#adHoc2FaRequestModal').modal('show');
        });
    })
    $('#bu_perform_ad_hoc_signin').click(function(e) {
        api_call('/api/allow_ad_hoc_2fa_request', {email: $('#ad_hoc_login_email_here').text()}, function(data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.bu_unlock_2fa_sms').click(function(e) {
        api_call('/api/unlock_2fa_sms_now', {email: $('#ad_hoc_login_email_here').text()}, function(data) {
            $('.div_ad_hoc_fresh_sms').hide();
        });
    });
    $('.bu_unlock_2fa_otp').click(function(e) {
        api_call('/api/unlock_2fa_otp_now', {email: $('#ad_hoc_login_email_here').text()}, function(data) {
            $('.div_ad_hoc_fresh_otp').hide();
        });
    });
    window.addEventListener('load', function() {
        if ($('#tresor_countdown_here').length > 0) {
            setInterval(function() {
                let ts0 = moment();
                let deadline = $('#tresor_countdown_here').data('deadline');
                let ts1 = moment.unix(deadline);
                if (ts0.isBefore(ts1)) {
                    let d = moment.duration(ts1.diff(ts0));
                    let h = Math.floor(d.asHours());
                    let m = Math.floor(d.asMinutes()) - h * 60;
                    let s = Math.floor(d.asSeconds()) - h * 60 * 60 - m * 60;
                    h = `${h}`; m = `${m}`; s = `${s}`;
                    if (h.length < 2) h = '0' + h;
                    if (m.length < 2) m = '0' + m;
                    if (s.length < 2) s = '0' + s;
                    $('#tresor_countdown_here').text(`${h} : ${m} : ${s}`);
                    $('#tresor_countdown_here').slideDown();
                } else {
                    $('#tresor_countdown_here').slideUp();
                }
            }, 1000);
        }
    });
});


</script>
