#{this_is_a_page_for_logged_in_teachers_or_sv}
<div class='container'>
    <div class='row'>
        <div class='col-md-12'>
            <h2 style='margin-bottom: 30px;'>Umfragen</h2>
            <button class='btn btn-success bu-new-poll'><i class='fa fa-plus-circle'></i>&nbsp;&nbsp;Neue Umfrage</button>
            <hr />
            <div class='polls-here'>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title lb_title">Umfrage</h5>
            </div>
            <div class="modal-body" style='min-height: 300px;'>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class="form-group">
<!--                             <label>Titel</label> -->
                            <input id='ti_title' class='form-control' type='text' placeholder='Bitte geben Sie den Titel der Umfrage ein'></input>
                        </div>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class='poll-items-here'></div>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class='fa fa-plus-circle'></i>&nbsp;&nbsp;Eintrag hinzufügen
                            </button>
                            <div class="dropdown-menu">
                                <a class='dropdown-item bu-poll-add-paragraph btn btn-success'><i class='fa fa-align-left'></i>&nbsp;&nbsp;Text hinzufügen</a>
<!--                                 <a class='dropdown-item bu-poll-add-image btn btn-success'><i class='fa fa-photo'></i>&nbsp;&nbsp;Bild hinzufügen</a> -->
                                <a class='dropdown-item bu-poll-add-radio btn btn-success'><i class='fa fa-list'></i>&nbsp;&nbsp;Auswahl hinzufügen</a>
                                <a class='dropdown-item bu-poll-add-checkbox btn btn-success'><i class='fa fa-list'></i>&nbsp;&nbsp;Mehrfachauswahl hinzufügen</a>
                                <a class='dropdown-item bu-poll-add-textarea btn btn-success'><i class='fa fa-i-cursor'></i>&nbsp;&nbsp;Freitextfeld hinzufügen</a>
<!--                                 <a class='dropdown-item bu-poll-add-likert btn btn-success'><i class='fa fa-list'></i>&nbsp;&nbsp;Likert-Skala hinzufügen</a> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id='save_poll_btn_container'>
                    <button id='bu_discard_poll' class='btn btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;<span>Verwerfen</span></button>
                    <button id='bu_save_poll' class='btn btn-outline-secondary' disabled><i class='fa fa-check'></i>&nbsp;&nbsp;<span>Speichern</span></button>
                </div>
                <button id='bu_close_poll_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="pollRunModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title lb_run_poll_title">Umfrage durchführen</h5>
            </div>
            <div class="modal-body" style='min-height: 300px;'>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class="form-group">
                            <label>Titel</label>
                            <input id='ti_poll_run_poll_title' disabled readonly class='form-control' type='text' placeholder='Bitte geben Sie den Titel des Termins ein'></input>
                        </div>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class="form-group" style='margin-bottom: 0;'>
                            <label><span class='float-right anonymous_hint text-danger'>Bitte wählen Sie die Art der Erfassung. Sie kann später nicht mehr geändert werden.</span>Anonymität</label>
                        </div>
                    </div>
                    <div class='col-md-6'>
                        <div class="form-group">
                        <button id='bu_poll_run_anonymous' class='form-control' style='overflow: hidden;'><i class='fa fa-user-secret'></i>&nbsp;&nbsp;Anonyme Erfassung der Umfrageergebnisse</button>
                        </div>
                    </div>
                    <div class='col-md-6'>
                        <div class="form-group">
                        <button id='bu_poll_run_non_anonymous' class='form-control' style='overflow: hidden;'><i class='fa fa-user'></i>&nbsp;&nbsp;Personengebundene Erfassung der Umfrageergebnisse</button>
                        </div>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-2'>
                        <div class="form-group">
                            <label>Beginn</label>
                            <input type="date" class="form-control" id='ti_run_start_date' value='#{Date.today.to_s}' />
                        </div>
                    </div>
                    <div class='col-md-2'>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <input type="time" class="form-control" id='ti_run_start_time' value='08:00' />
                        </div>
                    </div>
                    <div class='col-md-2'>
                        <div class="form-group">
                            <label>Ende</label>
                            <input type="date" class="form-control" id='ti_run_end_date' value='#{Date.today.to_s}' />
                        </div>
                    </div>
                    <div class='col-md-2'>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <input type="time" class="form-control" id='ti_run_end_time' value='10:00' />
                        </div>
                    </div>
                    <div class='col-md-4'>
                        <div class="form-group">
                            <label>Spontane Umfrage (ab jetzt)</label>
                            <div class="btn-group" style='width: 100%;'>
                                <button type="button" class="bu-poll-run-spontaneous-dropdown btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Zeitdauer wählen
                                </button>
                                <div class="dropdown-menu">
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='10'>10 Minuten ab jetzt</a>
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='20'>20 Minuten ab jetzt</a>
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='30'>30 Minuten ab jetzt</a>
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='45'>45 Minuten ab jetzt</a>
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='60'>60 Minuten ab jetzt</a>
                                    <a class='dropdown-item bu-poll-run-spontaneous btn btn-success' data-minutes='90'>90 Minuten ab jetzt</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="form-group">
                    <label style='width: 100%;'><a href='#' style='display: #{teacher_logged_in? ? 'inline' : 'none'}' class='bu_open_ext_users_modal float-right btn btn-success'>Externe Teilnehmer…</a>Teilnehmer <span class='text-muted'>(nur diesen Personen wird die Umfrage angezeigt)</span>
                    </label>
                    <input id='ti_recipients' class='form-control' placeholder='Teilnehmer suchen…' /><div class='recipient-input-dropdown' style='display: none;'></div></input>
<!--                    <div style='font-size: 80%; margin-top: 10px;'>
                    </div>-->
                </div>
                <div class="form-group">
                    <div class='recipients_list'>
                    </div>
                    <p style='margin-top: 10px;' id='recipient_count'>keine Teilnehmer</p>
                </div>
                <div class="form-group div_ext_users_for_poll_run_present">
                    <label style='width: 100%;'>Externe Teilnehmer</label>
                    <div class='alert alert-info'>
                        Sie möchten externe Teilnehmer einladen, die sich nicht im Dashboard anmelden können. Diese Teilnehmer benötigen deshalb einen Link per E-Mail, über den sie an der Umfrage teilnehmen können.
                    </div>
                    <div class='alert alert-danger div_invites_missing' style='display: none;'>
                        Noch nicht alle externen Teilnehmer haben eine Einladung erhalten. Gehen Sie bitte wie folgt vor:
                        <ol>
                        <li>Klicken Sie, falls Sie ungespeicherte Änderungen vorgenommen haben, unten auf »Speichern« oder »Änderungen speichern«</li>
                        <li>Klicken Sie hier, um die fehlenden Einladungen per E-Mail zu versenden:</li>
                        </ol>
                        <div style='text-align: center;'>
                            <button class='btn btn-success' id='bu_send_missing_invitations' disabled><i class='fa fa-send'></i>&nbsp;&nbsp;Fehlende Einladungen versenden</button>
                        </div>
                    </div>
                    <div class='alert alert-warning div_invites_requested' style='display: none;'>
                        Es werden momentan Einladungen versendet. Bitte schauen Sie später noch einmal nach, ob alle Einladungen versendet werden konnten.
                    </div>
                    <div class='alert alert-success div_invites_complete' style='display: none;'>
                        Alle externen Teilnehmer haben eine Einladung erhalten. Sie können bei Bedarf einzelne Einladungen neu versenden.
                    </div>
                    <table class='table table-striped narrow'>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Gesendete Einladungen</th>
                            <th>Einladung senden</th>
                        </tr>
                    </thead>
                    <tbody class='ext-users-for-poll-run-here'>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div id='save_poll_run_btn_container'>
                    <button id='bu_discard_poll_run' class='btn btn-outline-secondary' disabled><i class='fa fa-times'></i>&nbsp;&nbsp;<span>Verwerfen</span></button>
                    <button id='bu_save_poll_run' class='btn btn-outline-secondary' disabled><i class='fa fa-check'></i>&nbsp;&nbsp;<span>Speichern</span></button>
                </div>
                <button id='bu_close_poll_run_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="externalUsersModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adressbuch für externe Teilnehmer</h5>
            </div>
            <div class="modal-body">
                <p class='text-muted'>
                Fügen Sie externe Teilnehmer hinzu, indem Sie Nutzer im Format <code>Vorname Nachname &lt;E-Mail-Adresse&gt;</code> hinzufügen, also z. B. <code>Max Mustermann &lt;max@example.com&gt;</code>. Trennen Sie mehrere Teilnehmer durch ein Komma oder einen Zeilenumbruch. Die Teilnehmer, die Sie hier eintragen, können Sie für alle Ihre Termine und Umfragen einladen, sie müssen also nur einmal hinzugefügt werden.
                </p>
                <p class='text-muted'>
                Bitte beachten Sie, dass alle Teilnehmer, die hier aufgeführt sind, noch nicht unbedingt zu Ihrem Termin eingeladen sind. Sie müssen, wie reguläre Teilnehmer auch, über das Suchfeld hinzugefügt werden.
                </p>
                <!--<p><span style='padding: 0 5px; background-color: #f4c9c5; color: #d5291a'>Achtung:</span> Bitte beachten Sie, dass hierfür die Einwilligung zur Speicherung der E-Mail-Adresse für jeden Teilnehmer vorliegen muss.
                </p>-->
                <textarea id='ti_add_ext_users' class='form-control'></textarea>
                <button id='bu_add_ext_users' class='btn btn-success float-right' style='margin: 10px 0;' disabled>Teilnehmer hinzufügen</button>
                <table class='table table-striped narrow'>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>E-Mail</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody class='ext-users-here'>
                </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id='bu_close_ext_user_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<script>
var recipients = {};
var recipients_cache = {};
var autocomplete_results = {};
var recipients_list = {};
var net_recipients_list = [];
var has_external_recipients = false;
var old_title = ''
var old_recipients_list = [];
var old_description = '';
var old_pid = null;
var stored_polls = #{stored_polls.to_json};
var stored_poll_runs = #{stored_poll_runs.to_json};
var external_users_for_session_user = #{external_users_for_session_user.to_json};
var antikenfahrt_recipients = #{@@antikenfahrt_recipients.to_json};
CAN_HANDLE_EXTERNAL_USERS = true;
var force_close = false;
var current_poll = {};
var stored_poll_json = null;
var old_prid = null;
var current_poll_run = {};
var current_poll_run_poll = null;
var stored_poll_run_json = null;

function _update_bold_font(e) {
    $(e).css('font-weight', ($(e).val().trim().length > 0) ? 'bold' : 'normal');
}

function install_bold_font_if_not_empty(e) {
    _update_bold_font(e);
    e.keydown(function(e) { _update_bold_font(e.target); });
    e.keyup(function(e) { _update_bold_font(e.target); });
    e.change(function(e) { _update_bold_font(e.target); });
}

function can_send() {
    return true; //(net_recipients_list.length > 0) && $('#ti_title').val().trim().length > 0;
}

function can_send_run() {
    return (net_recipients_list.length > 0) && (current_poll_run.anonymous !== null);
    // TODO: Don't send if end time < start time
}

function pending_changes() {
    let flag = false;
    let current_poll_json = JSON.stringify(current_poll);
    if (current_poll_json !== stored_poll_json)
        flag = true;
    return flag;
}

function pending_changes_run() {
    let flag = false;
    let current_poll_run_json = JSON.stringify(current_poll_run);

//     console.log(stored_poll_run_json);
//     console.log(current_poll_run_json);

    if (current_poll_run_json !== stored_poll_run_json)
        flag = true;
    if (old_recipients_list.join('/') !== net_recipients_list.join('/'))
        flag = true;
    if (flag)
        $('.bu-send-invitation').prop('disabled', true).removeClass('btn-success').addClass('btn-outline-secondary');
    $('#bu_send_missing_invitations').prop('disabled', flag);
    return flag;
}

function update_buttons() {
    if (old_pid) {
        $('#bu_discard_poll span').html('Änderungen verwerfen');
        $('#bu_save_poll span').html('Änderungen speichern');
    } else {
        $('#bu_discard_poll span').html('Verwerfen');
        $('#bu_save_poll span').html('Speichern');
    }
    if (pending_changes()) {
        $('#bu_discard_poll').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        $('#bu_close_poll_modal').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        if (can_send())
            $('#bu_save_poll').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
        else
            $('#bu_save_poll').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
    } else {
        $('#bu_discard_poll').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        $('#bu_close_poll_modal').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        $('#bu_save_poll').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
    }
}

function discard_poll() {
    force_close = true;
    $('#composeModal').modal('hide');
}

function discard_poll_run() {
    force_close = true;
    $('#pollRunModal').modal('hide');
}

function save_poll() {
    let submit_data = {
        title: $('#ti_title').val().trim(),
        items: JSON.stringify(current_poll.items)
    };
    if (old_pid === null) {
        api_call('/api/save_poll', submit_data, function(data) {
            if (data.success) {
                current_poll.items = JSON.parse(data.items);
                stored_poll_json = JSON.stringify(current_poll);
                console.log(data);
                stored_polls.unshift(data.poll);
                old_pid = data.poll.pid;
                update_buttons();
                update_stored_polls();
                update_current_poll();
            }
        });
    } else {
        submit_data.pid = old_pid;
        api_call('/api/update_poll', submit_data, function(data) {
            if (data.success) {
                current_poll.items = JSON.parse(data.items);
                stored_poll_json = JSON.stringify(current_poll);
                stored_polls = stored_polls.map(function(e) {
                    if (e.pid === data.pid)
                        e = data.poll;
                    return e;
                });
//                 force_close = true;
//                 $('#composeModal').modal('hide');
                update_buttons();
                update_stored_polls();
                update_current_poll();
            }
        });
    }
}

function save_poll_run() {
    let submit_data = {
        pid: current_poll_run.pid,
        anonymous: current_poll_run.anonymous ? 'true' : 'false',
        start_date: current_poll_run.start_date,
        start_time: current_poll_run.start_time,
        end_date: current_poll_run.end_date,
        end_time: current_poll_run.end_time,
        recipients: net_recipients_list
    };
    old_recipients_list = [...net_recipients_list];
    if (old_prid === null) {
        api_call('/api/save_poll_run', submit_data, function(data) {
            if (data.success) {
                $('#bu_poll_run_anonymous').prop('disabled', true);
                $('#bu_poll_run_non_anonymous').prop('disabled', true);
                $('#ti_run_start_date').prop('disabled', true);
                $('#ti_run_start_time').prop('disabled', true);
                $('.bu-poll-run-spontaneous-dropdown').prop('disabled', true);
                stored_poll_run_json = JSON.stringify(current_poll_run);
                data.poll_run.pid = current_poll_run.pid;
                stored_poll_runs.unshift(data.poll_run);
                old_prid = data.poll_run.prid;
                update_net_recipients_list();
                update_run_buttons();
                update_stored_polls();
            }
        });
    } else {
        submit_data.prid = old_prid;
        api_call('/api/update_poll_run', submit_data, function(data) {
            if (data.success) {
                stored_poll_run_json = JSON.stringify(current_poll_run);
                console.log('data', data);
                console.log(stored_poll_runs);
                stored_poll_runs = stored_poll_runs.map(function(pr) {
                    if (pr.prid === data.poll_run.prid) {
                        let pid = pr.pid;
                        pr = data.poll_run;
                        pr.pid = pid;
                    }
                    return pr;
                });
                console.log(stored_poll_runs);
                update_net_recipients_list();
                update_run_buttons();
                update_stored_polls();
            }
        });
    }
}

function delete_poll(pid) {
    if (!pid)
        return;
    api_call('/api/delete_poll', {pid: pid}, function(data) {
        if (data.success) {
            $('#composeModal').modal('hide');
            stored_polls = stored_polls.filter(x => x.pid !== data.pid);
            update_stored_polls();
        }
    });
}

function delete_poll_run(prid) {
    if (!prid)
        return;
    api_call('/api/delete_poll_run', {prid: prid}, function(data) {
        if (data.success) {
            old_recipients_list = net_recipients_list;
            $('#pollRunModal').modal('hide');
            stored_poll_runs = stored_poll_runs.filter(x => x.prid !== data.prid);
            update_stored_polls();
        }
    });
}

function update_run_buttons() {
    if (old_prid) {
        $('#bu_discard_poll_run span').html('Änderungen verwerfen');
        $('#bu_save_poll_run span').html('Änderungen speichern');
    } else {
        $('#bu_discard_poll_run span').html('Verwerfen');
        $('#bu_save_poll_run span').html('Speichern');
    }
    if (pending_changes_run()) {
        $('#bu_discard_poll_run').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        $('#bu_close_poll_run_modal').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        if (can_send_run())
            $('#bu_save_poll_run').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
        else
            $('#bu_save_poll_run').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
    } else {
        $('#bu_discard_poll_run').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
        $('#bu_close_poll_run_modal').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        $('#bu_save_poll_run').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
    }
    if (current_poll_run.anonymous === null)
        $('.anonymous_hint').show();
    else
        $('.anonymous_hint').hide();
}

function update_net_recipients_list() {
    let net_recipients_hash = {};
    for (let key in recipients_list) {
        let entry = recipients[key];
        if (entry.entries)
            for (let email of entry.entries)
                net_recipients_hash[email] = true;
        else
            net_recipients_hash[key] = true;
    }
    net_recipients_list = Object.keys(net_recipients_hash).sort();
    has_external_recipients = false;

    api_call('/api/get_external_invitations_for_poll_run', {prid: old_prid || ''}, function(data) {
        console.log('/api/get_external_invitations_for_poll_run for ', old_prid, data);
        $('.div_ext_users_for_poll_run_present').hide();
        $('.ext-users-for-poll-run-here').empty();
        let missing_invites = false;
        let requested_invites = false;
        for (let email of net_recipients_list) {
            if (email in external_users_for_session_user.recipients) {
                $('.div_ext_users_for_poll_run_present').show();
                let row = $('<tr>');
                let this_invitations = data.invitations[email] || [];
                let this_invitation_requested = data.invitation_requested[email];
                row.append($('<td>').text(external_users_for_session_user.recipients[email].label));
                row.append($('<td>').text(email));
                if (this_invitations.length === 0) {
                    row.append($('<td>').html('&ndash;'));
                    missing_invites = true;
                } else {
                    row.append($('<td>').html(this_invitations.map(function(x) { return '' + x; }).join('<br />')));
                }
                if (this_invitation_requested)
                    requested_invites = true;
                let bu_invite = $('<button>').data('email', email).data('prid', old_prid).addClass('btn').addClass('btn-xs').addClass('btn-success').addClass('bu-send-invitation').html("<i class='fa fa-send'></i>&nbsp;&nbsp;Einladung senden");
                if ((old_prid || '').length === 0)
                    bu_invite.removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);
                row.append($('<td>').append(bu_invite));
                bu_invite.click(function(e) {
                    let prid = $(e.target).closest('.btn').data('prid');
                    let email = $(e.target).closest('.btn').data('email');
                    api_call('/api/invite_external_user_for_poll_run', {prid: prid, email: email}, function(data) {
                        if (data.success)
                            update_net_recipients_list();
                    });
                });
                $('.ext-users-for-poll-run-here').append(row);
            }
        }
        if (missing_invites) {
            if (requested_invites) {
                $('.div_invites_complete').hide();
                $('.div_invites_missing').hide();
                $('.div_invites_requested').show();
            } else {
                $('.div_invites_complete').hide();
                $('.div_invites_missing').show();
                $('.div_invites_requested').hide();
            }
        } else {
            $('.div_invites_complete').show();
            $('.div_invites_missing').hide();
            $('.div_invites_requested').hide();
        }
        if (net_recipients_list.length === 0)
            $('#recipient_count').html('keine Teilnehmer');
        else
            $('#recipient_count').html('' + net_recipients_list.length + ' Teilnehmer');
        update_run_buttons();
    });
}

function gen_recipient_span(key, with_rm) {
    if (!(key in recipients))
        recipients[key] = {label: key};
    let label = recipients[key].label;
    if (recipients[key].entries)
        label += ' (' + recipients[key].entries.length + ')';
    let recipient = $('<span>').addClass('recipient').html(label);
    if (with_rm) {
        let rm_button = $('<span>').addClass('rm').data('key', key);
        rm_button.click(function(e) {
            remove_recipient($(e.target).data('key'));
            $(e.target).closest('.recipient').remove();
        });
        recipient.addClass('with-rm').append(rm_button);
    }
    if (recipients[key].teacher)
        recipient.addClass('teacher');
    recipient.data('key', key);
    return recipient;
}

function add_recipient(key) {
    if (!(key in recipients_list)) {
        recipients_list[key] = true;
        $('.recipients_list').append(gen_recipient_span(key, true));
    }
    $('.recipient-input-dropdown').hide();
    $('#ti_recipients').val('');
    $('#ti_title').focus();
    update_net_recipients_list();
}

function remove_recipient(key) {
    delete recipients_list[key];
    update_net_recipients_list();
}

function compact_address_list(emails) {
    let result = [];
    for (let key of recipients_cache.groups) {
        let all_in = true;
        for (let email of recipients[key].entries) {
            if (emails.indexOf(email) < 0) {
                all_in = false;
                break;
            }
        }
        if (all_in) {
            result.push(key);
            let new_emails = [];
            for (let email of emails)
                if (recipients[key].entries.indexOf(email) < 0)
                    new_emails.push(email);
            emails = new_emails;
        }
    }
    for (let email of emails)
        result.push(email);
    return result;
}

function edit_poll(pid) {
    let poll = null;
    for (let _ of stored_polls)
        if (_.pid === pid)
            poll = _;
    if (poll === null)
        return;
    old_pid = poll.pid;
    $('#composeModal').modal('show');
    force_close = false;
    $('#ti_title').val(poll.poll.title);
    _update_bold_font($('#ti_title'));
    current_poll = {title: poll.poll.title, items: JSON.parse(poll.poll.items)};
    stored_poll_json = JSON.stringify(current_poll);
    $('#ti_recipients').val('');
    $('#ti_recipients').focus();
    update_buttons();
    update_current_poll();
}

function update_stored_polls() {
    $('.polls-here').empty();
    let poll_runs_for_poll = {};
    for (let poll_run of stored_poll_runs) {
        if (!(poll_run.pid in poll_runs_for_poll))
            poll_runs_for_poll[poll_run.pid] = [];
        poll_runs_for_poll[poll_run.pid].push(poll_run);
    }
    let first_poll = true;
    for (let poll of stored_polls) {
        if (!first_poll)
            $('.polls-here').append($('<hr />'));
        first_poll = false;
        let div = $('<div>').addClass('poll-div').data('pid', poll.pid);
        $('.polls-here').append(div);
        let bu_container = $('<div>').addClass('float-right').addClass('button-container');
        let bu_run_poll = $('<button>').addClass('btn').addClass('btn-sm').addClass('btn-success').html("<i class='fa fa-play'></i>&nbsp;&nbsp;Neue Durchführung");
        let bu_delete_poll = $('<button>').addClass('btn').addClass('btn-sm').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
        let bu_edit_poll = $('<button>').addClass('btn').addClass('btn-sm').addClass('btn-secondary').html("<i class='fa fa-edit'></i>&nbsp;&nbsp;Bearbeiten");
        div.append(bu_container);
        bu_container.append(bu_edit_poll);
        bu_container.append(bu_delete_poll);
        bu_container.append(bu_run_poll);
        div.append($('<h4>').text(poll.poll.title));
        div.append($('<p>').text(`Erstellt am ${moment(poll.created).format('ddd, D.M.Y')}`));
        bu_edit_poll.click(function(e) {
            e.stopPropagation();
            let pid = $(e.target).closest('.poll-div').data('pid');
            edit_poll(pid);
        });
        bu_delete_poll.click(function(e) {
            e.stopPropagation();
            let pid = $(e.target).closest('.poll-div').data('pid');
            (function(pid) {
                showTemplateModal('Umfrage löschen',
                    'Sind Sie sicher, dass Sie diese Umfrage löschen möchten?',
                    "<i class='fa fa-trash'></i>&nbsp;&nbsp;Umfrage löschen", 'btn-danger',
                    'Abbrechen', 'btn-secondary', function() {
                        delete_poll(pid);
                    }
                );
            })(pid);
        });
        bu_run_poll.click(function(e) {
            e.stopPropagation();
            let pid = $(e.target).closest('.poll-div').data('pid');
            new_poll_run(pid);
        });
        if ((poll_runs_for_poll[poll.pid] || []).length > 0) {
            for (let poll_run of (poll_runs_for_poll[poll.pid] || [])) {
                let run_div = $('<div>').addClass('poll-run-div').data('prid', poll_run.prid).data('pid', poll.pid);
                $('.polls-here').append(run_div);

                let m_start = moment(`${poll_run.info.start_date}T${poll_run.info.start_time}:00`);
                let row = $('<tr>');
                let diff = moment(`${poll_run.info.end_date}T${poll_run.info.end_time}:00`).unix() - moment(`${poll_run.info.start_date}T${poll_run.info.start_time}:00`).unix();
                let duration = moment.duration(diff * 1000);
                duration_parts = [];
                if (duration.days() > 0)
                    duration_parts.push(`${duration.days()} Tage`);
                if (duration.hours() > 0)
                    duration_parts.push(`${duration.hours()} Stunden`);
                if (duration.minutes() > 0)
                    duration_parts.push(`${duration.minutes()} Minuten`);
                if (duration_parts.length === 0)
                    duration_parts.push(`0 Minuten`);
                let diff_to_start_time = moment(`${poll_run.info.start_date}T${poll_run.info.start_time}:00`).unix() - moment().unix();
                let diff_to_end_time = moment().unix() - moment(`${poll_run.info.end_date}T${poll_run.info.end_time}:00`).unix();
                let icon = '';
                let color = '';
                let label = '';
                let state = '';
                if (diff_to_start_time > 0) {
                    // we're before the poll run
                    state = 'pending';
                    icon = 'clock-o';
                    color = 'warning';
                    label = 'ausstehend';
                } else if (diff_to_end_time > 0) {
                    // we're after the poll run
                    state = 'complete';
                    icon = 'check'
                    color = 'primary';
                    label = 'abgeschlossen';
                } else {
                    // we're within the poll run
                    state = 'running';
                    icon = 'play'
                    color = 'success';
                    label = 'läuft';
                }
                let percent = Math.floor(poll_run.response_count * 100 / poll_run.recipients.length);
                if (isNaN(percent))
                    percent = 0;
                let bu_container = $('<div>').addClass('float-right').addClass('button-container-vertical');
                let bu_poll_run_show_results = $('<button>').css('margin-left', '4px').addClass('btn').addClass('btn-primary').addClass('btn-sm').html(`<i class='fa fa-bar-chart'></i>&nbsp;&nbsp;Ergebnisse (${percent}% beantwortet)`);
                let bu_poll_run_edit = $('<button>').css('margin-left', '4px').addClass('btn').addClass('btn-secondary').addClass('btn-sm').html("<i class='fa fa-edit'></i>&nbsp;&nbsp;Durchführung bearbeiten");
                let bu_poll_run_stop = $('<button>').css('margin-left', '4px').addClass('btn').addClass('btn-danger').addClass('btn-sm').html(`<i class='fa fa-times'></i>&nbsp;&nbsp;Umfrage stoppen`);
                let bu_poll_run_delete = $('<button>').css('margin-left', '4px').addClass('btn').addClass('btn-danger').addClass('btn-sm').html(`<i class='fa fa-trash'></i>&nbsp;&nbsp;Durchführung löschen`);
                let cell = $('<td>').css('text-align', 'right').css('overflow', 'visible');
                if (state === 'running')
                    bu_container.append(bu_poll_run_stop);
                if (state === 'complete' || state === 'running')
                    bu_container.append(bu_poll_run_show_results);
    //             if (state === 'pending')
                bu_container.append(bu_poll_run_edit);
                if (state !== 'running')
                    bu_container.append(bu_poll_run_delete);
                run_div.append(bu_container);
                run_div.append($('<p>').text(`Durchführung mit ${poll_run.recipients.length} Teilnehmern am ${m_start.format('ddd, D.M.Y')}`));
                run_div.append($('<div>').html(`Status:&nbsp;&nbsp;<i class='fa fa-${icon} text-${color}'></i>&nbsp;&nbsp;${label}`));
                run_div.append($('<div>').html(`${m_start.format('ddd, D.M.Y, HH:mm')} Uhr (${duration_parts.join(', ')})`));
                run_div.append($('<div>').html(`${poll_run.recipients.length} Teilnehmer (${poll_run.info.anonymous ? 'anonym' : 'personengebunden'})`));
                bu_poll_run_show_results.click(function(e) {
                    e.stopPropagation();
                    let pid = $(e.target).closest('.poll-run-div').data('pid');
                    let prid = $(e.target).closest('.poll-run-div').data('prid');
                    show_poll_run_results(prid);
                });
                bu_poll_run_edit.click(function(e) {
                    e.stopPropagation();
                    let pid = $(e.target).closest('.poll-run-div').data('pid');
                    let prid = $(e.target).closest('.poll-run-div').data('prid');
                    edit_poll_run(prid);
                });
                bu_poll_run_stop.click(function(e) {
                    e.stopPropagation();
                    let pid = $(e.target).closest('.poll-run-div').data('pid');
                    let prid = $(e.target).closest('.poll-run-div').data('prid');
                    showTemplateModal('Umfrage stoppen',
                        'Sind Sie sicher, dass Sie diese Umfrage stoppen möchten?',
                        "<i class='fa fa-times'></i>&nbsp;&nbsp;Umfrage stoppen", 'btn-danger',
                        'Abbrechen', 'btn-secondary', function() {
                            stop_poll_run(prid);
                        }
                    );
                });
                bu_poll_run_delete.click(function(e) {
                    e.stopPropagation();
                    let pid = $(e.target).closest('.poll-run-div').data('pid');
                    let prid = $(e.target).closest('.poll-run-div').data('prid');
                    showTemplateModal('Durchführung löschen',
                        'Sind Sie sicher, dass Sie diese Durchführung löschen möchten?',
                        "<i class='fa fa-trash'></i>&nbsp;&nbsp;Durchführung löschen", 'btn-danger',
                        'Abbrechen', 'btn-secondary', function() {
                            delete_poll_run(prid);
                        }
                    );
                });
            }
        }
    };
}

function update_external_users_for_session_user() {
    $('.ext-users-here').empty();
    for (let email of external_users_for_session_user.order) {
        let row = $('<tr>');
        row.append($('<td>').html(external_users_for_session_user.recipients[email].label));
        row.append($('<td>').html(email));
//         let bu_toggle = $('<button>').data('email', email).addClass('btn').addClass('btn-xs').addClass('btn-secondary').html("<i class='fa fa-times'></i>&nbsp;&nbsp;nicht eingeladen");
//         row.append($('<td>').append(bu_toggle));
        let bu_delete = $('<button>').data('email', email).addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>");
        row.append($('<td>').append(bu_delete));
        bu_delete.click(function(e) {
            showTemplateModal('Externen Teilnehmer löschen',
                'Sind Sie sicher, dass Sie diesen externen Teilnehmer aus Ihrem Adressbuch löschen möchten?',
                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Externen Teilnehmer löschen", 'btn-danger',
                'Abbrechen', 'btn-secondary', function() {
                    let email = $(e.target).closest('.btn').data('email');
                    api_call('/api/delete_external_user', {email: email}, function(data) {
                        if (data.success) {
                            external_users_for_session_user = data.ext_users;
                            update_external_users_for_session_user();
                            load_recipients('#{@session_user[:id]}', function() {}, external_users_for_session_user);
                        }
                    });
                }
            );
        });
        $('.ext-users-here').append(row);
    };
}

function update_current_poll() {
    $('#ti_title').val(current_poll.title);
    _update_bold_font($('#ti_title'));
    let div = $('.poll-items-here');
    div.empty();
    let item_types = {
        paragraph: 'Text (zur Information, keine Eingabe möglich)',
        radio: 'Auswahl (nur eine Antwort kann ausgewählt werden)',
        checkbox: 'Mehrfachauswahl',
        image: 'Bild',
        textarea: 'Freitext (Nutzer können Freitext eingeben)'
    };
    for (let item_index in current_poll.items) {
        item_index = parseInt(item_index);
        let item = current_poll.items[item_index];

        let button_div = $('<div>').addClass('float-right');//.css('margin', '10px 0');
        let bu_rm = $('<button>').attr('title', 'Eintrag löschen').addClass('ml-1').addClass('btn').addClass('btn-sm').addClass('btn-danger').html("<i class='fa fa-trash'></i>").data('item-index', item_index);
        let bu_up = $('<button>').attr('title', 'Eintrag nach oben verschieben').addClass('ml-1').addClass('btn').addClass('btn-sm').addClass('btn-primary').html("<i class='fa fa-arrow-up'></i>").data('item-index', item_index);
        let bu_down = $('<button>').attr('title', 'Eintrag nach untern verschieben').addClass('ml-1').addClass('btn').addClass('btn-sm').addClass('btn-primary').html("<i class='fa fa-arrow-down'></i>").data('item-index', item_index);
        if (item_index === 0)
            bu_up.prop('disabled', true);
        if (item_index === current_poll.items.length - 1)
            bu_down.prop('disabled', true);
        button_div.append(bu_rm);
        button_div.append(bu_up);
        button_div.append(bu_down);
        bu_rm.click(function(e) {
            let item_index = $(e.target).closest('.btn').data('item-index');
            current_poll.items.splice(item_index, 1);
            update_current_poll();
        });
        bu_up.click(function(e) {
            let item_index = $(e.target).closest('.btn').data('item-index');
            let entry = current_poll.items[item_index];
            current_poll.items.splice(item_index, 1);
            current_poll.items.splice(item_index - 1, 0, entry);
            update_current_poll();
        });
        bu_down.click(function(e) {
            let item_index = $(e.target).closest('.btn').data('item-index');
            let entry = current_poll.items[item_index];
            current_poll.items.splice(item_index, 1);
            current_poll.items.splice(item_index + 1, 0, entry);
            update_current_poll();
        });
        div.append(button_div);

        let header = $('<p>');
        header.append($('<p>').css('margin-left', '4px').text('' + (item_index + 1) + '. ' + item_types[item.type]));
        div.append(header);
        let row = $('<div>').addClass('row');
        let ti_title = $('<input>').addClass('mb-2').addClass('form-control').attr('placeholder', item.type === 'paragraph' ? 'Zwischenüberschrift (optional)' : 'Bitte geben Sie eine Frage ein').val(item.title).data('item-index', item_index);
        install_bold_font_if_not_empty(ti_title);
        ti_title.change(function(e) {
            let item_index = $(e.target).data('item-index');
            current_poll.items[item_index].title = $(e.target).val().trim();
            update_buttons();
        });
        row.append($('<div>').addClass(item.type === 'checkbox' ? 'col-md-9' : 'col-md-12').append(ti_title));
        if (item.type === 'checkbox') {
            let ti_max_checks = $('<input>').addClass('mb-2').addClass('form-control').attr('placeholder', 'Auswahl einschränken (max. Antworten)').val(item.max_checks || '').data('item-index', item_index);
            row.append($('<div>').addClass('col-md-3').append(ti_max_checks));
            ti_max_checks.change(function(e) {
                let item_index = $(e.target).data('item-index');
                let n = parseInt($(e.target).val().trim());
                if (isNaN(n)) {
                    current_poll.items[item_index].max_checks = null;
                    $(e.target).val('');
                } else {
                    current_poll.items[item_index].max_checks = n;
                    $(e.target).val(`${n}`);
                }
                update_buttons();
            });
        }
        div.append(row);
        if (item.type === 'radio' || item.type === 'checkbox') {
            let bc = $('<div>').addClass('poll_radio_buttons').addClass('edit').data('item-index', item_index);
            bc.data('poll_item_type', item.type);
            for (let answer_index in item.answers) {
                answer_index = parseInt(answer_index);
                let answer = item.answers[answer_index];
                let input_group = $('<div>').addClass('input-group');
                let ti = $('<input>').attr('placeholder', 'Bitte geben Sie eine Antwortmöglichkeit ein').addClass('form-control').val(answer).attr('data-item-index', item_index).attr('data-answer-index', answer_index);
                let button_div = $('<div>').addClass('input-group-append');
                let bu_rm = $('<button>').attr('title', 'Antwortmöglichkeit löschen').addClass('btn').addClass('btn-outline-secondary').html("<i class='fa fa-trash'></i>").data('item-index', item_index).data('answer-index', answer_index);
                let bu_up = $('<button>').attr('title', 'Antwortmöglichkeit nach oben verschieben').addClass('btn').addClass('btn-outline-secondary').html("<i class='fa fa-arrow-up'></i>").data('item-index', item_index).data('answer-index', answer_index);
                let bu_down = $('<button>').attr('title', 'Antwortmöglichkeit nach unten verschieben').addClass('btn').addClass('btn-outline-secondary').html("<i class='fa fa-arrow-down'></i>").data('item-index', item_index).data('answer-index', answer_index);
                ti.change(function(e) {
                    let item_index = $(e.target).data('item-index');
                    let answer_index = $(e.target).data('answer-index');
                    let value = $(e.target).val().trim();
                    let items = value.split(';').filter(function(x) { return x.trim().length > 0; } );
                    for (let i = 0; i < items.length; i++)
                        current_poll.items[item_index].answers.splice(answer_index + i, (i == 0) ? 1 : 0, items[i].trim());
                    update_buttons();
                    if (items.length > 1)
                        update_current_poll();
                });
                if (answer_index === 0)
                    bu_up.prop('disabled', true);
                if (answer_index === item.answers.length - 1)
                    bu_down.prop('disabled', true);
                bu_rm.click(function(e) {
                    let item_index = $(e.target).closest('.btn').data('item-index');
                    let answer_index = $(e.target).closest('.btn').data('answer-index');
                    current_poll.items[item_index].answers.splice(answer_index, 1);
                    update_current_poll();
                });
                bu_up.click(function(e) {
                    let item_index = $(e.target).closest('.btn').data('item-index');
                    let answer_index = $(e.target).closest('.btn').data('answer-index');
                    let entry = current_poll.items[item_index].answers[answer_index];
                    current_poll.items[item_index].answers.splice(answer_index, 1);
                    current_poll.items[item_index].answers.splice(answer_index - 1, 0, entry);
                    update_current_poll();
                });
                bu_down.click(function(e) {
                    let item_index = $(e.target).closest('.btn').data('item-index');
                    let answer_index = $(e.target).closest('.btn').data('answer-index');
                    let entry = current_poll.items[item_index].answers[answer_index];
                    current_poll.items[item_index].answers.splice(answer_index, 1);
                    current_poll.items[item_index].answers.splice(answer_index + 1, 0, entry);
                    update_current_poll();
                });
                button_div.append(bu_rm);
                button_div.append(bu_up);
                button_div.append(bu_down);
                input_group.append(ti)
                input_group.append(button_div);
                bc.append(input_group);
            }
            div.append(bc);
            let bu_add_answer_div = $('<div>').addClass('button-with-label-relaxed');
            let bu_add_answer = $('<button>').addClass('btn').addClass('btn-sm').addClass('btn-success').html("<i class='fa fa-plus'></i>&nbsp;&nbsp;Antwortmöglichkeit hinzufügen").data('item-index', item_index);
            bu_add_answer.click(function(e) {
                let item_index = $(e.target).data('item-index');
                current_poll.items[item_index].answers.push('');
                update_current_poll();
                $('input').filter(`[data-item-index='${item_index}']`).filter(`[data-answer-index='${current_poll.items[item_index].answers.length - 1}']`).focus();
            });
            bu_add_answer_div.append(bu_add_answer);
            bu_add_answer_div.append($('<span>').text('Hinweis: Sie können mehrere Antwortmöglichkeiten auf einmal hinzufügen, indem Sie sie die einzelnen Antworten mit einem Semikolon (;) trennen.'));
            div.append(bu_add_answer_div);
        } else if (item.type === 'textarea') {
            let textarea = $('<textarea>').addClass('form-control');
            textarea.prop('disabled', true).attr('placeholder', '(Platz für Eingaben)');
            div.append(textarea);
        } else if (item.type === 'paragraph') {
            let p = $('<textarea>').addClass('form-control').val(item.text).data('item-index', item_index);
            p.change(function(e) {
                let item_index = $(e.target).data('item-index');
                current_poll.items[item_index].text = $(e.target).val().trim();
                update_buttons();
            });
            div.append(p);
        }
        div.append($('<hr />').addClass('poll-entry-divider'));
    }
    update_buttons();
}

function update_current_poll_run() {
//     $('#ti_title').val(current_poll.title);
    let div = $('.poll-run-items-here');
    div.empty();
    update_run_buttons();
}

function new_poll() {
    current_poll = {items: [], title: ''};
    stored_poll_json = JSON.stringify(current_poll);
    $('#ti_title').val('');
    _update_bold_font($('#ti_title'));
    $('#composeModal').modal('show');
    force_close = false;
    old_description = $('#summernote').summernote('code');
    old_pid = null;
    $('#ti_title').focus();
    update_buttons();
    update_current_poll();
}

function new_poll_run(pid) {
    current_poll_run = {pid: pid};
    current_poll_run.anonymous = null;
    current_poll_run_poll = null;
    for (let poll of stored_polls) {
        if (poll.pid === pid)
            current_poll_run_poll = poll;
    }
    if (current_poll_run_poll === null) {
        console.log(`Couldn't find poll with pid ${pid}!`);
        return;
    }
    $('#ti_poll_run_poll_title').val(current_poll_run_poll.poll.title);

    let minutes = 10;
    let m = moment();
    $('#ti_run_start_date').val(m.format('YYYY-MM-DD'));
    $('#ti_run_start_time').val(m.format('HH:mm'));
    m = m.add(minutes, 'minutes');
    $('#ti_run_end_date').val(m.format('YYYY-MM-DD'));
    $('#ti_run_end_time').val(m.format('HH:mm'));
    current_poll_run.start_date = $('#ti_run_start_date').val();
    current_poll_run.start_time = $('#ti_run_start_time').val();
    current_poll_run.end_date = $('#ti_run_end_date').val();
    current_poll_run.end_time = $('#ti_run_end_time').val();

    $('#bu_poll_run_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary').prop('disabled', false);
    $('#bu_poll_run_non_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary').prop('disabled', false);
    $('#ti_run_start_date').prop('disabled', false);
    $('#ti_run_start_time').prop('disabled', false);
    $('.bu-poll-run-spontaneous-dropdown').prop('disabled', false);
    old_prid = null;
    recipients_list = {};
    update_net_recipients_list();
    $('.recipients_list').empty();
    $('#pollRunModal').modal('show');
    force_close = false;
    old_recipients_list = [];
    $('#ti_recipients').val('');
    stored_poll_run_json = JSON.stringify(current_poll_run);
    update_run_buttons();
    update_current_poll_run();
}

function edit_poll_run(prid) {
    current_poll_run = null;
    for (let _ of stored_poll_runs)
        if (_.prid === prid)
            current_poll_run = _;
    if (current_poll_run === null) {
        console.log(`Couldn't find poll run with prid ${prid}!`);
        return;
    }
    let pid = current_poll_run.pid;
    current_poll_run_poll = null;
    for (let poll of stored_polls) {
        if (poll.pid === pid)
            current_poll_run_poll = poll;
    }
    if (current_poll_run_poll === null) {
        console.log(`Couldn't find poll with pid ${pid}!`);
        return;
    }
    let keep_recipients = current_poll_run.recipients;
    current_poll_run = {
        pid: current_poll_run_poll.pid,
        prid: current_poll_run.prid,
        anonymous: current_poll_run.info.anonymous,
        start_date: current_poll_run.info.start_date,
        start_time: current_poll_run.info.start_time,
        end_date: current_poll_run.info.end_date,
        end_time: current_poll_run.info.end_time
    };
    $('#ti_poll_run_poll_title').val(current_poll_run_poll.poll.title);
    console.log(current_poll_run);
    $('#ti_run_start_date').val(current_poll_run.start_date);
    $('#ti_run_start_time').val(current_poll_run.start_time);
    $('#ti_run_end_date').val(current_poll_run.end_date);
    $('#ti_run_end_time').val(current_poll_run.end_time);
    if (current_poll_run.anonymous) {
        $('#bu_poll_run_anonymous').removeClass('btn-outline-secondary').addClass('btn-primary');
        $('#bu_poll_run_non_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary');
    } else {
        $('#bu_poll_run_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary');
        $('#bu_poll_run_non_anonymous').removeClass('btn-outline-secondary').addClass('btn-primary');
    }
    $('#bu_poll_run_anonymous').prop('disabled', true);
    $('#bu_poll_run_non_anonymous').prop('disabled', true);
    $('#ti_run_start_date').prop('disabled', true);
    $('#ti_run_start_time').prop('disabled', true);
    $('.bu-poll-run-spontaneous-dropdown').prop('disabled', true);

    $('.bu-send-invitation').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-success');
    $('.recipients_list').empty();
    old_prid = current_poll_run.prid;
    recipients_list = {};
    for (let email of keep_recipients || []) {
        recipients_list[email] = true;
        $('.recipients_list').append(gen_recipient_span(email, true));
    }
    update_net_recipients_list();
    $('#pollRunModal').modal('show');
    force_close = false;
    old_recipients_list = [...net_recipients_list];
    $('#ti_recipients').val('');
    stored_poll_run_json = JSON.stringify(current_poll_run);
    update_run_buttons();
    update_current_poll_run();
}

function stop_poll_run(prid) {
    api_call('/api/stop_poll_run', {prid: prid}, function(data) {
        if (data.success) {
            console.log(stored_poll_runs);
            console.log(data);
            stored_poll_runs = stored_poll_runs.map(function(pr) {
                if (pr.prid === data.prid) {
                    pr.info.end_date = data.end_date;
                    pr.info.end_time = data.end_time;
                }
                return pr;
            });
            console.log(stored_poll_runs);
            update_run_buttons();
            update_stored_polls();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    $('#summernote').summernote({
        placeholder: 'Bitte geben Sie die Terminbeschreibung ein',
        callbacks: {
            onChange: function() {
                update_buttons();
            }
        },
        lang: 'de-DE',
        height: 300,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'clear']],
            ['fontname', ['fontname']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link']],
            ['view', ['codeview', 'help']],
        ],
    });

    $('#composeModal').on('hide.bs.modal', function(e) {
        if (pending_changes() && (!force_close)) {
            $('#save_poll_btn_container').effect('shake', {direction: 'left', distance: 4});
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    });

    $('#pollRunModal').on('hide.bs.modal', function(e) {
        if (pending_changes_run() && (!force_close)) {
            $('#save_poll_run_btn_container').effect('shake', {direction: 'left', distance: 4});
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    });

    $('.bu-new-poll').click(function(e) {
        new_poll();
    });

    $('#bu_discard_poll').click(function(e) {
        discard_poll();
    });

    $('#bu_save_poll').click(function(e) {
        save_poll();
    });

    $('#bu_save_poll_run').click(function(e) {
        save_poll_run();
    });

    $('#bu_discard_poll_run').click(function(e) {
        discard_poll_run();
    });

    $('#ti_recipients').keydown(function(e) {
        if ((e.keyCode === 9 || e.keyCode === 13) && ($(e.target).val().length > 0)) {
            if (Object.keys(autocomplete_results).length === 1) {
                let key = recipients_cache.keys[Object.keys(autocomplete_results)[0]];
                add_recipient(key);
            }
            e.preventDefault();
            e.stopPropagation();
            if (e.keyCode === 9)
                $('#ti_recipients').focus();
            return;
        }
    });
    $('#ti_recipients').keyup(function(e) {
        if ($('#ti_recipients')[0].selectionStart == $(e.target).val().length) {
            let value = $(e.target).val();
            let backspace_pressed = (e.keyCode === 8);
            let space_at_end = value[value.length - 1] == ' ';
            let search_terms = value.trim().toLowerCase().split(/\s+/);
            let results = {};
            for (let i = 0; i < search_terms.length; i++) {
                let term = search_terms[i];
                let term_results = {};
                for (let key of Object.keys(recipients_cache.index[term] || {})) {
                    term_results[key] = recipients_cache.index[term][key];
                }
                if (i == 0)
                    results = term_results;
                else {
                    for (let k of Object.keys(results)) {
                        if (k in term_results) {
                            if (term_results[k] > results[k])
                                results[k] = term_results[k];
                        } else {
                            delete results[k];
                        }
                    }
                }
            }
            autocomplete_results = results;
            result_keys = Object.keys(results).map(function(x) { return parseInt(x); });
            if (result_keys.length === 0)
                $('.recipient-input-dropdown').hide();
            else {
                if (result_keys.length === 1)
                {
                    if (!backspace_pressed) {
                        let key = recipients_cache.keys[result_keys[0]];
                        let label = recipients[key].label;
                        $('#ti_recipients').val(label);
                        $('#ti_recipients')[0].setSelectionRange(results[result_keys[0]] + (space_at_end ? 1 : 0), label.length);
                    }
                }
                result_keys.sort(function(a, b) {
                    let va = recipients[recipients_cache.keys[a]];
                    let vb = recipients[recipients_cache.keys[b]];
                    if (va.teacher === vb.teacher) {
                        if (va.label < vb.label)
                            return -1;
                        return 1;
                    } else {
                        if (va.teacher)
                            return -1;
                        return 1;
                    }
                });
                $('.recipient-input-dropdown').empty();
                for (let key of result_keys) {
                    let k = recipients_cache.keys[key];
                    let r = gen_recipient_span(k);
                    r.click(function(e) {
                        add_recipient($(e.target).data('key'));
                    });
                    $('.recipient-input-dropdown').append(r);
                }
                $('.recipient-input-dropdown').show();
            }
        }
    });
    for (let key of ['#ti_title']) {
        $(key).keyup(function(e) { update_buttons(); });
        $(key).change(function(e) { update_buttons(); });
    }
    for (let key of ['#ti_run_start_date', '#ti_run_start_time', '#ti_run_end_date', '#ti_run_end_time']) {
        $(key).keyup(function(e) { update_run_buttons(); });
        $(key).change(function(e) { update_run_buttons(); });
        $(key).blur(function(e) { update_run_buttons(); });
    }
//     $('.bu-compose').click();

    $('.btn_lesson_data').click(function(e) {
        let button = $(e.target);
        if (button.data('state') === 'yes') {
            button.removeClass('btn-info').addClass('btn-outline-secondary');
            button.find('.fa').removeClass('fa-check').removeClass('fa-question-circle').addClass('fa-times');
            button.data('state', 'no');
            button.blur();
        }
        else {
            button.removeClass('btn-outline-secondary').addClass('btn-info');
            button.find('.fa').removeClass('fa-times').removeClass('fa-question-circle').addClass('fa-check');
            button.data('state', 'yes');
        }
        update_buttons();
    });

    $('.bu_open_ext_users_modal').click(function(e) {
            $('#ti_add_ext_users').val('');
        $('#externalUsersModal').modal('show');
    });

    $('#ti_add_ext_users').keyup(function(e) {
        $('#bu_add_ext_users').prop('disabled', $('#ti_add_ext_users').val().trim().length === 0);
    });

    $('#ti_add_ext_users').change(function(e) {
        $('#bu_add_ext_users').prop('disabled', $('#ti_add_ext_users').val().trim().length === 0);
    });

    $('#bu_add_ext_users').click(function(e) {
        api_call('/api/add_external_users', {text: $('#ti_add_ext_users').val().trim()}, function(data) {
            if (data.success) {
                $('#ti_add_ext_users').val('');
                external_users_for_session_user = data.ext_users;
                update_external_users_for_session_user();
                load_recipients('#{@session_user[:id]}', function() {}, external_users_for_session_user);
            }
        });
    });

    $('#bu_send_missing_invitations').click(function(e) {
        api_call('/api/send_missing_poll_run_invitations', {prid: old_prid}, function(data) {
            console.log(data);
            if (data.success) {
                update_net_recipients_list();
                update_buttons();
            }
        });
    });

    load_recipients('#{@session_user[:id]}', function() {
        update_stored_polls();
        update_external_users_for_session_user();
        if (window.location.hash.length > 1)
        {
            let pid = window.location.hash.substr(1);
            edit_poll(pid);
            window.location.hash = '';
        }
    }, external_users_for_session_user);
//     $('.bu-new-poll').click();
    $('.bu-poll-add-paragraph').click(function(e) {
        current_poll.items.push({type: 'paragraph', title: '', text: ''});
        update_current_poll();
    });
    $('.bu-poll-add-radio').click(function(e) {
        current_poll.items.push({type: 'radio', title: '', answers: []});
        update_current_poll();
    });
    $('.bu-poll-add-checkbox').click(function(e) {
        current_poll.items.push({type: 'checkbox', title: '', answers: []});
        update_current_poll();
    });
    $('.bu-poll-add-textarea').click(function(e) {
        current_poll.items.push({type: 'textarea', title: ''});
        update_current_poll();
    });
    for (let event of ['change', 'keyup']) {
        $('#ti_title').on(event, function(e) {
            current_poll.title = $(e.target).val().trim();
            update_buttons();
        });
        for (let key of ['start_date', 'start_time', 'end_date', 'end_time']) {
            $(`#ti_run_${key}`).on(event, function(e) {
                current_poll_run[key] = $(e.target).val().trim();
                update_buttons();
            });
        }
    }
    install_bold_font_if_not_empty($('#ti_title'));
    $('.bu-poll-run-spontaneous').click(function(e) {
        let minutes = parseInt($(e.target).data('minutes'));
        let m = moment();
        $('#ti_run_start_date').val(m.format('YYYY-MM-DD'));
        $('#ti_run_start_time').val(m.format('HH:mm'));
        m = m.add(minutes, 'minutes');
        $('#ti_run_end_date').val(m.format('YYYY-MM-DD'));
        $('#ti_run_end_time').val(m.format('HH:mm'));
        current_poll_run.start_date = $('#ti_run_start_date').val();
        current_poll_run.start_time = $('#ti_run_start_time').val();
        current_poll_run.end_date = $('#ti_run_end_date').val();
        current_poll_run.end_time = $('#ti_run_end_time').val();
        update_run_buttons();
    });
    $('#bu_poll_run_anonymous').click(function(e) {
        current_poll_run.anonymous = true;
        $('#bu_poll_run_anonymous').removeClass('btn-outline-secondary').addClass('btn-primary');
        $('#bu_poll_run_non_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary');
        update_run_buttons();
    });
    $('#bu_poll_run_non_anonymous').click(function(e) {
        current_poll_run.anonymous = false;
        $('#bu_poll_run_non_anonymous').removeClass('btn-outline-secondary').addClass('btn-primary');
        $('#bu_poll_run_anonymous').addClass('btn-outline-secondary').removeClass('btn-primary');
        update_run_buttons();
    });
//     if ('#{!!DEVELOPMENT}' === 'true')
//         new_poll_run(stored_polls[0].pid);
    setInterval(function() {
        update_stored_polls();
    }, 60000);
});
</script>
