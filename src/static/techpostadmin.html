#{this_is_a_page_for_user_with_role(:can_manage_tablets)}
<style>
    body {
        background-image: none;
        background-color: #{(@session_user || {})[:dark] ? '#000' : '#fff'};
    }
</style>
<div class='container-fluid white'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style="margin-bottom: 30px;">Technikamt (Admin)</h2>
            <hr>
            <p>
                Du bist #{(admin_logged_in?) ? 'Admin im Dashboard' : 'Teil des TechnikTeams'} und kannst deshalb hier Probleme mit Geräten aufnehmen und auch <b>schließen</b>. Auch kannst du dich als Tablet anmelden.
            </p>
            <hr>
            <div class='row'>
                <div class='col-md-7'>
                    <div class="mb-3">
                        <label>Problem</label>
                        <input type="text" class="form-control" placeholder="z.B. Das Gerät gibt kein Bild aus, wenn ..." id='tp_problem_description' />
                    </div>
                </div>
                <div class='col-md-3'>
                    <div class="mb-3">
                        <label>Gerät</label>
                        <input type="text" class="form-control" placeholder="z.B. Computer 2 / C2 ..." id='tp_problem_device' />
                    </div>
                </div>
                <div class='col-md-2'>
                    <div class="mb-3">
                        <label>Datum</label>
                        <input type="date" class="form-control" id='tp_date' value='#{Date.today.to_s}' />
                    </div>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <div class="pull-right">
                        <button id='tp_report_problem_quiet' class='btn btn-outline-secondary' disabled><i class='bi bi-bell-slash '></i>&nbsp;&nbsp;Stumm Absenden (Für Testzwecke)</button>
                        <button id='tp_report_problem' class='btn btn-outline-secondary' disabled><i class='bi bi-send'></i>&nbsp;&nbsp;Absenden</button>
                    </div>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-12 techproblems-container' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th>Status</th>
                    </tr></thead>
                    <tbody id='problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button class='bu-fixed-problems btn btn-primary'><i class='bi bi-eye'></i>&nbsp;&nbsp;Ausgeblendete Probleme</button>
                    <button class='bu-tablets btn btn-warning'><i class='bi bi-tablet'></i>&nbsp;&nbsp;Tablets</button>
                    <button class='bu-safe btn btn-secondary'><i class='bi bi-wrench'></i>&nbsp;&nbsp;Super User</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeFixed" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Ausgeblendete Probleme</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12 techproblems-container' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th>Status</th>
                    </tr></thead>
                    <tbody id='fixed_problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeTablets" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Tablets</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    #{print_tablet_login()}
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeSuperUser" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Super User</h5>
          <button class='btn-pull-right btn-json-data btn btn-secondary'>JSON anzeigen</button>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    #{print_techpost_superuser()}
                    <br><h3>Super Funktionen</h3>
                    <div class='row' style='margin-bottom: 15px;'>
                        <div class='col-md-12'>
                            <button class='bu-clear-all btn btn-danger'><i class='bi bi-trash'></i>&nbsp;&nbsp;Alle Probleme löschen</button>
                            <button class='bu-kick-all btn btn-danger'><i class='bi bi-user-times'></i>&nbsp;&nbsp;Alle Technikamt-User entfernen</button>
                            <button class='bu-send-welcome-mail btn btn-warning'><i class='bi bi-envelope'></i>&nbsp;&nbsp;Willkommens-E-Mails versenden</button>
                            <button class='bu-clear-aula-lights btn btn-danger'><i class='bi bi-lightbulb-o'></i>&nbsp;&nbsp;Plan der Aula-Scheinwerfer zurücksetzen</button>
                        </div>
                    </div>
                    <div class='row' style='margin-bottom: 15px;'>
                        <div class='col-md-12'>
                            <div class='mb-3'>
                                <input id='ti_recipients' class='form-control' placeholder='User suchen…' />
                                <div class='recipient-input-dropdown' style='display: none;'></div>
                            </div>
                            <small class="form-text text-muted">Hinweis: Die Änderungen werden erst nach dem Neuladen der Seite sichtbar.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<script>
    let users_which_can_fix_tech_problems = `#{print_users_which_can_fix_tech_problems}`

    function compose_fixed_problems() {
        $('#composeFixed').modal('show');
        refresh_fixed_tech_problems();
    }

    function compose_tablets() {
        $('#composeTablets').modal('show');
    }

    function compose_SuperUser() {
        $('#composeSuperUser').modal('show');
    }

    function compose_clear_all() {
        showTemplateModal('Alle Probleme löschen',
            'Bist Du sicher? Dabei werden alle Probleme gelöscht.<br>Tu dies nur nach Absprache mit dem TechnikTeam und allen Usern die Zugriff auf diese Funktion haben.<br>Das TechnikTeam wird per E-Mail darüber informiert.',
            "<i class='bi bi-trash'></i>&nbsp;&nbsp;Ich bin mir sicher (Alles löschen)", 'btn-danger',
            'Abbrechen', 'btn-secondary', function() {
                api_call('/api/clear_all_tech_problems_admin', {}, function(data) {
                    if (data.success)
                        refresh_tech_problems();
                        refresh_fixed_tech_problems();
                });
            }
        );
    }

    function compose_clear_aula_lights() {
        showTemplateModal('Den Plan Aula-Scheinwerfer löschen',
            'Bist Du sicher? Dabei wird der gesamte Plan der Scheinwerfer in der Aula gelöscht. Dies ist notwendig, wenn Fehler im hochgeladenen HTML vorliegen, die die Seite vorübergehend unbenutzbar machen.<br>Tu dies nur nach Absprache mit dem TechnikTeam und allen Usern die Zugriff auf diese Funktion haben.',
            "<i class='bi bi-trash'></i>&nbsp;&nbsp;Ich bin mir sicher (Alles löschen)", 'btn-danger',
            'Abbrechen', 'btn-secondary', function() {
                api_call('/api/set_light_structure', {structure_input: ""}, function(data) {
                    if (data.success)
                        refresh_tech_problems();
                        refresh_fixed_tech_problems();
                });
            }
        );
    }

    function compose_kick_all() {
        showTemplateModal('Alle Technikamt-User entfernen',
            'Bist Du sicher? Dabei werden alle Technikamt-User entfernt.<br>Tu dies nur nach Absprache mit dem TechnikTeam und allen Usern die Zugriff auf diese Funktion haben.<br>Das TechnikTeam wird per E-Mail darüber informiert.',
            "<i class='bi bi-user-times'></i>&nbsp;&nbsp;Ich bin mir sicher (Alle entfernen)", 'btn-danger',
            'Abbrechen', 'btn-secondary', function() {
                api_call('/api/kick_all_techposts_admin', {}, function(data) {
                    if (data.success)
                        refresh_tech_problems();
                        refresh_fixed_tech_problems();
                });
            }
        );
    }

    function send_welcome_mail() {
        showTemplateModal('Willkommens-E-Mail versenden',
            'Bist Du sicher? Dabei erhalten alle Technikamt-Schüler diese E-Mail.<br>Das TechnikTeam wird per E-Mail darüber informiert und erhält eine Kopie.',
            "<i class='bi bi-send'></i>&nbsp;&nbsp;Ich bin mir sicher (E-Mails versenden)", 'btn-warning',
            'Abbrechen', 'btn-secondary', function() {
                api_call('/api/send_all_techpost_welcome_mail', {}, function(data) {
                    if (data.success)
                        refresh_tech_problems();
                        refresh_fixed_tech_problems();
                });
            }
        );
    }

    function update_submit_button() {
        if (can_send_problem())
            $('#tp_report_problem').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
        else
            $('#tp_report_problem').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);

        if (can_send_problem())
            $('#tp_report_problem_quiet').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        else
            $('#tp_report_problem_quiet').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
    }

    function can_send_problem() {
        let problem = $('#tp_problem_description').val().trim();
        let device = $('#tp_problem_device').val();
        return problem.length > 0 && device.length > 0 ;
    }

    function refresh_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                $('#problems_here').empty();
                /* $('#__template_modal .modal-body').empty(); */
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == false && entry.problem.not_fixed == false && entry.problem.hidden_admin == false) {
                        let row = $('<tr>');
                        let token = entry.problem.token;
                        let fixed = "<i class='text-success bi bi-check' title='Behoben'></i>";
                        let progress = "<i class='text-secondary bi bi-clock-o' title='In Bearbeitung'></i>";
                        let not_fixed = "<i class='text-danger bi bi-x' title='Nicht behoben'></i>";
                        let see_comment = "<i class='text-primary bi bi-commenting' title='Siehe Kommentar'></i>";
                        let current_state = "Unbekannt"
                        if (entry.problem.fixed == true) {
                            current_state = fixed
                        } else if (entry.problem.not_fixed == true) {
                            current_state = not_fixed
                        } else if (entry.problem.comment != "" && entry.problem.fixed == false && entry.problem.not_fixed == false) {
                            current_state = see_comment
                        } else {
                            current_state = progress
                        }
                        function get_modal() {
                            let klasse = entry.klasse ? ` (${entry.klasse})` : ""
                            let tp_print = "<button class='btn btn-primary tp-print'><i class='bi bi-print'></i></button>"
                            let tp_delete = "<button class='btn btn-danger tp-delete';><i class='bi bi-trash'></i>&nbsp;&nbsp;Löschen</button>"
                            let tp_hide_admin = "<button class='btn btn-info tp-hide-admin'><i class='bi bi-eye'></i>&nbsp;&nbsp;Ausblenden</button>"
                            let fixer = entry.fnc_login ? `<button title='${entry.fdisplay_name} kümmert sich um das Problem.' class='tp-fixer'><img src='#{NEXTCLOUD_URL}/index.php/avatar/${entry.fnc_login}/256' class='icon avatar-md'/></button>` : "<button class='btn btn-warning tp-fixer'><i class='bi bi-user-plus'></i>&nbsp;&nbsp;Nutzer zuweisen</button>";
                            let tp_fixed = "<button class='btn btn-success tp-fixed'><i class='bi bi-check'></i>&nbsp;&nbsp;Behoben</button>"
                            let tp_not_fixed = "<button class='btn btn-warning tp-not-fixed'><i class='bi bi-x'></i>&nbsp;&nbsp;Nicht Behoben</button>"
                            let mail_count = entry.problem.mail_count
                            let tp_mail = `<button class='btn btn-xs btn-success tp-mail'><i class='bi bi-envelope'></i>&nbsp;&nbsp;Update per Mail senden (${mail_count})</button>`
                            let tp_hide = "<button class='btn btn-xs btn-info tp-hide'><i class='bi bi-eye'></i>&nbsp;&nbsp;Für Absender ausblenden</button>"
                            if (entry.problem.hidden) {
                                tp_hide = "<button class='btn btn-xs btn-secondary tp-hide'><i class='bi bi-eye-slash'></i>&nbsp;&nbsp;Für Absender ausgeblendet</button>"
                            }

                            let tp_comment = "<button class='btn btn-xs btn-primary tp-comment'><i class='bi bi-plus'></i>&nbsp;&nbsp;Kommentar</button>"
                            let tp_update_comment = "<button class='btn btn-xs btn-primary tp-update-comment'><i class='bi bi-pencil'></i></button>"
                            let comment = tp_comment

                            if (entry.problem.comment) {
                                comment = `${entry.problem.comment} ${tp_update_comment}`;
                            }
                            $('#__template_modal .modal-footer').empty();
                            let modalContent = `<p>Problem: <b>${entry.problem.problem}</b><br>
                                Gerät: <b>${entry.problem.device}</b><br>
                                Datum: <b>${moment(entry.problem.date).format('dddd, D.M.Y')}</b><br>
                                Absender: <b>${entry.display_name}${klasse}</b> ${tp_hide} ${tp_mail}<br>
                                Status: <b>${current_state}</b><br>
                                Kommentar: <b>${comment}</b></p>
                                <div>
                                    ${tp_fixed}
                                    ${tp_not_fixed}
                                    ${tp_hide_admin}
                                    ${fixer}
                                    ${tp_delete}
                                </div>`;
                            $('#__template_modal .modal-title').html(entry.problem.problem);
                            $('#__template_modal .modal-body').html(modalContent);
                            $('#__template_modal .modal-footer').empty();
                            let bu_cancel = $('<button>').addClass('btn btn-secondary').html('Schließen').attr('data-dismiss', 'modal');
                            $('#__template_modal .modal-footer').append(tp_print).append(bu_cancel);
                            $('#__template_modal').modal('show');

                            $('.tp-fixed').click(function() {
                                api_call('/api/fix_tech_problem_admin', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_tech_problems();
                                        $('#__template_modal').modal('hide');
                                    }
                                });
                            });
                            $('.tp-not-fixed').click(function() {
                                api_call('/api/not_fix_tech_problem_admin', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_tech_problems();
                                        $('#__template_modal').modal('hide');
                                    }
                            });
                            });
                            $('.tp-mail').click(function() {
                                api_call('/api/mail_tech_problem', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_tech_problems();
                                        $('#__template_modal').modal('hide');
                                    }
                                });
                            });
                            $('.tp-hide').click(function() {
                                if (entry.problem.hidden) {
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            $('#__template_modal').modal('hide');
                                    });
                                } else {
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            $('#__template_modal').modal('hide');
                                    });
                                }
                            });
                            $('.tp-fixer').click(function() {
                                if (entry.fnc_login) {
                                    api_call('/api/i_will_not_fix_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            $('#__template_modal').modal('hide');

                                    });
                                } else {
                                    showTemplateModal('Person zum Beheben des Problems zuweisen',
                                    users_which_can_fix_tech_problems,
                                    '', '',
                                    'Schließen', 'btn-secondary'
                                    );
                                    
                                    $('.bu-select-user-to-fix-problem').click(function(e) {
                                        let email = $(this).data('email');
                                        console.log(email)
                                        api_call('/api/i_will_fix_tech_problem', {token: token, email: email}, function(data) {
                                            if (data.success)
                                                refresh_fixed_tech_problems();
                                                refresh_tech_problems
                                                $('#__template_modal').modal('hide');
                                        });
                                    })
                                }
                            });
                            $('.tp-hide-admin').click(function() {
                                if (entry.problem.comment != "") {
                                    api_call('/api/hide_tech_problem_admin', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            $('#__template_modal').modal('hide');
                                    });
                                } else {
                                    showTemplateModal('Ausblenden nicht möglich',
                                        'Bitte reagiere erst auf diese Meldung, indem du einen Kommentar schreibst und/oder das Problem als „behoben“ oder „nicht behoben“ markierst.',
                                        '',
                                        '',
                                        'Schließen', 'btn-secondary'
                                    );
                                }
                            })
                            $('.tp-print').click(function() {
                                window.open(`/api/get_tech_problem_pdf/${token}`, '_blank');
                            });
                            $('.tp-delete').click(function() {
                                showTemplateModal('Problem löschen',
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='bi bi-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            refresh_fixed_tech_problems();
                                            $('#__template_modal').modal('hide');
                                    });
                                })
                            });
                            $('.tp-comment').click(function() {
                                showTemplateModal('Kommentar hinzufügen',
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='bi bi-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                                );
                            })
                            $('.tp-update-comment').click(function() {
                                let old_comment = entry.problem.comment
                                showTemplateModal('Kommentar aktualisieren',
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                "<i class='bi bi-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                            })
                        };
                        row.click(function(e) {
                            get_modal();
                        })
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        if (entry.klasse) {
                            row.append($('<td title="Schüler">').text(entry.klasse));
                        } else {
                            row.append($('<td title="Lehrer">').html('<i class="bi bi-users"></i>'));
                        }
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').html(current_state));
                        $('#problems_here').append(row);
                    }
                }
            }
        });
    };


    function refresh_fixed_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                refresh_tech_problems();
                $('#fixed_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == true  || entry.problem.not_fixed == true || entry.problem.hidden_admin == true) {
                        let row = $('<tr>');
                        let token = entry.problem.token;
                        let fixed = "<i class='text-success bi bi-check' title='Behoben'></i>";
                        let progress = "<i class='text-secondary bi bi-clock-o' title='In Bearbeitung'></i>";
                        let not_fixed = "<i class='text-danger bi bi-x' title='Nicht behoben'></i>";
                        let see_comment = "<i class='text-primary bi bi-commenting' title='Siehe Kommentar'></i>";
                        let current_state = "Unbekannt"
                        if (entry.problem.fixed == true) {
                            current_state = fixed
                        } else if (entry.problem.not_fixed == true) {
                            current_state = not_fixed
                        } else if (entry.problem.comment != "" && entry.problem.fixed == false && entry.problem.not_fixed == false) {
                            current_state = see_comment
                        } else {
                            current_state = progress
                        }
                        function get_modal() {
                            let klasse = entry.klasse ? ` (${entry.klasse})` : ""
                            let tp_print = "<button class='btn btn-primary tp-print';><i class='bi bi-print'></i></button>"
                            let tp_delete = "<button class='btn btn-danger tp-delete';><i class='bi bi-trash'></i>&nbsp;&nbsp;Löschen</button>"
                            let tp_unhide_admin = "<button class='btn btn-secondary tp-unhide-admin'><i class='bi bi-eye'></i>&nbsp;&nbsp;Einblenden</button>"
                            let fixer = entry.fnc_login ? `<button title='${entry.fdisplay_name} kümmert sich um das Problem.' class='tp-fixer'><img src='#{NEXTCLOUD_URL}/index.php/avatar/${entry.fnc_login}/256' class='icon avatar-md'/></button>` : "<button class='btn btn-warning tp-fixer'><i class='bi bi-user-plus'></i>&nbsp;&nbsp;Nutzer zuweisen</button>";
                            let tp_fixed = "<button class='btn btn-success tp-fixed'><i class='bi bi-check'></i>&nbsp;&nbsp;Behoben</button>"
                            let tp_not_fixed = "<button class='btn btn-warning tp-not-fixed'><i class='bi bi-x'></i>&nbsp;&nbsp;Nicht Behoben</button>"
                            let mail_count = entry.problem.mail_count
                            let tp_mail = `<button class='btn btn-xs btn-success tp-mail'><i class='bi bi-envelope'></i>&nbsp;&nbsp;Update per Mail senden (${mail_count})</button>`
                            let tp_hide = "<button class='btn btn-xs btn-info tp-hide'><i class='bi bi-eye'></i>&nbsp;&nbsp;Für Absender ausblenden</button>"
                            if (entry.problem.hidden) {
                                tp_hide = "<button class='btn btn-xs btn-secondary tp-hide'><i class='bi bi-eye-slash'></i>&nbsp;&nbsp;Für Absender ausgeblendet</button>"
                            }

                            let tp_comment = "<button class='btn btn-xs btn-primary tp-comment'><i class='bi bi-plus'></i>&nbsp;&nbsp;Kommentar</button>"
                            let tp_update_comment = "<button class='btn btn-xs btn-primary tp-update-comment'><i class='bi bi-pencil'></i></button>"
                            let comment = tp_comment

                            if (entry.problem.comment) {
                                comment = `${entry.problem.comment} ${tp_update_comment}`;
                            }
                            $('#__template_modal .modal-footer').empty();
                            let modalContent = `<p>Problem: <b>${entry.problem.problem}</b><br>
                                Gerät: <b>${entry.problem.device}</b><br>
                                Datum: <b>${moment(entry.problem.date).format('dddd, D.M.Y')}</b><br>
                                Absender: <b>${entry.display_name}${klasse}</b> ${tp_hide} ${tp_mail}<br>
                                Status: <b>${current_state}</b><br>
                                Kommentar: <b>${comment}</b></p>
                                <div>
                                    ${tp_fixed}
                                    ${tp_not_fixed}
                                    ${tp_unhide_admin}
                                    ${fixer}
                                    ${tp_delete}
                                </div>`;
                            $('#__template_modal .modal-title').html(entry.problem.problem);
                            $('#__template_modal .modal-body').html(modalContent);
                            $('#__template_modal .modal-footer').empty();
                            let bu_cancel = $('<button>').addClass('btn btn-secondary').html('Schließen').attr('data-dismiss', 'modal');
                            $('#__template_modal .modal-footer').append(tp_print).append(bu_cancel);
                            $('#__template_modal').modal('show');

                            $('.tp-fixed').click(function() {
                                api_call('/api/fix_tech_problem_admin', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_fixed_tech_problems();
                                        refresh_tech_problems
                                        $('#__template_modal').modal('hide');
                                    }
                                });
                            });
                            $('.tp-not-fixed').click(function() {
                                api_call('/api/not_fix_tech_problem_admin', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_fixed_tech_problems();
                                        refresh_tech_problems
                                        $('#__template_modal').modal('hide');
                                    }
                            });
                            });
                            $('.tp-mail').click(function() {
                                api_call('/api/mail_tech_problem', {token: entry.problem.token}, function(data) {
                                    if (data.success) {
                                        refresh_fixed_tech_problems();
                                        refresh_tech_problems
                                        $('#__template_modal').modal('hide');
                                    }
                                });
                            });
                            $('.tp-hide').click(function() {
                                if (entry.problem.hidden) {
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems
                                            $('#__template_modal').modal('hide');
                                    });
                                } else {
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems
                                            $('#__template_modal').modal('hide');
                                    });
                                }
                            });
                            $('.tp-fixer').click(function() {
                                if (entry.fnc_login) {
                                    api_call('/api/i_will_not_fix_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems
                                            $('#__template_modal').modal('hide');

                                    });
                                } else {
                                    showTemplateModal('Person zum Beheben des Problems zuweisen',
                                    users_which_can_fix_tech_problems,
                                    '', '',
                                    'Schließen', 'btn-secondary'
                                    );
                                    
                                    $('.bu-select-user-to-fix-problem').click(function(e) {
                                        let email = $(this).data('email');
                                        console.log(email)
                                        api_call('/api/i_will_fix_tech_problem', {token: token, email: email}, function(data) {
                                            if (data.success)
                                                refresh_fixed_tech_problems();
                                                refresh_tech_problems
                                                $('#__template_modal').modal('hide');
                                        });
                                    })
                                }
                            });
                            $('.tp-unhide-admin').click(function() {
                                api_call('/api/unhide_tech_problem_admin', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_fixed_tech_problems();
                                        refresh_tech_problems
                                        $('#__template_modal').modal('hide');
                                });
                            })
                            $('.tp-print').click(function() {
                                window.open(`/api/get_tech_problem_pdf/${token}`, '_blank');
                            });
                            $('.tp-delete').click(function() {
                                showTemplateModal('Problem löschen',
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='bi bi-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems();
                                            $('#__template_modal').modal('hide');
                                    });
                                })
                            });
                            $('.tp-comment').click(function() {
                                showTemplateModal('Kommentar hinzufügen',
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='bi bi-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems
                                    });
                                }
                                );
                            })
                            $('.tp-update-comment').click(function() {
                                let old_comment = entry.problem.comment
                                showTemplateModal('Kommentar aktualisieren',
                                    '<div class="alert alert-warning">Falls das Problem nicht als „behoben“ oder „nicht behoben“ markiert ist, kannst du den Kommentar erst, nachdem du das Problem für das TechnikTeam wieder eingeblendet hast löschen.</div><textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                    "<i class='bi bi-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                    'Abbrechen', 'btn-secondary', function() {
                                        let comment = $('#tp_comment_input').val();
                                        if (comment != "" || entry.problem.fixed || entry.problem.not_fixed) {
                                            api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                                if (data.success)
                                                    refresh_fixed_tech_problems();
                                            });
                                        }
                                    }
                                );
                            })
                        };
                        row.click(function(e) {
                            get_modal();
                        })
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        if (entry.klasse) {
                            row.append($('<td title="Schüler">').text(entry.klasse));
                        } else {
                            row.append($('<td title="Lehrer">').html('<i class="bi bi-users"></i>'));
                        }
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').html(current_state));
                        $('#fixed_problems_here').append(row);
                    }
                }
            }
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    update_submit_button();
    $('#tp_problem_description').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_descriptione').change(function(e) { update_submit_button(); });
    $('#tp_date').change(function(e) { update_submit_button(); });
    $('#tp_problem_device').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_device').change(function(e) { update_submit_button(); });
    $('#tp_report_problem').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            $('#tp_problem_device').val("");
            update_submit_button();
            refresh_tech_problems();
        });
    });
    $('#tp_report_problem_quiet').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem_quiet', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            $('#tp_problem_device').val("");
            update_submit_button();
            refresh_tech_problems();
        });
    });
    refresh_tech_problems();
    $('.bu-fixed-problems').click(function(e) {
        compose_fixed_problems();
    });

    $('.bu-tablets').click(function(e) {
        compose_tablets();
    });

    $('.bu-safe').click(function(e) {
        compose_SuperUser();
    });

    $('.bu-clear-all').click(function(e) {
        compose_clear_all();
    });
    $('.bu-clear-aula-lights').click(function(e) {
        compose_clear_aula_lights();
    });
    $('.bu-kick-all').click(function(e) {
        compose_kick_all();
    })

    $('.bu-send-welcome-mail').click(function(e) {
        send_welcome_mail();
    });

    $('.btn-purge-session').click(function (e) {
        let scrambled_sid = $(e.target).data('scrambled-sid');
        let email = $(e.target).data('email');
        api_call('/api/purge_session_for_user', { email: email, scrambled_sid: scrambled_sid }, function (data) {
            if (data.success) {
                $(e.target).closest('tr').remove();
            }
        });
    });
    $('.bu_login_teacher_tablet').click(function (e) {
        api_call('/api/login_as_teacher_tablet', {}, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.bu_login_kurs_tablet').click(function (e) {
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        let shorthands = [];
        for (let button of selected_buttons) {
            shorthands.push($(button).data('shorthand'));
        }
        api_call('/api/login_as_kurs_tablet', { shorthands: shorthands }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.btn-teacher-for-kurs-tablet-login').click(function (e) {
        let button = $(e.target);
        button.toggleClass('selected');
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        $('.bu_login_kurs_tablet').attr('disabled', selected_buttons.length === 0);
    });
    $('.btn-tablet-login').click(function (e) {
        api_call('/api/login_as_tablet', { id: `${$(e.target).data('id')}` }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });

    $('.bu-edit-techpost').click(function (e) {
            let email = $(e.target).data('email');
            api_call('/api/delete_techpost', { email: email}, function (data) {
                if (data.success) {
                    $(e.target).closest('tr').remove();
                }
            });
    });

    $('.bu-send-single-welcome-mail').click(function (e) {
            let email = $(e.target).data('email');
            api_call('/api/send_single_techpost_welcome_mail', { email: email}, function (data) {
                window.location.reload;
            });
    });

    $('.btn-json-data').click(function (e) {
        let json_data = $('.json-data');
        if (json_data.is(':visible'))
            json_data.hide();
        else
            json_data.show();
    });

    })
</script>

<script>
    var recipients = {};
    var recipients_cache = {};
    var autocomplete_results = {};
    var klasse_for_sus = #{ klasse_for_sus().to_json};
    var old_end_date = null;
    var old_mode = null;
    var observer = null;
    var sent_messages = #{ sent_messages.to_json };
    var antikenfahrt_recipients = #{@@antikenfahrt_recipients.to_json };
    var message_cache = {};
    var force_close = false;
    var current_salzh_entries = #{ get_current_salzh_sus.to_json };
    var voluntary_testing_entries = #{ get_voluntary_testing_sus.to_json };
    var klassen_tr = #{ KLASSEN_TR.to_json };

    function send_message(email) {
        api_call('/api/add_techpost', { email: email.trim() }, function (data) {});
    }

    function delete_message() {
        let email = $('#ti_email').data('email');
        api_call('/api/delete_techpost', { email: email}, function (data) {
        });
    }

    function gen_recipient_span(key, with_rm) {
        if (!(key in recipients))
            recipients[key] = { label: key };
        let label = recipients[key].label;
        if (recipients[key].entries)
            label += ' (' + recipients[key].entries.length + ')';
        if (key in klasse_for_sus)
            label += ` (${klasse_for_sus[key]})`;
        let recipient = $('<span>').addClass('recipient').html(label);
        if (recipients[key].teacher)
            recipient.addClass('teacher');
        recipient.data('key', key);
        return recipient;
    }

    function add_recipient(key) {
        $('#ti_email').val(gen_recipient_span(key, true).text());
        $('#ti_email').data('email', key);
        $('.recipients_list').empty().append(gen_recipient_span(key, true));
        $('.recipient-input-dropdown').hide();
        $('#ti_recipients').val('');
        $('#ti_recipients').focus();
        send_message(key);
    }

    function observer_callback(entries, observer) {
        for (let entry of entries) {
            if (entry.intersectionRatio === 0)
                continue;
            observer.unobserve(entry.target);
            let entry_data = $(entry.target).data();
            if (entry_data.mid) {
                (function (entry_data) {
                    let request = new XMLHttpRequest();
                    let uri = '/gen/m/' + entry_data.mid.substr(0, 2) + '/' + entry_data.mid.substr(2, entry_data.mid.length - 2) + '.html.gz';
                    request.open('GET', uri, true);
                    request.responseType = 'arraybuffer';

                    request.onload = function (e) {
                        if (e.target.status === 200) {
                            let data = pako.ungzip(request.response);
                            let bb = new Blob([new Uint8Array(data)]);
                            let f = new FileReader();
                            f.onload = function (e) {
                                let contents = e.target.result;
                                message_cache[entry_data.mid] = contents;
                                if (entry_data.strip)
                                    $(entry_data.msg_div).html($(contents).text());
                                else
                                    $(entry_data.msg_div).html(contents);
                            };
                            f.readAsText(bb);
                        }
                    };
                    request.send();
                })(entry_data);
            }
        }
    }

    function compact_address_list(emails) {
        let result = [];
        for (let key of recipients_cache.groups) {
            let all_in = true;
            for (let email of recipients[key].entries) {
                if (emails.indexOf(email) < 0) {
                    all_in = false;
                    break;
                }
            }
            if (all_in) {
                result.push(key);
                let new_emails = [];
                for (let email of emails)
                    if (recipients[key].entries.indexOf(email) < 0)
                        new_emails.push(email);
                emails = new_emails;
            }
        }
        for (let email of emails)
            result.push(email);
        return result;
    }

    document.addEventListener('DOMContentLoaded', function () {
        observer = new IntersectionObserver(observer_callback, {
            rootMargin: '100px',
            threshold: 1.0
        });

        $('#bu_delete_message').click(function (e) {
            delete_message();
        });

        $('#ti_recipients').keydown(function (e) {
            if ((e.keyCode === 9 || e.keyCode === 13) && ($(e.target).val().length > 0)) {
                if (Object.keys(autocomplete_results).length === 1) {
                    let key = recipients_cache.keys[Object.keys(autocomplete_results)[0]];
                    add_recipient(key);
                }
                e.preventDefault();
                e.stopPropagation();
                return;
            }
        });

        $('#ti_recipients').keyup(function (e) {
            if ($('#ti_recipients')[0].selectionStart == $(e.target).val().length) {
                let value = $(e.target).val();
                let backspace_pressed = (e.keyCode === 8);
                let space_at_end = value[value.length - 1] == ' ';
                let search_terms = value.trim().toLowerCase().split(/\s+/);
                let results = {};
                for (let i = 0; i < search_terms.length; i++) {
                    let term = search_terms[i];
                    let term_results = {};
                    for (let key of Object.keys(recipients_cache.index[term] || {})) {
                        term_results[key] = recipients_cache.index[term][key];
                    }
                    if (i == 0)
                        results = term_results;
                    else {
                        for (let k of Object.keys(results)) {
                            if (k in term_results) {
                                if (term_results[k] > results[k])
                                    results[k] = term_results[k];
                            } else {
                                delete results[k];
                            }
                        }
                    }
                }
                autocomplete_results = results;
                result_keys = Object.keys(results).map(function (x) { return parseInt(x); });
                if (result_keys.length === 0) $('.recipient-input-dropdown').hide();
                else {
                    if (result_keys.length === 1) {
                        if (!backspace_pressed) {
                            let key = recipients_cache.keys[result_keys[0]];
                            let label = recipients[key].label;
                            $('#ti_recipients').val(label);
                            $('#ti_recipients')[0].setSelectionRange(results[result_keys[0]] + (space_at_end ? 1 : 0), label.length);
                        }
                    }
                    result_keys.sort(function (a, b) {
                        let va = recipients[recipients_cache.keys[a]];
                        let vb = recipients[recipients_cache.keys[b]];
                        if (va.teacher === vb.teacher) {
                            if (va.label < vb.label)
                                return -1;
                            return 1;
                        } else {
                            if (va.teacher)
                                return -1;
                            return 1;
                        }
                    });
                    $('.recipient-input-dropdown').empty();
                    for (let key of result_keys) {
                        let k = recipients_cache.keys[key];
                        let r = gen_recipient_span(k);
                        r.click(function (e) {
                            add_recipient($(e.target).data('key'));
                        });
                        $('.recipient-input-dropdown').append(r);
                    }
                    $('.recipient-input-dropdown').show();
                }
            }
        });

        if ('#{user_with_role_logged_in?(:can_write_messages)}' === 'true') {
            load_recipients('#{@session_user[:id]}', function () {
                // console.log(recipients);
            }, null);
        }
    });
</script>
