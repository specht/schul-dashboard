#{this_is_a_page_for_user_with_role(:can_report_tech_problems)}
<div class='container'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style="margin-bottom: 30px;">Technikamt
                <button id="frequent_problems" class='btn btn-info pull-right'><i class='bi bi-question-circle'></i>&nbsp;&nbsp;Häufige Fragen und Probleme</button>
            </h2>
            <hr>
                Du bist in deiner Klasse Technikamt und kannst deshalb hier Probleme mit der Schultechnik melden.<br><br>
                <div class="alert alert-warning">
                    Du kannst gerne ein paar Probe-Meldungen abschicken. Bei Fragen oder Problemen, wende dich gerne an Peter-J. Germelmann.<br><br><a class="btn btn-dark" href="mailto:peter-julius.germelmann@mail.gymnasiumsteglitz.de"><i class='bi bi-envelope'></i>&nbsp;&nbsp;E-Mail</a>
                </div>
            <hr>
            <div class='row'>
                <div class='col-md-7'>
                    <div class="mb-3">
                        <label>Problem</label>
                        <input type="text" class="form-control" placeholder="z.B. Das Gerät gibt kein Bild aus, wenn ..." id='tp_problem_description' />
                    </div>
                </div>
                <div class='col-md-3'>
                    <div class="mb-3">
                        <label>Gerät</label>
                        <!-- <div class="btn-group" style='width: 100%;'>
                            <button type="button" class="-dropdown btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Gerät wählen
                            </button>
                            <div class="dropdown-menu">
                                <a class='dropdown-item btn' data-device='C2'>Computer 2 (C2)</a>
                                <a class='dropdown-item btn' data-device='C5'>Computer 5 (C5)</a>
                                <a class='dropdown-item btn' data-device='B1'>Beamer 1 (B1)</a>
                                <a class='dropdown-item btn' data-device='B2'>Beamer 2 (B2)</a>
                                <a class='dropdown-item btn' data-device='B3'>Beamer 3 (B3)</a>
                                <a class='dropdown-item btn' data-device='B4'>Beamer 4 (B4)</a>
                                <a class='dropdown-item btn' data-device='B1'>Beamer 5 (B5)</a>
                                <a class='dropdown-item btn' data-device='MB1'>Multi-Beamer 1</a>
                                <a class='dropdown-item btn' data-device='MB2'>Multi-Beamer 2</a>
                                <a class='dropdown-item btn' data-device='MB3'>Multi-Beamer 3</a>
                                <a class='dropdown-item btn' data-device='MB4'>Multi-Beamer 4</a>
                                <a class='dropdown-item btn' data-device='MB5'>Multi-Beamer 5</a>
                                <a class='dropdown-item btn' data-device='MB6'>Multi-Beamer 6</a>
                                <a class='dropdown-item btn' data-device='D1'>DVD-Player 1 (D1)</a>
                                <a class='dropdown-item btn' data-device='D2'>DVD-Player 2 (D2)</a>
                                <a class='dropdown-item btn' data-device='D3'>DVD-Player 3 (D3)</a>
                                <a class='dropdown-item btn' data-device='D4'>DVD-Player 4 (D4)</a>


                                <a class='dropdown-item btn' data-device='C'>Computer</a>
                                <a class='dropdown-item btn' data-device='B'>Beamer</a>
                                <a class='dropdown-item btn' data-device='MB'>Multi-Beamer</a>
                                <a class='dropdown-item btn' data-device='D'>DVD-Player</a>
                            </div>
                        </div> -->

                        <input type="text" class="form-control" placeholder="z.B. Computer 2 / C2 ..." id='tp_problem_device' />

                        <!-- <div class="btn-group" style="width: 100%;">
                            <button id="bu-device-select" type="button" class="select-problem-device btn btn-outline-info">
                                Gerät wählen
                            </button>
                        </div> -->
                    </div>
                </div>
                <div class='col-md-2'>
                    <div class="mb-3">
                        <label>Datum</label>
                        <input type="date" class="form-control" id='tp_date' value='#{Date.today.to_s}' />
                    </div>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button class='bu-hidden-problems btn btn-secondary'><i class='bi bi-eye-slash'></i>&nbsp;&nbsp;Ausgeblendete Probleme</button>
                    <div class="pull-right">
                        <!-- <button id='tp_report_problem_quiet' class='btn btn-outline-secondary' disabled><i class='bi bi-bell-slash '></i>&nbsp;&nbsp;Stumm Absenden (Für Testzwecke)</button> -->
                        <button id='tp_report_problem' class='btn btn-outline-secondary' disabled><i class='bi bi-send'></i>&nbsp;&nbsp;Absenden</button>
                    </div>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead id='head_problems_here'></thead>
                    <tbody id='problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="composeDeviceSelect" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Gerät wählen</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    Bitte wähle nun das Gerät, bei dem ein Problem vorliegt!
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Häufige Fragen und Probleme</h5>
            </div>
            <div class="modal-body">
                <div class='row'>
                    <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                        <h3>Ein Programm ist eingefroren oder lässt sich nicht mehr schließen</h3>
                        Da hilft meistens die Tastenkombination <code>Alt</code> + <code>F4</code> diese schließt das Programm ganz normal.
                        <br><b>Für IT-Experten:</b> Man kann auch die Tastenkombination <code>Strg</code> + <code>Shift (⇑)</code> + <code>Esc</code> nutzen. Dann öffnet sich der Task Manager, über den das Prgramm dann zwangsweise geschlossen werden kann.
                        <h3>Wenn nichts mehr geht</h3>
                        Ziehe den Stecker und halte den Power-Button so lange gedrückt, bis der Laptop aus ist. Warte einen Augenblick und Drücke den Button nun kurz, sodass das Gerät wieder startet. Sollte das Problem weiterhin bestehen, hilft nichts außer Warten... 
                        <br><b>Achtung:</b> Falls der Computer gerade ein Update macht, kann dieses Verfahren das Betriebssystem zerstören.
                        <div class="text-muted"><br>
                            Hier werden noch Sachen erganzt. <br>
                            Vorschläge? Meldet euch gerne bei uns, wenn ihr meint, dass hier noch etwas fehlt.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeHidden" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Ausgeblendete Probleme</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead id="head_hidden_problems_here">
                    <!-- <tr>
                    <th>Datum</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Status</th>
                    <th>Kommentar</th>
                    <th>Einblenden</th>
                    </tr> -->
                    </thead>
                    <tbody id='hidden_problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<script>

    function compose_device_select() {
        $('#composeDeviceSelect').modal('show');
    }

    function compose_frequent_problems() {
        $('#composeModal').modal('show');
    }

    function compose_hidden_problems() {
        $('#composeHidden').modal('show');
        refresh_hidden_tech_problems();
    }

    function update_submit_button() {
        if (can_send_problem())
            $('#tp_report_problem').removeClass('btn-outline-secondary').addClass('btn-success').prop('disabled', false);
        else
            $('#tp_report_problem').removeClass('btn-success').addClass('btn-outline-secondary').prop('disabled', true);

        if (can_send_problem())
            $('#tp_report_problem_quiet').removeClass('btn-outline-secondary').addClass('btn-secondary').prop('disabled', false);
        else
            $('#tp_report_problem_quiet').removeClass('btn-secondary').addClass('btn-outline-secondary').prop('disabled', true);
    }

    function can_send_problem() {
        let problem = $('#tp_problem_description').val().trim();
        let device = $('#tp_problem_device').val();
        return problem.length > 0 && device.length > 0 ;
    }

    function refresh_tech_problems() {
        api_call('/api/get_tech_problems', {}, function(data) {
            if (data.success) {
                $('#problems_here').empty();
                $('#head_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.hidden == false) {
                        let row = $('<tr>');
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        let tp_fixed = $('<td>').html("<i class='text-success bi bi-check' title='Behoben'></i>");
                        let tp_progress = $('<td>').html("<i class='text-secondary bi bi-clock-o' title='In Bearbeitung'></i>");
                        let tp_not_fixed = $('<td>').html("<i class='text-danger bi bi-x' title='Nicht behoben'></i>");
                        let tp_see_comment = $('<td>').html("<i class='text-primary bi bi-commenting' title='Siehe Kommentar'></i>");

                        if (entry.problem.fixed == true) {
                            row.append(tp_fixed);
                        } else if (entry.problem.not_fixed == true) {
                            row.append(tp_not_fixed);
                        } else if (entry.problem.comment != "" && entry.problem.fixed == false && entry.problem.not_fixed == false) {
                            row.append(tp_see_comment)
                        } else {
                            row.append(tp_progress);
                        }

                        if (entry.problem.comment == false) {
                            row.append($('<td>').html("<i class='text-muted'>Das TechnikTeam hat (noch) keinen Kommentar hinterlassen.</i>"));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment));
                        }

                        let tp_hide = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-secondary').html("<i class='bi bi-eye-slash'></i>&nbsp;&nbsp;Ausblenden");
                            
                        tp_hide.data('token', entry.problem.token);
                        tp_hide.click(function(e) {
                            api_call('/api/hide_tech_problem', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                    refresh_hidden_tech_problems();
                            });
                        });
                        row.append($('<td>').append(tp_hide))

                        $('#problems_here').append(row);
                    }
                }

                if ($('#problems_here').html()) {
                        let head_row = $('<tr>')
                        head_row.append($('<th>').text('Datum'))
                        head_row.append($('<th>').text('Problem'))
                        head_row.append($('<th>').text('Gerät'))
                        head_row.append($('<th>').text('Status'))
                        head_row.append($('<th>').text('Kommentar'))
                        head_row.append($('<th>').text('Ausblenden'))
                        $('#head_problems_here').append(head_row);
                    } else {
                        $('#head_problems_here').empty();
                    }
            }
        });
    }

    function refresh_hidden_tech_problems() {
        api_call('/api/get_tech_problems', {}, function(data) {
            if (data.success) {
                $('#hidden_problems_here').empty();
                $('#head_hidden_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.hidden == true) {
                        let row = $('<tr>');
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        let tp_fixed = $('<td>').html("<i class='text-success bi bi-check' title='Behoben'></i>");
                        let tp_progress = $('<td>').html("<i class='text-secondary bi bi-clock-o' title='In Bearbeitung'></i>");
                        let tp_not_fixed = $('<td>').html("<i class='text-danger bi bi-x' title='Nicht behoben'></i>");
                        let tp_see_comment = $('<td>').html("<i class='text-primary bi bi-commenting' title='Siehe Kommentar'></i>");

                        if (entry.problem.fixed == true) {
                            row.append(tp_fixed);
                        } else if (entry.problem.not_fixed == true) {
                            row.append(tp_not_fixed);
                        } else if (entry.problem.comment != "" && entry.problem.fixed == false && entry.problem.not_fixed == false) {
                            row.append(tp_see_comment)
                        } else {
                            row.append(tp_progress);
                        }

                        if (entry.problem.comment == false) {
                            row.append($('<td>').html("<i class='text-muted'>Das TechnikTeam hat (noch) keinen Kommentar hinterlassen.</i>"));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment));
                        }

                        let tp_hide = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-success').html("<i class='bi bi-eye'></i>&nbsp;&nbsp;Einblenden");
                            
                        tp_hide.data('token', entry.problem.token);
                        tp_hide.click(function(e) {
                            api_call('/api/unhide_tech_problem', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                    refresh_hidden_tech_problems();
                            });
                        });
                        row.append($('<td>').append(tp_hide))

                        $('#hidden_problems_here').append(row);
                        let at_least_one_row = true;
                    }
                }
                if ($('#hidden_problems_here').html()) {
                    let head_row = $('<tr>')
                    head_row.append($('<th>').text('Datum'))
                    head_row.append($('<th>').text('Problem'))
                    head_row.append($('<th>').text('Gerät'))
                    head_row.append($('<th>').text('Status'))
                    head_row.append($('<th>').text('Kommentar'))
                    head_row.append($('<th>').text('Einblenden'))
                    $('#head_hidden_problems_here').append(head_row);
                } else {
                    $('#head_hidden_problems_here').empty();
                    $('#head_hidden_problems_here').html("<i><div class='text-muted'>Keine ausgeblendeten Probleme gefunden!</div></i>");
                }
            }
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    update_submit_button();
    $('#tp_problem_description').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_description').change(function(e) { update_submit_button(); });
    $('#tp_date').change(function(e) { update_submit_button(); });
    $('#tp_problem_device').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_device').change(function(e) { update_submit_button(); });
    $('#tp_report_problem').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            $('#tp_problem_device').val("");
            update_submit_button();
            refresh_tech_problems();
        });
    });
    // $('#tp_report_problem_quiet').click(function(e) {
    //     let problem = $('#tp_problem_description').val().trim();
    //     let date = $('#tp_date').val().trim();
    //     let device = $('#tp_problem_device').val();
    //     api_call('/api/report_tech_problem_quiet', {problem: problem, date: date, device: device}, function(data) {
    //         console.log(data);
    //         $('#tp_problem_device').val("");
    //         update_submit_button();
    //         refresh_tech_problems();
    //     });
    // });
    refresh_tech_problems();

    $('#bu-device-select').click(function(e) {
        compose_device_select();
    });

    $('#frequent_problems').click(function(e) {
        compose_frequent_problems();
    });

    $('.bu-hidden-problems').click(function(e) {
        compose_hidden_problems();
    });

    })
</script>
